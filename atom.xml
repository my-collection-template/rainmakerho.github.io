<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>亂馬客 - Re:從零開始的軟體開發生活</title>
  <icon>https://www.gravatar.com/avatar/cd3aed042ccd7a5a5d9956b0bc07dc81</icon>
  <subtitle>Re:從零開始的軟體開發生活</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://rainmakerho.github.io/"/>
  <updated>2019-09-17T06:13:30.242Z</updated>
  <id>https://rainmakerho.github.io/</id>
  
  <author>
    <name>亂馬客</name>
    <email>rainmaker_ho@gss.com.tw</email>
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>為什麼 aspnet_client 目錄中的檔案都無法下載，Status 為 401</title>
    <link href="https://rainmakerho.github.io/2019/09/17/2019026/"/>
    <id>https://rainmakerho.github.io/2019/09/17/2019026/</id>
    <published>2019-09-17T05:52:25.000Z</published>
    <updated>2019-09-17T06:13:30.242Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>最近同事詢問，系統 Link 到 aspnet_client 中的 js 檔案時，都無法下載，出現 401 Unauthorized 。<br>同事確認「匿名驗證」也有啟用，怎麼還會噴 401 呢?</p><h3 id="研究"><a href="#研究" class="headerlink" title="研究"></a>研究</h3><p>連到本機直接瀏覽那個檔案，錯誤內容為「401.3 - Unauthorized」，詳細資料為「因為網頁伺服器上此資源的存取控制清單 (ACL) 設定或加密設定的緣故，您沒有檢視此目錄或網頁的權限。」。</p><p>看來應該跟目錄的安全性有關係，於是再看一下它的根目錄所在路徑，發現它並不是預設的位置(c:\interpub\wwwroot)。<br>所以我先將 IIS 根目錄改回預設的 c:\interpub\wwwroot ，然後再用 Browser 瀏覽 aspnet_client 中的隨便一個 js ，它是會下載的。<br>於是跟預設的跟目錄安全性比對一下發現，目前的這個根目錄下的 aspnet_client 目錄，少了 Everyone 這個使用者。<br>於是在一樣的目錄安全性中加入 Everyone ，並授與 Read 的權限，再試看看就可以了哦!</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;最近同事詢問，系統 Link 到 aspnet_client 中的 js 檔案時，都無法下載，出現 401 Unauthorized 。&lt;b
      
    
    </summary>
    
    
      <category term="iis" scheme="https://rainmakerho.github.io/tags/iis/"/>
    
      <category term="aspnet_client" scheme="https://rainmakerho.github.io/tags/aspnet-client/"/>
    
      <category term="Unauthorized" scheme="https://rainmakerho.github.io/tags/Unauthorized/"/>
    
  </entry>
  
  <entry>
    <title>.NET Core AD 帳密驗證</title>
    <link href="https://rainmakerho.github.io/2019/09/17/2019025/"/>
    <id>https://rainmakerho.github.io/2019/09/17/2019025/</id>
    <published>2019-09-17T03:17:17.000Z</published>
    <updated>2019-09-17T03:55:25.834Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>目前 .NET Core 的 System.DirectoryServices.Protocols 還不 Support 非 Windows 平台。<br>所以如果在 Mac 中使用的話，就會噴「System.PlatformNotSupportedException」這個錯誤，如下，</p><p>System.PlatformNotSupportedException: System.DirectoryServices.Protocols is not supported on this platform.<br>at System.DirectoryServices.Protocols.DirectoryIdentifier..ctor()<br>at System.DirectoryServices.Protocols.LdapDirectoryIdentifier..ctor(String server, Int32 portNumber)</p><h3 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h3><h4 id="改用-Novell-Directory-Ldap-NETStandard"><a href="#改用-Novell-Directory-Ldap-NETStandard" class="headerlink" title="改用 Novell.Directory.Ldap.NETStandard"></a>改用 Novell.Directory.Ldap.NETStandard</h4><p>所以如果要真的跨平台的話，可以使用 <a href="https://github.com/dsbenghe/Novell.Directory.Ldap.NETStandard" target="_blank" rel="noopener">Novell.Directory.Ldap.NETStandard</a> 從 Nuget 加入套件。<br>使用上也很方便，可以參考 <a href="https://nicolas.guelpa.me/blog/2017/02/15/dotnet-core-ldap-authentication.html" target="_blank" rel="noopener">.NET Core LDAP authentication</a> 這篇的說明來實作即可。</p><p>而目前我的需求只有簡單的給使用者及密碼來驗證是否正確，如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//using Novell.Directory.Ldap;</span></span><br><span class="line"><span class="comment">//ldapServer，不知道的話，可以先用 Active Directory Explorer 來查看</span></span><br><span class="line"><span class="keyword">var</span> ldapServer = <span class="string">@"yourldapserver.com.tw"</span>;</span><br><span class="line"><span class="comment"><span class="doctag">///</span>/LDAP SSL (TCP 636) and LDAP GC SSL (TCP 3269)</span></span><br><span class="line"><span class="keyword">var</span> ldapConn = <span class="keyword">new</span> LdapConnection() &#123; SecureSocketLayer = <span class="literal">true</span> &#125;;</span><br><span class="line"><span class="keyword">try</span></span><br><span class="line">&#123;</span><br><span class="line">    ldapConn.Connect(ldapServer, LdapConnection.DEFAULT_SSL_PORT);</span><br><span class="line">    <span class="comment">//可以使用 DN or 含domain User</span></span><br><span class="line">    <span class="keyword">var</span> dnUser = <span class="string">@"CN=rainmaker_ho,OU=EMP,OU=RM,DC=rm,DC=com,DC=tw"</span>;</span><br><span class="line">    <span class="keyword">var</span> domainUser = <span class="string">"rainmaker_ho@rm.com.tw"</span>;</span><br><span class="line">    <span class="keyword">var</span> domainUser2 = <span class="string">@"rm_domain\rainmaker_ho"</span>;</span><br><span class="line">    <span class="keyword">var</span> userpassword = <span class="string">"rm'sppwwdd"</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">string</span>.IsNullOrEmpty(userpassword))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"密碼不能為空值!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//DN 驗證</span></span><br><span class="line">    ldapConn.Bind(dnUser, userpassword);</span><br><span class="line">    <span class="comment">//user@domain 驗證</span></span><br><span class="line">    <span class="comment">//ldapConn.Bind(domainUser, userpassword);</span></span><br><span class="line">    <span class="comment">//domain\user 驗證</span></span><br><span class="line">    <span class="comment">//ldapConn.Bind(domainUser2, userpassword);</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (Exception ex)</span><br><span class="line">&#123;</span><br><span class="line">    Console.WriteLine(ex.ToString());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> authDN = ldapConn.AuthenticationDN;</span><br><span class="line"><span class="comment">// 如果 ldapConn.AuthenticationDN 的值不為空，就表示有驗證過</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">string</span>.IsNullOrEmpty(authDN))</span><br><span class="line">&#123;</span><br><span class="line">    Console.WriteLine(<span class="string">"驗證錯誤"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    Console.WriteLine(<span class="string">$"驗證成功:<span class="subst">&#123;authDN&#125;</span>"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><p><a href="https://github.com/dsbenghe/Novell.Directory.Ldap.NETStandard" target="_blank" rel="noopener">Novell.Directory.Ldap.NETStandard</a><br><a href="https://nicolas.guelpa.me/blog/2017/02/15/dotnet-core-ldap-authentication.html" target="_blank" rel="noopener">.NET Core LDAP authentication</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;目前 .NET Core 的 System.DirectoryServices.Protocols 還不 Support 非 Windows
      
    
    </summary>
    
    
      <category term=".NET Core" scheme="https://rainmakerho.github.io/tags/NET-Core/"/>
    
      <category term="AD" scheme="https://rainmakerho.github.io/tags/AD/"/>
    
      <category term="Authentication" scheme="https://rainmakerho.github.io/tags/Authentication/"/>
    
      <category term="LDAP" scheme="https://rainmakerho.github.io/tags/LDAP/"/>
    
      <category term="Novell.Directory.Ldap.NETStandard" scheme="https://rainmakerho.github.io/tags/Novell-Directory-Ldap-NETStandard/"/>
    
  </entry>
  
  <entry>
    <title>IE 不支援文化特性。參數名稱：name zh-Hant-TW 是無效的文化特性識別項。</title>
    <link href="https://rainmakerho.github.io/2019/09/17/2019024/"/>
    <id>https://rainmakerho.github.io/2019/09/17/2019024/</id>
    <published>2019-09-17T01:32:14.000Z</published>
    <updated>2019-09-17T01:44:02.663Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>最近公司的系統使用 Windows 10, IE 時，出現了以下的錯誤訊息<br><strong>不支援文化特性。<br>參數名稱：name<br>zh-Hant-TW 是無效的文化特性識別項。</strong></p><h3 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h3><p>在 Windows 8 時，可以參考「<a href="https://dotblogs.com.tw/rainmaker/2012/10/21/78733" target="_blank" rel="noopener">[IE]zh-Hant-TW 是無效的文化特性識別項。</a>」這篇的設定，但是到了 Windows 10 ，設定不知跑到了那裡去了。<br>後來同事 JN 有找到，分享出來，而其他同事也有在詢問，所以就一併分享給大家，如下圖，<br><img src="/2019/09/17/2019024/ie10_lange.jpg" title="win10語言設定"><br>設定-&gt;首頁-&gt;隱私權-&gt;一般 ，在右邊有一個「透過讓網站存取我的語言清單以提供當地相關內容」，將它關閉即可。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;最近公司的系統使用 Windows 10, IE 時，出現了以下的錯誤訊息&lt;br&gt;&lt;strong&gt;不支援文化特性。&lt;br&gt;參數名稱：name
      
    
    </summary>
    
    
      <category term="windows 10" scheme="https://rainmakerho.github.io/tags/windows-10/"/>
    
      <category term="ie" scheme="https://rainmakerho.github.io/tags/ie/"/>
    
      <category term="不支援文化特性" scheme="https://rainmakerho.github.io/tags/%E4%B8%8D%E6%94%AF%E6%8F%B4%E6%96%87%E5%8C%96%E7%89%B9%E6%80%A7/"/>
    
  </entry>
  
  <entry>
    <title>Node JS + IIS Node 效能問題</title>
    <link href="https://rainmakerho.github.io/2019/09/05/2019023/"/>
    <id>https://rainmakerho.github.io/2019/09/05/2019023/</id>
    <published>2019-09-05T05:28:57.000Z</published>
    <updated>2019-09-05T06:40:11.922Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>我們有一個系統是使用 NodeJS ，同事 Stan 使用 PuppeteerSharp 同時起多個 Chrome 來測試它。<br>結果一下子 IIS Node 就沒反應了，一整個 Hang 住。</p><h3 id="研究"><a href="#研究" class="headerlink" title="研究"></a>研究</h3><p>想說怎麼跑個沒幾次就掛了呢? 結果發現我們有一段程式，在呼叫 API 時，會等 API 回來，再回給 Client 。例如，</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"><span class="keyword">const</span> &#123; promisify &#125; = <span class="built_in">require</span>(<span class="string">'util'</span>);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, <span class="keyword">async</span> <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line"><span class="keyword">await</span> init();</span><br><span class="line">res.send(<span class="string">`1:<span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">Date</span>()&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>, <span class="string">'127.0.0.1'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="built_in">console</span>.log(</span><br><span class="line"><span class="string">`Server running at http://<span class="subst">$&#123;<span class="keyword">this</span>.address().address&#125;</span>:<span class="subst">$&#123;</span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="keyword">this</span>.address().port</span></span></span><br><span class="line"><span class="string"><span class="subst">&#125;</span>/`</span></span><br><span class="line">);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">init</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="keyword">new</span> <span class="built_in">Date</span>().toJSON(), <span class="number">1</span>);</span><br><span class="line"><span class="keyword">await</span> sleep(<span class="number">30000</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="keyword">new</span> <span class="built_in">Date</span>().toJSON(), <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sleep</span>(<span class="params">ms</span>) </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">setTimeout(resolve, ms);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>雖然在 ASP.NET API 中，常常寫 await 之後，再將結果回給 Client 。<br>但透過 iisnode 來執行，壓個幾次，就會導致 iisnode hang 住。<br>因為這部份的程式，我們並不需要等待 api 的結果，所以就先將內容回給 Client 後，再執行 Call API 的 Task。</p><p>調整後，再來測試， iisnode 就不會 hang 住了。<br>但啟用 webscoket 後，再壓個幾次，又發生 iisnode hang 住的問題。<br>試了後久，後來查到 <a href="https://github.com/tjanczuk/iisnode/issues/268" target="_blank" rel="noopener">IIS stops serving content with iisnode and socket.io #268</a> 有提到 Windows 8 有 Http Request 10 個的限制，當啟用了 WebScoket 之後是一直連接著，所以會導致後面的 Request 被 Block 住。 將環境改到 Windows Server 來測試， WebScoket 也沒問題了。<br>如果有 timeout 問題也可以試著調整 maxNamedPipeConnectionRetry 與 namedPipeConnectionRetryDelay 的設定值。<br>備用方案就是使用 Reverse Proxy 的方式，可以參考 <a href="https://dev.to/petereysermans/hosting-a-node-js-application-on-windows-with-iis-as-reverse-proxy-397b" target="_blank" rel="noopener">Hosting a Node.js application on Windows with IIS as reverse proxy</a>。</p><p>使用 iisnode 下，可以儘快 Response 就儘快 Respose。測試 WebScoket 時，請記得使用 Windows Server 來壓測哦!</p><h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><p><a href="https://github.com/tjanczuk/iisnode/issues/268" target="_blank" rel="noopener">IIS stops serving content with iisnode and socket.io #268</a><br><a href="https://github.com/tjanczuk/iisnode/issues/555" target="_blank" rel="noopener">Does IISnode timeout the Http Request #555</a><br><a href="https://dev.to/petereysermans/hosting-a-node-js-application-on-windows-with-iis-as-reverse-proxy-397b" target="_blank" rel="noopener">Hosting a Node.js application on Windows with IIS as reverse proxy</a><br><a href="https://github.com/tjanczuk/iisnode/issues/558" target="_blank" rel="noopener">Unable to increase the node server timeout beyond 2 minute mark when using IISNode #558</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;我們有一個系統是使用 NodeJS ，同事 Stan 使用 PuppeteerSharp 同時起多個 Chrome 來測試它。&lt;br&gt;結果一
      
    
    </summary>
    
    
      <category term="iisnode" scheme="https://rainmakerho.github.io/tags/iisnode/"/>
    
      <category term="nodejs" scheme="https://rainmakerho.github.io/tags/nodejs/"/>
    
      <category term="windows" scheme="https://rainmakerho.github.io/tags/windows/"/>
    
      <category term="PuppeteerSharp" scheme="https://rainmakerho.github.io/tags/PuppeteerSharp/"/>
    
  </entry>
  
  <entry>
    <title>ASP.NET WebControl.Attributes 無法 Remove 問題</title>
    <link href="https://rainmakerho.github.io/2019/08/24/2019022/"/>
    <id>https://rainmakerho.github.io/2019/08/24/2019022/</id>
    <published>2019-08-24T09:50:18.000Z</published>
    <updated>2019-08-24T10:21:24.331Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>最近同事詢問一個 Web 控制項 在 Form 上面的 Client Click 是沒問題的，但是把它放到了 DataGrid 之中，它就沒有作用。</p><h3 id="研究"><a href="#研究" class="headerlink" title="研究"></a>研究</h3><p>使用 Browser 開發者工具(F12)，去查看，並在 JS 的 event 中寫入 alert 程式碼，當按下那個 Web 控制項 時，程式並沒有順利跑進那個 click 的 event handler 之中。<br>於是往上查看發現，因為在 TR 有一個 onmousedown 事件處理，裡面寫著 onmousedown = “javascript:this.click()”，就把 Click 事件給吃掉了，難怪沒有進去那個 click event handler 之中。 透過 F12 把那個 onmousedown 屬性設定移除， Web 控制項 就可以順利運作了。</p><p>即然找到了問題，再來當然是將那個 onmousedown 屬性從 DataGrid 中的設定移除它，本來想再詢問為何當初會有這樣子的程式碼呢? 它的用意是什麼呢? 當初寫的人已不知去向了。<br>建議從元件或是那支程式去調整，因為有將那個 Web 控制項放進去的只有 2 支程式，而開發團隊也不敢去調整元件，所以就往改那 2 支程式去做。</p><p>所以就建議同事在 PreRender 時，將那個 DataGridItem.Attributes 裡面的 onmousedown 移除。<br>但同事反應不管寫在那裡都移不掉，我連進去看，程式有順利呼叫 Attributes.Remove(“onmousedown”)，但那個 onmousedown 卻還 Render 出去。</p><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">'v10_tbA10_dgMaster 是 datagrid</span></span><br><span class="line"><span class="keyword">Protected</span> <span class="keyword">Sub</span> Page_PreRender(<span class="keyword">ByVal</span> sender <span class="keyword">As</span> <span class="built_in">Object</span>, <span class="keyword">ByVal</span> e <span class="keyword">As</span> System.EventArgs) <span class="keyword">Handles</span> <span class="keyword">Me</span>.PreRender</span><br><span class="line">  <span class="keyword">Dim</span> item <span class="keyword">As</span> DataGridItem</span><br><span class="line">  <span class="keyword">For</span> <span class="keyword">Each</span> item <span class="keyword">In</span> <span class="keyword">Me</span>.v10_tbA10_dgMaster.Items</span><br><span class="line">      item.Attributes.Remove(<span class="string">"onmousedown"</span>)</span><br><span class="line">  <span class="keyword">Next</span></span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Sub</span></span><br></pre></td></tr></table></figure><p>想說不可能呀!<br>於是將那些 Key 值印出來才發現，那個「onmousedown 」後面多了一個<strong>空白</strong>，難怪怎麼移都移不掉。<br>後來將程式改成如下，就順利解掉了。</p><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">'v10_tbA10_dgMaster 是 datagrid</span></span><br><span class="line"><span class="keyword">Protected</span> <span class="keyword">Sub</span> Page_PreRender(<span class="keyword">ByVal</span> sender <span class="keyword">As</span> <span class="built_in">Object</span>, <span class="keyword">ByVal</span> e <span class="keyword">As</span> System.EventArgs) <span class="keyword">Handles</span> <span class="keyword">Me</span>.PreRender</span><br><span class="line">  <span class="keyword">Dim</span> item <span class="keyword">As</span> DataGridItem</span><br><span class="line">  <span class="keyword">For</span> <span class="keyword">Each</span> item <span class="keyword">In</span> <span class="keyword">Me</span>.v10_tbA10_dgMaster.Items</span><br><span class="line">      item.Attributes.Remove(<span class="string">"onmousedown "</span>)</span><br><span class="line">  <span class="keyword">Next</span></span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Sub</span></span><br></pre></td></tr></table></figure><p>程式呀~~ 真的是什麼都有可能發生 Q_Q<br>希望大家在解問題時，多些細心、耐心，一起努力 :)</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;最近同事詢問一個 Web 控制項 在 Form 上面的 Client Click 是沒問題的，但是把它放到了 DataGrid 之中，它就沒
      
    
    </summary>
    
    
      <category term="ASP.NET" scheme="https://rainmakerho.github.io/tags/ASP-NET/"/>
    
      <category term="程式什麼都有可能發生" scheme="https://rainmakerho.github.io/tags/%E7%A8%8B%E5%BC%8F%E4%BB%80%E9%BA%BC%E9%83%BD%E6%9C%89%E5%8F%AF%E8%83%BD%E7%99%BC%E7%94%9F/"/>
    
      <category term="DataGridItem" scheme="https://rainmakerho.github.io/tags/DataGridItem/"/>
    
      <category term="WebControl.Attributes" scheme="https://rainmakerho.github.io/tags/WebControl-Attributes/"/>
    
  </entry>
  
  <entry>
    <title>Visual Studio 2017 WebTest for aspx postback</title>
    <link href="https://rainmakerho.github.io/2019/08/24/2019021/"/>
    <id>https://rainmakerho.github.io/2019/08/24/2019021/</id>
    <published>2019-08-24T05:28:53.000Z</published>
    <updated>2019-08-24T06:05:35.787Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>有朋友詢問使用 Visual Studio 2017 使用 WebTest 錄 ASPX 程式時，遇到了 postback 就會噴錯。<br>於是上網找個 aspx 的網站來試錄一下，結果發現錄完後，在很多 postback 的地方的確會錯誤。如下圖，<br><img src="/2019/08/24/2019021/001.png" title="WebTest Error"></p><h3 id="研究與解法"><a href="#研究與解法" class="headerlink" title="研究與解法"></a>研究與解法</h3><p>仔細看錯的地方還蠻奇怪的(上圖)，postback，應該要走 POST ，結果那個 url 卻是 GET。<br>再展開那個 GET 有一個 Dependent Requests 的 Url ，它是 POST，看起來那個才是我們需要的。如下圖，<br><img src="/2019/08/24/2019021/002.png" title="Dependent Requests"><br>檢查下一個 GET URL 的 Dependent Requests 中的 Url 也是 POST，應該也是我們需要的。<br>即然它才是我們需要的，所以我們可以將它們從 Dependent Requests 目錄中，移到最上層，然後再將那 2 個 GET 的 URL 刪除。<br><img src="/2019/08/24/2019021/003.png" title="Move POST And Delete GET"></p><p>所以從開頭 GET 到 2 個 POST 後，再測試一次，就可以發現，最後的結果是我們所需要的哦! 如下，<br><img src="/2019/08/24/2019021/004.png" title="Test OK"></p><h3 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h3><p>筆者試過 Visual Studio 2017/2019 都會有這樣子的狀況，所以在使用上，如果有遇到一樣的問題，可以試著這樣子調整看看哦!</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;有朋友詢問使用 Visual Studio 2017 使用 WebTest 錄 ASPX 程式時，遇到了 postback 就會噴錯。&lt;br
      
    
    </summary>
    
    
      <category term="VS2017" scheme="https://rainmakerho.github.io/tags/VS2017/"/>
    
      <category term="VS2019" scheme="https://rainmakerho.github.io/tags/VS2019/"/>
    
      <category term="WebTest" scheme="https://rainmakerho.github.io/tags/WebTest/"/>
    
      <category term="ASPX" scheme="https://rainmakerho.github.io/tags/ASPX/"/>
    
      <category term="Postback" scheme="https://rainmakerho.github.io/tags/Postback/"/>
    
  </entry>
  
  <entry>
    <title>ODataController Cross site scripting (content-sniffing)</title>
    <link href="https://rainmakerho.github.io/2019/07/31/2019020/"/>
    <id>https://rainmakerho.github.io/2019/07/31/2019020/</id>
    <published>2019-07-31T09:03:02.000Z</published>
    <updated>2019-07-31T09:57:37.189Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>最近同事詢問一個 ODataController 被黑箱打到的一個 XSS 問題。<br>ODataController 允許我們使用 $count, $select 等操作。<br>我們用一個簡單的 webapi 專案來測試，新增 WebApi 專案後，加入「Microsoft.AspNet.OData」。<br>詳細可以參考 <a href="https://docs.microsoft.com/en-us/aspnet/web-api/overview/odata-support-in-aspnet-web-api/odata-v4/create-an-odata-v4-endpoint" target="_blank" rel="noopener">Create an OData v4 Endpoint Using ASP.NET Web API</a>。</p><h3 id="測試"><a href="#測試" class="headerlink" title="測試"></a>測試</h3><p>建立 Product Model ，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Product</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">int</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">decimal</span> Price &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>因為只要測試 odata ，所以在 WebApiConfig.cs 只需設定 OData 的部份，如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">WebApiConfig</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Register</span>(<span class="params">HttpConfiguration config</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        config.MapHttpAttributeRoutes();</span><br><span class="line">        <span class="keyword">var</span> builder = <span class="keyword">new</span> ODataConventionModelBuilder();</span><br><span class="line">        config.Count().Filter().OrderBy().Expand().Select().MaxTop(<span class="literal">null</span>); <span class="comment">//new line</span></span><br><span class="line">        builder.EntitySet&lt;Product&gt;(<span class="string">"Products"</span>);</span><br><span class="line">        config.MapODataServiceRoute(</span><br><span class="line">          routeName: <span class="string">"odata"</span>,</span><br><span class="line">          routePrefix: <span class="string">"odata"</span>,</span><br><span class="line">          model: builder.GetEdmModel());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>建立測試的 ODataController</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ProductsController</span> : <span class="title">ODataController</span></span><br><span class="line">&#123;</span><br><span class="line">  [<span class="meta">EnableQuery</span>]</span><br><span class="line">  <span class="function"><span class="keyword">public</span> IHttpActionResult <span class="title">Get</span>(<span class="params">ODataQueryOptions&lt;Product&gt; opts</span>)</span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> products = <span class="keyword">new</span> List&lt;Product&gt;() &#123;</span><br><span class="line">      <span class="keyword">new</span> Product&#123;Id=<span class="number">1</span>, Name=<span class="string">"Product 1***"</span>, Price=<span class="number">101</span>&#125;,</span><br><span class="line">      <span class="keyword">new</span> Product&#123;Id=<span class="number">2</span>, Name=<span class="string">"Product 2***"</span>, Price=<span class="number">202</span>&#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> Ok(products);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>所以執行出來的結果如下，</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:50758/odata/Products?$count=true</span><br></pre></td></tr></table></figure><img src="/2019/07/31/2019020/001.png" title="正常的輸出"><p>正常的 \$count 的值允許為 true/false。<br>但是黑箱卻給它輸入以下的值，</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$count=&lt;ScRiPt&gt;cXfm(9342)&lt;/ScRiPt&gt;</span><br></pre></td></tr></table></figure><img src="/2019/07/31/2019020/002.png" title="XSS輸出"><p>因為直接把 url 上的內容直接輸出了，所以就被黑箱說有 XSS 問題。</p><h3 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h3><p>從上面可以發現，雖然它有錯誤的訊息出來，但程式卻會正常執行到 OK。<br>只是在 ODataQueryOptions<product> opts 中的 count.value 屬性會有錯誤，如下，<br><img src="/2019/07/31/2019020/003.png" title="ODataQueryOptions.count.value"></product></p><p>即然沒有錯誤，那要在那裡去將錯誤訊息 Encode 呢?<br>我們可以透過 opts.ApplyTo 去驗證它們，如果有錯誤的話，就建立 ODataException ，並將訊息 Encode ，如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">EnableQuery</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> IHttpActionResult <span class="title">Get</span>(<span class="params">ODataQueryOptions&lt;Product&gt; opts</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">var</span> products = <span class="keyword">new</span> List&lt;Product&gt;() &#123;</span><br><span class="line">    <span class="keyword">new</span> Product&#123;Id=<span class="number">1</span>, Name=<span class="string">"Product 1***"</span>, Price=<span class="number">101</span>&#125;,</span><br><span class="line">    <span class="keyword">new</span> Product&#123;Id=<span class="number">2</span>, Name=<span class="string">"Product 2***"</span>, Price=<span class="number">202</span>&#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">try</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">//only validate ODataQueryOptions</span></span><br><span class="line">    opts.ApplyTo((<span class="keyword">new</span> List&lt;Product&gt;()).AsQueryable());</span><br><span class="line">    <span class="keyword">return</span> Ok(products);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span>(Exception ex)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ODataException(HttpUtility.JavaScriptStringEncode(ex.ToString()));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>所以再執行一次，就可以發現錯誤訊息都有被 Encode 了。<br><img src="/2019/07/31/2019020/004.png" title="ODataException"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;最近同事詢問一個 ODataController 被黑箱打到的一個 XSS 問題。&lt;br&gt;ODataController 允許我們使用 $c
      
    
    </summary>
    
    
      <category term="Odata" scheme="https://rainmakerho.github.io/tags/Odata/"/>
    
      <category term="Cross site scripting" scheme="https://rainmakerho.github.io/tags/Cross-site-scripting/"/>
    
      <category term="content-sniffing" scheme="https://rainmakerho.github.io/tags/content-sniffing/"/>
    
      <category term="ODataController" scheme="https://rainmakerho.github.io/tags/ODataController/"/>
    
  </entry>
  
  <entry>
    <title>double.parse cause Input string was not in a correct format Error</title>
    <link href="https://rainmakerho.github.io/2019/07/19/2019019/"/>
    <id>https://rainmakerho.github.io/2019/07/19/2019019/</id>
    <published>2019-07-19T08:09:31.000Z</published>
    <updated>2019-07-19T08:44:28.752Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>最近同事遇到在 XML 解析上發生問題，但資料肉眼卻看不出來異狀。<br>今天又在 stackoverflow 上看到<a href="https://stackoverflow.com/questions/57107030/c-sharp-double-parsing-giving-an-error-when-it-shouldnt#57107469" target="_blank" rel="noopener">C# Double Parsing Giving an error when it shouldn’t</a>利用 double.parse 遇到 “240000” 時，卻會發生 Input string was not in a correct format 的錯誤。</p><h3 id="研究"><a href="#研究" class="headerlink" title="研究"></a>研究</h3><p><a href="https://stackoverflow.com/users/1612975/thegeneral" target="_blank" rel="noopener">TheGeneral</a>很快地發現，並不是 240000 有問題，而是他的資料”240000”中，有不可視字元。<br>所以如果用題問者的字串(t1)，跟自已 key 一個字串(t2)來看，當 parse 到 t1 時，的確會發生錯誤，如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> t1 = <span class="string">"240000‬"</span>;</span><br><span class="line"><span class="keyword">var</span> t2 = <span class="string">"240000"</span>;</span><br><span class="line"><span class="keyword">var</span> do2 = <span class="keyword">double</span>.Parse(t2);</span><br><span class="line"><span class="keyword">var</span> do1 = <span class="keyword">double</span>.Parse(t1); <span class="comment">//這裡會噴錯</span></span><br></pre></td></tr></table></figure><img src="/2019/07/19/2019019/001.png" title="double.parse error"><p>上面肉眼來看，t1, t2 沒有差別，但將它們每個字串 print 出來後可以發現，t1 多了一個 ? ，unicode 為 202c，如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> t1 = <span class="string">"240000"</span>;</span><br><span class="line"><span class="keyword">var</span> t2 = <span class="string">"240000"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">string</span> dumpt1 = <span class="keyword">string</span>.Join(Environment.NewLine,</span><br><span class="line">  t1.Select(c =&gt; <span class="string">$"'<span class="subst">&#123;c&#125;</span>' (\\u<span class="subst">&#123;(<span class="keyword">int</span>)c:x4&#125;</span>)"</span>));</span><br><span class="line"><span class="keyword">string</span> dumpt2 = <span class="keyword">string</span>.Join(Environment.NewLine,</span><br><span class="line">  t2.Select(c =&gt; <span class="string">$"'<span class="subst">&#123;c&#125;</span>' (\\u<span class="subst">&#123;(<span class="keyword">int</span>)c:x4&#125;</span>)"</span>));</span><br><span class="line"></span><br><span class="line">Console.WriteLine(<span class="string">"****** t1 **********"</span>);</span><br><span class="line">Console.WriteLine(dumpt1);</span><br><span class="line">Console.WriteLine(<span class="string">"****** t2 **********"</span>);</span><br><span class="line">Console.WriteLine(dumpt2);</span><br><span class="line">Console.WriteLine(<span class="string">"********************"</span>);</span><br></pre></td></tr></table></figure><img src="/2019/07/19/2019019/002.png" title="unprintable char"><p>所以當有類似的問題，而眼睛又看不出來時，可以將該內容的字元列印出來比對看看哦!</p><h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><p><a href="https://stackoverflow.com/questions/57107030/c-sharp-double-parsing-giving-an-error-when-it-shouldnt#57107469" target="_blank" rel="noopener">C# Double Parsing Giving an error when it shouldn’t</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;最近同事遇到在 XML 解析上發生問題，但資料肉眼卻看不出來異狀。&lt;br&gt;今天又在 stackoverflow 上看到&lt;a href=&quot;ht
      
    
    </summary>
    
    
      <category term="non-printable characters" scheme="https://rainmakerho.github.io/tags/non-printable-characters/"/>
    
      <category term="不可視字元" scheme="https://rainmakerho.github.io/tags/%E4%B8%8D%E5%8F%AF%E8%A6%96%E5%AD%97%E5%85%83/"/>
    
  </entry>
  
  <entry>
    <title>Checkmarx Cookie_Injection</title>
    <link href="https://rainmakerho.github.io/2019/07/17/2019018/"/>
    <id>https://rainmakerho.github.io/2019/07/17/2019018/</id>
    <published>2019-07-17T01:31:40.000Z</published>
    <updated>2019-07-17T01:51:42.908Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>最近系統被 Checkmarx 掃出有 Cookie_Injection 的問題。<br>似乎是怕在 Server 端取得 Cookie 的值，再給 Client 端時，會發生 XSS 的問題。<br>但它的 Issue 點卻是在 Request.Cookies[cookieName] ，如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> cookieNme = <span class="string">"SurveyCookie"</span>;</span><br><span class="line">HttpCookie cookie = Request.Cookies[cookieNme];</span><br><span class="line"><span class="keyword">if</span> (cookie == <span class="literal">null</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// no cookie found, create it</span></span><br><span class="line">  cookie = <span class="keyword">new</span> HttpCookie(cookieNme);</span><br><span class="line">&#125;</span><br><span class="line">cookie.Values[<span class="string">"usrId"</span>] = HttpUtility.UrlEncode(otherValue1);</span><br><span class="line">cookie.Values[<span class="string">"usrName"</span>] = HttpUtility.UrlEncode(otherValue2);</span><br><span class="line"><span class="comment">// update the expiration timestamp</span></span><br><span class="line">cookie.Expires = DateTime.UtcNow.AddDays(<span class="number">30</span>);</span><br><span class="line"><span class="comment">// HttpOnly &amp; Secure 可以在 web.config 中設定</span></span><br><span class="line">cookie.HttpOnly = <span class="literal">true</span>;</span><br><span class="line">cookie.Secure = <span class="literal">true</span>;</span><br><span class="line"><span class="comment">// overwrite the cookie</span></span><br><span class="line">Response.Cookies.Add(cookie);</span><br></pre></td></tr></table></figure><h3 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h3><p>感覺 Checkmarx 一見到取回 Request 的 Cookie 就開槍。<br>所以只好調整成，取回 Cookie 的 Values ，然後改判斷它的值。<br>如果要產生 cookie 的話，就直接新增一個 cookie 物件，也不是重新利用 Request 的物件，如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> cookieValues = Request.Cookies[cookieNme]?.Values;</span><br><span class="line"><span class="keyword">if</span> (cookieValues != <span class="literal">null</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">var</span> usrId = HttpUtility.UrlEncode(cookieValues[<span class="string">"usrId"</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> cookie = <span class="keyword">new</span> HttpCookie(cookieNme);</span><br><span class="line">cookie.Values[<span class="string">"usrId"</span>] = HttpUtility.UrlEncode(otherValue1);</span><br><span class="line">cookie.Values[<span class="string">"usrName"</span>] = HttpUtility.UrlEncode(otherValue2);</span><br><span class="line"><span class="comment">// update the expiration timestamp</span></span><br><span class="line">cookie.Expires = DateTime.UtcNow.AddDays(<span class="number">30</span>);</span><br><span class="line"><span class="comment">// HttpOnly &amp; Secure 可以在 web.config 中設定</span></span><br><span class="line">cookie.HttpOnly = <span class="literal">true</span>;</span><br><span class="line">cookie.Secure = <span class="literal">true</span>;</span><br><span class="line"><span class="comment">// overwrite the cookie</span></span><br><span class="line">Response.Cookies.Add(cookie);</span><br></pre></td></tr></table></figure><ul><li>註: ?. 是 C#4 的語法，如果有問題的話，請更新 Microsoft.CodeDom.Providers.DotNetCompilerPlatform 套件。</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;最近系統被 Checkmarx 掃出有 Cookie_Injection 的問題。&lt;br&gt;似乎是怕在 Server 端取得 Cookie 的
      
    
    </summary>
    
    
      <category term="checkmarx" scheme="https://rainmakerho.github.io/tags/checkmarx/"/>
    
      <category term="Cookie_Injection" scheme="https://rainmakerho.github.io/tags/Cookie-Injection/"/>
    
      <category term="CSharp" scheme="https://rainmakerho.github.io/tags/CSharp/"/>
    
  </entry>
  
  <entry>
    <title>Bitmap.save(): A generic error occurred in GDI+</title>
    <link href="https://rainmakerho.github.io/2019/07/04/2019017/"/>
    <id>https://rainmakerho.github.io/2019/07/04/2019017/</id>
    <published>2019-07-04T00:57:37.000Z</published>
    <updated>2019-09-05T05:28:31.096Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>記得「 Image.Save(stream,format.png) GDI+ generic error」這個錯誤在好久之前有看到過，但一直沒有注意那時是如何解決的。<br>今天同事有再詢問，所以就將網路上的資料一併記錄一下。</p><h3 id="研究"><a href="#研究" class="headerlink" title="研究"></a>研究</h3><p>網路上有的人說因為原本的 Image 被 Lock 住了，或是要  避免使用原本的 Stream 去 Save。<br>例如 Rick 的範例， 建立 bm2 後，再把 bm2 Save 到 Stream 去，就有可能會 GG。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Bitmap bm2 = <span class="keyword">this</span>.GetGlobalResourceObject(<span class="string">"Resources"</span>, <span class="string">"_BitMap"</span>) <span class="keyword">as</span> Bitmap;</span><br><span class="line"></span><br><span class="line">Response.ContentType = <span class="string">"image/jpeg"</span>;</span><br><span class="line"></span><br><span class="line">bm2.Save(Response.OutputStream, ImageFormat.Jpeg);</span><br><span class="line"></span><br><span class="line">Response.End();</span><br></pre></td></tr></table></figure><p>我們公司的程式，在某些機器上才會出現錯誤，如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 將讀取檔案之Byte[]轉成圖片檔的Base64</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="bytes"&gt;</span>圖檔的Byte Array<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="sourceFileFormat"&gt;</span>圖片格式<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span>[] <span class="title">ToImageBase64</span>(<span class="params"><span class="keyword">this</span> <span class="keyword">byte</span>[] bytes, ImageFormat sourceFileFormat</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// *** 參考資料:http://stackoverflow.com/questions/401561/how-to-open-a-multi-frame-tiff-imageformat-image-in-net-2-0</span></span><br><span class="line">    List&lt;<span class="keyword">string</span>&gt; images = <span class="keyword">new</span> List&lt;<span class="keyword">string</span>&gt;();</span><br><span class="line">    <span class="comment">// *** 將byte[] 存為MemoryStream ***</span></span><br><span class="line">    <span class="keyword">using</span> (Stream imageStreams = <span class="keyword">new</span> MemoryStream(bytes))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// *** 從MemoryStream中讀取Image ***</span></span><br><span class="line">        Image image = Image.FromStream(imageStreams);</span><br><span class="line">        <span class="comment">// *** 取得圖片檔的頁數 ***</span></span><br><span class="line">        <span class="keyword">int</span> page = image.GetFrameCount(FrameDimension.Page);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> p = <span class="number">0</span>; p &lt; page; p++)</span><br><span class="line">        &#123;</span><br><span class="line">            image.SelectActiveFrame(FrameDimension.Page, p);</span><br><span class="line">            <span class="comment">// *** 將Image File存入Stream中 ***</span></span><br><span class="line">            <span class="keyword">using</span> (<span class="keyword">var</span> byteStream = <span class="keyword">new</span> MemoryStream())</span><br><span class="line">            &#123;</span><br><span class="line">                image.Save(byteStream, sourceFileFormat);</span><br><span class="line">                <span class="comment">// *** 將Image Stream轉成Base64 ***</span></span><br><span class="line">                images.Add(Convert.ToBase64String(byteStream.ToArray()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// *** 從MemoryStream中讀取Image ***</span></span><br><span class="line">    <span class="keyword">return</span> images.ToArray();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">image.Save(byteStream, sourceFileFormat);</span><br></pre></td></tr></table></figure><p>上面 image.Save 在某些狀況下會出錯，或許可以新增一個 Bitmap 物件來 Save ，如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> p = <span class="number">0</span>; p &lt; page; p++)</span><br><span class="line">&#123;</span><br><span class="line">image.SelectActiveFrame(FrameDimension.Page, p);</span><br><span class="line"><span class="keyword">using</span> (<span class="keyword">var</span> newImage = <span class="keyword">new</span> Bitmap(image))</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// *** 將Image File存入Stream中 ***</span></span><br><span class="line"><span class="keyword">using</span> (<span class="keyword">var</span> byteStream = <span class="keyword">new</span> MemoryStream())</span><br><span class="line">&#123;</span><br><span class="line">newImage.Save(byteStream, sourceFileFormat);</span><br><span class="line"><span class="comment">// *** 將Image Stream轉成Base64 ***</span></span><br><span class="line">images.Add(Convert.ToBase64String(byteStream.ToArray()));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="現況"><a href="#現況" class="headerlink" title="現況"></a>現況</h3><p>雖然程式上去了，但在 IIS 運行一段時間後，又出現了 GDI+ 的錯誤。iisreset 後又可以了。<br>查看有問題的 png ，高度也沒太高，w3wp.exe 也沒有吃到很高的 Memory 。<br>在查不到任何頭緒之下，想到 png 只有一頁而已，原本的程式碼應該是針對 Tiff 來處理分頁的。<br>而讀進來的 Byte Array 本身就是 Image 了，就不需要特別再將它轉再 Image 又再轉回 Byte Array。<br>直接將傳進來的 Byte Array 直接轉 Base64 字串出去就可以了。</p><p>測試的程式如下，</p><ul><li>原本的程式</li></ul><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">string</span>[] <span class="title">GetPngFiles</span>(<span class="params"><span class="keyword">string</span>[] pngPaths</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">List&lt;<span class="keyword">string</span>&gt; pngImages = <span class="keyword">new</span> List&lt;<span class="keyword">string</span>&gt;();</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">string</span> realFileLocation <span class="keyword">in</span> pngPaths)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//read image 2 bytearray</span></span><br><span class="line"><span class="keyword">var</span> imageFile = Server.MapPath(<span class="string">$"~/images/<span class="subst">&#123;realFileLocation&#125;</span>"</span>);</span><br><span class="line"><span class="keyword">byte</span>[] bytes = File.ReadAllBytes(imageFile);</span><br><span class="line">List&lt;<span class="keyword">string</span>&gt; images = <span class="keyword">new</span> List&lt;<span class="keyword">string</span>&gt;();</span><br><span class="line"><span class="comment">// *** 將byte[] 存為MemoryStream ***</span></span><br><span class="line"><span class="keyword">using</span> (Stream imageStreams = <span class="keyword">new</span> MemoryStream(bytes))</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// *** 從MemoryStream中讀取Image ***</span></span><br><span class="line"><span class="keyword">var</span> image = Image.FromStream(imageStreams);</span><br><span class="line"><span class="comment">// *** 取得圖片檔的頁數 ***</span></span><br><span class="line"><span class="keyword">int</span> page = image.GetFrameCount(FrameDimension.Page);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> p = <span class="number">0</span>; p &lt; page; p++)</span><br><span class="line">&#123;</span><br><span class="line">image.SelectActiveFrame(FrameDimension.Page, p);</span><br><span class="line"><span class="comment">// *** 將Image File存入Stream中 ***</span></span><br><span class="line"><span class="keyword">using</span> (<span class="keyword">var</span> byteStream = <span class="keyword">new</span> MemoryStream())</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">using</span> (<span class="keyword">var</span> newImage = <span class="keyword">new</span> Bitmap(image))</span><br><span class="line">&#123;</span><br><span class="line">newImage.Save(byteStream, sourceFileFormat);</span><br><span class="line"><span class="comment">// *** 將Image Stream轉成Base64 ***</span></span><br><span class="line">images.Add(Convert.ToBase64String(byteStream.ToArray()));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//image.Save(byteStream, sourceFileFormat);</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span>/ *** 將Image Stream轉成Base64 ***</span></span><br><span class="line"><span class="comment">//images.Add(Convert.ToBase64String(byteStream.ToArray()));</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">pngImages.Add(images.ToArray()[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> pngImages.ToArray();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>調整後的程式</li></ul><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">string</span>[] <span class="title">GetPngFiles2</span>(<span class="params"><span class="keyword">string</span>[] pngPaths</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">List&lt;<span class="keyword">string</span>&gt; pngImages = <span class="keyword">new</span> List&lt;<span class="keyword">string</span>&gt;();</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">string</span> realFileLocation <span class="keyword">in</span> pngPaths)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//read image 2 bytearray</span></span><br><span class="line"><span class="keyword">var</span> imageFile = Server.MapPath(<span class="string">$"~/images/<span class="subst">&#123;realFileLocation&#125;</span>"</span>);</span><br><span class="line"><span class="keyword">byte</span>[] bytes = File.ReadAllBytes(imageFile);</span><br><span class="line"><span class="comment">// *** 將Image Stream轉成Base64 ***</span></span><br><span class="line">pngImages.Add(Convert.ToBase64String(bytes));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> pngImages.ToArray();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>註: 後來那個 GDI+ 又出現在 Aspose 的套件中，而且奇怪的是發生後，需要「重新開機」才又可以使用，過個 2 天，又會出現，所以與同事持續關注中，有新的狀況會再跟大家 Update。</li></ul><p>有看了一下網路上的可能問題，</p><ol><li>讀檔權限不足</li><li>沒有 Dispose</li><li>在使用前，已被 Dispose 掉了。</li></ol><h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><p><a href="https://weblog.west-wind.com/posts/2006/Oct/19/Common-Problems-with-rendering-Bitmaps-into-ASPNET-OutputStream" target="_blank" rel="noopener">Common Problems with rendering Bitmaps into ASP.NET OutputStream</a><br><a href="https://www.vishalon.net/blog/bitmapsave-a-generic-error-occurred-in-gdi" target="_blank" rel="noopener">Bitmap.save(): A generic error occurred in GDI+</a><br><a href="https://stackoverflow.com/questions/7698737/asp-net-a-generic-error-occurred-in-gdi" target="_blank" rel="noopener">asp.net : A generic error occurred in GDI+</a><br><a href="https://stackoverflow.com/questions/7558172/image-selectactiveframe-memory-problem" target="_blank" rel="noopener">Image.SelectActiveFrame memory problem</a><br><a href="https://stackoverflow.com/questions/1053052/a-generic-error-occurred-in-gdi-jpeg-image-to-memorystream/33324011#33324011" target="_blank" rel="noopener">A generic error occurred in GDI+, JPEG Image to MemoryStream</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;記得「 Image.Save(stream,format.png) GDI+ generic error」這個錯誤在好久之前有看到過，但一直
      
    
    </summary>
    
    
      <category term="Bitmap.save" scheme="https://rainmakerho.github.io/tags/Bitmap-save/"/>
    
      <category term="GDI+" scheme="https://rainmakerho.github.io/tags/GDI/"/>
    
  </entry>
  
  <entry>
    <title>Microsoft Threat Modeling Tool</title>
    <link href="https://rainmakerho.github.io/2019/07/03/2019016/"/>
    <id>https://rainmakerho.github.io/2019/07/03/2019016/</id>
    <published>2019-07-03T02:01:57.000Z</published>
    <updated>2019-07-03T05:42:20.333Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>大家在開發系統時除了畫系統架構圖之外，不知有沒畫 Threat Modeling 呢?<br>有了 Threat Modeling 可以看到整個系統大約有那些的 威脅，然後在開發系統時，一併考量進去。<br>跟 bug 一樣，逾早發現安全性威脅，解決成本逾低。<br>我們可以從 <a href="https://aka.ms/threatmodelingtool" target="_blank" rel="noopener">Microsoft Threat Modeling Tool</a> 來安裝 (windows only)。</p><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><h4 id="Application-Review"><a href="#Application-Review" class="headerlink" title="Application Review"></a>Application Review</h4><p><strong>Microsoft Threat Modeling Tool</strong> 讓我們透過畫 Data Flow Diagrams(DFDs) 後，自動產生相關的安全性威脅。<br>安裝完成後，開啟程式可以選擇 Azure or SDL 的範本，請依您系統的類別選取範本，這裡筆者是使用 SDL 範本。<br><img src="/2019/07/03/2019016/001.png" title="選取範本"></p><p>然後按下「Create A Model」就會進入空白的 Diagram 。<br><img src="/2019/07/03/2019016/002.png" title="NewModel"></p><p>而我們在畫的過程中，應著重在安全性方面進行系統架構 Review，考量以下幾點，</p><ul><li>這系統會有那些使用者?</li><li>有什麼合規的要求嗎?</li><li>有那些資料需要被保護嗎?</li><li>有跟其他系統互動?</li></ul><h4 id="Data-Flow-Diagrams"><a href="#Data-Flow-Diagrams" class="headerlink" title="Data Flow Diagrams"></a>Data Flow Diagrams</h4><p><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/24/Data-flow-diagram-notation.svg/440px-Data-flow-diagram-notation.svg.png" alt="Data Flow Diagrams" width="250"></p><h4 id="開始作畫"><a href="#開始作畫" class="headerlink" title="開始作畫"></a>開始作畫</h4><p>1.先拉出 Elements<br>一開始，先將跟安全性相關的項目拉到畫布上<br><img src="/2019/07/03/2019016/003.png" title="Elements"></p><p>2.用 Flow 串起來<br>再將每個項目透過 Flow 串接起來<br><img src="/2019/07/03/2019016/004.png" title="Flow"></p><p>3.標示 Elements<br>再檢視有那些需要做額外的標示，例如 Process 使用的語言(c#, Node, Java…)<br><img src="/2019/07/03/2019016/005.png" title="Flow"></p><p>4.加上備註</p><p>5.找其他人一起來 Review</p><h4 id="Threat-Types"><a href="#Threat-Types" class="headerlink" title="Threat Types"></a>Threat Types</h4><p><strong>Microsoft Threat Modeling Tool</strong> 會套用 STRIDE Threat Types，<br>參考自<a href="https://docs.microsoft.com/en-us/azure/security/azure-security-threat-modeling-tool-threats" target="_blank" rel="noopener">Microsoft Threat Modeling Tool threats</a></p><table><thead><tr><th>類別</th><th>描述</th></tr></thead><tbody><tr><td>詐騙 Spoofing</td><td>涉及非法存取然後使用其他使用者的驗證資訊，例如使用者名稱和密碼</td></tr><tr><td>竄改 Tampering</td><td>涉及惡意修改資料。 範例包括未經授權變更持續性資料 (例如保存在資料庫中的資料)，以及修改在兩部電腦之間透過開放式網路 (例如網際網路) 流動的資料 (中間人攻擊，修改交易金額…)</td></tr><tr><td>否認性 Repudiation</td><td>與拒絕執行動作但沒有其他任何一方有辦法另外證明的使用者有關，比方說，使用者在無法追蹤禁止作業的系統中執行非法作業。 不可否認性是指系統對抗否認性威脅的能力。 例如，購買商品的使用者可能必須在收到商品時簽名。 然後，廠商可以使用簽名收據做為使用者已收到包裹的證據</td></tr><tr><td>資訊洩漏 Information Disclosure</td><td>涉及將資訊暴露給不應該具有其存取權的個人，例如，使用者可以讀取它們未被授權存取的檔案，或入侵者能夠讀取在兩部電腦之間傳輸的資料</td></tr><tr><td>阻斷服務 Denial of Service</td><td>阻斷服務 (DoS) 攻擊可阻斷對有效使用者提供的服務，例如，藉由讓網頁伺服器暫時無法存取或無法使用。 您必須防止特定類型的 DoS 威脅，以便提升系統的可用性和可靠性</td></tr><tr><td>權限提高 Elevation of Privilege</td><td>未授權的使用者取得授權的存取權，因此有足夠存取權危害或摧毀整個系統。 提高權限威脅包含下列情況：攻擊者已有效地滲透所有系統防禦，並成為受信任系統本身的一部分，這確實是危險的情況</td></tr></tbody></table><p><br></p><h4 id="分析-Threats"><a href="#分析-Threats" class="headerlink" title="分析 Threats"></a>分析 Threats</h4><p>畫好之後，切到 Analysis View，就可以看到下面有一堆的 Threats ，大家可依它們的說明來了解為什麼會有那些 Threats 以及如何調整它們，<br><img src="/2019/07/03/2019016/006.png" title="Analysis View"><br>大家可以查看每個 Threat ，設定它們的優先序，及在 Justification 寫入因應作法，設定 Status 。</p><h4 id="產生報表"><a href="#產生報表" class="headerlink" title="產生報表"></a>產生報表</h4><p>我們可以按 Menu 上的 Report 來產生 html 報表。<br><img src="https://docs.microsoft.com/en-us/azure/security/media/azure-security-threat-modeling-tool-feature-overview/report.png" alt="Threats Modeling Report"></p><h3 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h3><p>我們有了 Threat Model ，會對整個系統整體的安全性有一定的了解，也可以儘早針對高風險的 Threat 進行防範。</p><ul><li>註: 自動列出 Threats ?<br>不知大家是否對於該 Tool 為什麼可以自動列出 Threats 而感到好奇呢?<br>只要大家開啟 Template 就可以知道，它其實是有寫 Rule 在裡面，當 Elements 有相關，並且屬性值為某個值時，就會出現那個 Threat ，例如下圖，當 Source 為 Generic External Interactor ， Target 為 Generic Process 就會出現那個 Threat ，但如果 Flow 的屬性有設設定 Source Authenticated 是 Yes ，或是 Generic External Interactor 屬性有設定 Authenticates Itself 為 Yes ，就不會出現那個 Threat<img src="/2019/07/03/2019016/007.png" title="Threat Rule"></li></ul><h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><p><a href="https://resources.infosecinstitute.com/applications-threat-modeling/#gref" target="_blank" rel="noopener">Applications Threat Modeling</a><br><a href="https://www.geeksforgeeks.org/microsoft-threat-modelling-tool-2016-set-1/" target="_blank" rel="noopener">Microsoft Threat modelling tool 2016 | Set 1</a><br><a href="https://aka.ms/threatmodelingtool" target="_blank" rel="noopener">下載 Microsoft Threat Modeling Tool</a><br><a href="https://docs.microsoft.com/en-us/azure/security/azure-security-threat-modeling-tool-feature-overview" target="_blank" rel="noopener">Threat Modeling Tool feature overview</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;大家在開發系統時除了畫系統架構圖之外，不知有沒畫 Threat Modeling 呢?&lt;br&gt;有了 Threat Modeling 可以看到
      
    
    </summary>
    
    
      <category term="Microsoft Threat Modeling Tool" scheme="https://rainmakerho.github.io/tags/Microsoft-Threat-Modeling-Tool/"/>
    
      <category term="STRIDE" scheme="https://rainmakerho.github.io/tags/STRIDE/"/>
    
      <category term="威脅模型" scheme="https://rainmakerho.github.io/tags/%E5%A8%81%E8%84%85%E6%A8%A1%E5%9E%8B/"/>
    
  </entry>
  
  <entry>
    <title>SQL Replace 後，怎麼會留空白呢?</title>
    <link href="https://rainmakerho.github.io/2019/06/12/2019015/"/>
    <id>https://rainmakerho.github.io/2019/06/12/2019015/</id>
    <published>2019-06-12T05:49:14.000Z</published>
    <updated>2019-06-12T07:35:21.790Z</updated>
    
    <content type="html"><![CDATA[<h3 id="問題"><a href="#問題" class="headerlink" title="問題"></a>問題</h3><p>最近客戶將 SQL Server 從 SQL 2012 升級到 SQL 2016 後，有些 Store Procedure 居然發生了錯誤。<br>結果發現，原本在 SQL 2012 中去 Replace 後，原本後面有空字串的會一併 RTrim 掉，但在 SQL 2016 中，那些空白就會留著。</p><p>怎麼會這樣子呢? 查看官方文件中，這個行為在 SQL 2008 之後就是如此了呀~<br><a href="https://docs.microsoft.com/en-us/previous-versions/sql/sql-server-2008/ms143359(v=sql.100)#replace-function" target="_blank" rel="noopener">Behavior Changes to Database Engine Features in SQL Server 2008 - REPLACE Function</a></p><blockquote><p>In SQL Server 2005, trailing spaces specified in the first input parameter to the REPLACE function are trimmed when the parameter is of type char. For example, in the statement SELECT ‘&lt;’ + REPLACE(CONVERT(char(6), ‘ABC ‘), ‘ ‘, ‘L’) + ‘&gt;’, the value ‘ABC ‘ is incorrectly evaluated as ‘ABC’.</p></blockquote><blockquote><p>In SQL Server 2008, trailing spaces are always preserved. For applications that rely on the previous behavior of the function, use the RTRIM function when specifying the first input parameter for the function. For example, the following syntax will reproduce the SQL Server 2005 behavior SELECT ‘&lt;’ + REPLACE(RTRIM(CONVERT(char(6), ‘ABC ‘)), ‘ ‘, ‘L’) + ‘&gt;’.</p></blockquote><p>也就是說，SQL 2008 之後，如果要將 Replace 後的空字串 Trim 掉，請自已加一下 RTRIM !!!</p><p>嗯，不過，我們的現況是 SQL 2012 跟 SQL 2016 ，這到底是怎麼回事呢?</p><h3 id="研究"><a href="#研究" class="headerlink" title="研究"></a>研究</h3><p>結果透過 SSMS 來看資料庫，發現 SQL 2012 的那個資料庫，相容性層級設定的是 SQL 2005，而 SQL 2016 最底的相容性層級只到 SQL 2008。所以才在 SQL 2016 上才發生這樣子的錯誤。</p><p>即然知道問題了，就要看怎麼解了。<br>依官網來說，程式就給它改下去吧，可能要盤點一下有那些 Store Procedure 有影響吧。</p><p>另一個解法是設定 <a href="https://docs.microsoft.com/en-us/sql/t-sql/statements/set-ansi-padding-transact-sql?view=sql-server-2017" target="_blank" rel="noopener">ANSI_PADDING</a> 為 OFF (預設為 ON)。<br>如果目前使用 Replace 是因為遇到了 Char 資料型態，可以在運算之前，設定 <a href="https://docs.microsoft.com/en-us/sql/t-sql/statements/set-ansi-padding-transact-sql?view=sql-server-2017" target="_blank" rel="noopener">ANSI_PADDING</a> 為 OFF，這樣子就不會把空字串加上去了。<br>例如，</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> [dbo].[table1] (</span><br><span class="line">    [<span class="keyword">id</span>]        TINYINT       <span class="keyword">IDENTITY</span> (<span class="number">1</span>, <span class="number">1</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    [char1]     <span class="built_in">CHAR</span> (<span class="number">10</span>)     <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    [nchar2]    <span class="keyword">NCHAR</span> (<span class="number">10</span>)    <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    [varchar1]  <span class="built_in">VARCHAR</span> (<span class="number">10</span>)  <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    [<span class="keyword">nvarchar2</span>] <span class="keyword">NVARCHAR</span> (<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">truncate</span> <span class="keyword">table</span> table1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> [dbo].[table1]([char1], [nchar2], [varchar1], [<span class="keyword">nvarchar2</span>])</span><br><span class="line"><span class="keyword">values</span> (<span class="string">'char1'</span>, N<span class="string">'nchar2'</span>, <span class="string">'varchar1'</span>, N<span class="string">'nvarchar2'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 預設是 SET ANSI_PADDING ON</span></span><br><span class="line"><span class="comment">-- 所以 char1 欄位 replace 後，會留有空白哦!</span></span><br><span class="line"><span class="keyword">SET</span> ANSI_PADDING <span class="keyword">ON</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="string">'['</span> + char1 + <span class="string">']'</span> <span class="keyword">as</span> char1,</span><br><span class="line"><span class="string">'['</span> + <span class="keyword">replace</span>(char1, <span class="string">'char'</span>, <span class="string">'rm'</span>) + <span class="string">']'</span> <span class="keyword">as</span> char1_replace ,</span><br><span class="line"><span class="string">'['</span> + nchar2 + <span class="string">']'</span> <span class="keyword">as</span> nchar2,</span><br><span class="line">N<span class="string">'['</span> + <span class="keyword">replace</span>(nchar2, N<span class="string">'char'</span>, N<span class="string">'rm'</span>) + N<span class="string">']'</span> <span class="keyword">as</span> nchar2_replace,</span><br><span class="line"><span class="string">'['</span> + varchar1 + <span class="string">']'</span> <span class="keyword">as</span> varchar1,</span><br><span class="line"><span class="string">'['</span> + <span class="keyword">replace</span>(varchar1, <span class="string">'char'</span>, <span class="string">'rm'</span>) + <span class="string">']'</span> <span class="keyword">as</span> varchar1_replace,</span><br><span class="line"><span class="string">'['</span> + <span class="keyword">nvarchar2</span> + <span class="string">']'</span> <span class="keyword">as</span> <span class="keyword">nvarchar2</span>,</span><br><span class="line">N<span class="string">'['</span> + <span class="keyword">replace</span>(<span class="keyword">nvarchar2</span>, N<span class="string">'char'</span>, N<span class="string">'rm'</span>) + N<span class="string">']'</span> <span class="keyword">as</span> nvarchar2_replace</span><br><span class="line"><span class="keyword">from</span> table1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> ANSI_PADDING <span class="keyword">off</span>;</span><br><span class="line"><span class="comment">-- 所以 char1 欄位 replace 後，會不會有空白了哦~</span></span><br><span class="line"><span class="keyword">select</span> <span class="string">'['</span> + char1 + <span class="string">']'</span> <span class="keyword">as</span> char1,</span><br><span class="line"><span class="string">'['</span> + <span class="keyword">replace</span>(char1, <span class="string">'char'</span>, <span class="string">'rm'</span>) + <span class="string">']'</span> <span class="keyword">as</span> char1_replace ,</span><br><span class="line"><span class="string">'['</span> + nchar2 + <span class="string">']'</span> <span class="keyword">as</span> nchar2,</span><br><span class="line">N<span class="string">'['</span> + <span class="keyword">replace</span>(nchar2, N<span class="string">'char'</span>, N<span class="string">'rm'</span>) + N<span class="string">']'</span> <span class="keyword">as</span> nchar2_replace,</span><br><span class="line"><span class="string">'['</span> + varchar1 + <span class="string">']'</span> <span class="keyword">as</span> varchar1,</span><br><span class="line"><span class="string">'['</span> + <span class="keyword">replace</span>(varchar1, <span class="string">'char'</span>, <span class="string">'rm'</span>) + <span class="string">']'</span> <span class="keyword">as</span> varchar1_replace,</span><br><span class="line"><span class="string">'['</span> + <span class="keyword">nvarchar2</span> + <span class="string">']'</span> <span class="keyword">as</span> <span class="keyword">nvarchar2</span>,</span><br><span class="line">N<span class="string">'['</span> + <span class="keyword">replace</span>(<span class="keyword">nvarchar2</span>, N<span class="string">'char'</span>, N<span class="string">'rm'</span>) + N<span class="string">']'</span> <span class="keyword">as</span> nvarchar2_replace</span><br><span class="line"><span class="keyword">from</span> table1;</span><br></pre></td></tr></table></figure><p>執行結果如下，<br><img src="/2019/06/12/2019015/001.png" title="ANSI_PADDING on/off 比較"><br>可以看到上面 ANSI_PADDING ON 時，Replace 後是有空白的，Off 之後 char1 欄位是沒有空白的。<br>但對於 NCHAR 的資料型態是沒有改變的哦!</p><p>所以，如果您在 Replace 遇到的問題是 CHAR ，那您可以在執行 SQL 之前，先去下</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> ANSI_PADDING <span class="keyword">OFF</span></span><br><span class="line"><span class="comment">-- 你原本的SQL</span></span><br></pre></td></tr></table></figure><p>依據大多數系統大多會將執行 SQL 的部份抽出來，所以目前您可以在那先去設定 ANSI_PADDING OFF。</p><ul><li>請注意 NCHAR ， ANSI_PADDING 固定會是 ON 的哦! 所以設定 SET ANSI_PADDING OFF 只針對 CHAR 有效果哦!</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;問題&quot;&gt;&lt;a href=&quot;#問題&quot; class=&quot;headerlink&quot; title=&quot;問題&quot;&gt;&lt;/a&gt;問題&lt;/h3&gt;&lt;p&gt;最近客戶將 SQL Server 從 SQL 2012 升級到 SQL 2016 後，有些 Store Procedure 居然發生了錯誤。
      
    
    </summary>
    
    
      <category term="sql" scheme="https://rainmakerho.github.io/tags/sql/"/>
    
      <category term="sql 2016" scheme="https://rainmakerho.github.io/tags/sql-2016/"/>
    
      <category term="sql 2005" scheme="https://rainmakerho.github.io/tags/sql-2005/"/>
    
      <category term="sql 2008" scheme="https://rainmakerho.github.io/tags/sql-2008/"/>
    
      <category term="replace" scheme="https://rainmakerho.github.io/tags/replace/"/>
    
      <category term="rtrim" scheme="https://rainmakerho.github.io/tags/rtrim/"/>
    
  </entry>
  
  <entry>
    <title>使用 NPOI.HSSF.UserModel.HSSFSheet.CopyRow 造成 IIS 應用程式重啟問題</title>
    <link href="https://rainmakerho.github.io/2019/06/04/2019014/"/>
    <id>https://rainmakerho.github.io/2019/06/04/2019014/</id>
    <published>2019-06-04T02:09:26.000Z</published>
    <updated>2019-06-20T02:41:23.407Z</updated>
    
    <content type="html"><![CDATA[<h3 id="環境"><a href="#環境" class="headerlink" title="環境"></a>環境</h3><p>Windows 2012 R2, IIS, NPOI v2.1.1.0<br>.net 3.x , 應用程式集區為 32 位元</p><h3 id="問題"><a href="#問題" class="headerlink" title="問題"></a>問題</h3><p>最近同事在一台 Windows 2012 R2 上安裝系統，把 8 個 iis 的應用程式放在同一個應用程式集區之中。<br>其中一個應用程式中，有使用到 NOPI 去產生 Excel 報表。<br>那個報表是依 DataTable 將資料 Loop 放到 Excel 之中，但神奇的是，程式在執行到一半，卻會讓那個應用程式集區直接重啟。<br>而事件檢視器之中就只有「失敗的應用程式名稱: w3wp.exe，版本: 8.5.9600.16384，時間戳記: 0x52157ba0」的錯誤，如下，<br><img src="/2019/06/04/2019014/001.png" title="w3wp.exe錯誤"></p><h3 id="研究"><a href="#研究" class="headerlink" title="研究"></a>研究</h3><p>因為是 w3wp.exe 直接重啟，所以就透過 <a href="https://www.microsoft.com/en-us/download/details.aspx?id=58210" target="_blank" rel="noopener">Debug Diagnostic Tool</a>來收集 IIS 的 Crash 資料，所以先透過 DebugDiag 2 Collection 來收集發生錯誤時，將 Stack Trace Log 起來，如下，<br><img src="/2019/06/04/2019014/002.png" title="DebugDiag 2 Collection"></p><p>最後發現，應用程式集區重啟後，的確產生 2 個不同 Process 的 Log 檔，如下，<br><img src="/2019/06/04/2019014/003.png" title="DebugDiag Log File"></p><p>查看最後的 Log 是掛在 NPOI 的 NPOI.HSSF.UserModel.HSSFRow.get_Cells ，如下，</p><blockquote><p>0e5fd908 759c89f2 [HelperMethodFrame_PROTECTOBJ: 0e5fd908] System.Delegate.DelegateConstruct(System.Object, IntPtr)<br>0e5fdaf0 67511c77 System.Collections.Generic.SortedDictionary<code>2+ValueCollection[[System.Int32, mscorlib],[System.__Canon, mscorlib]].CopyTo(System.__Canon[], Int32) 0e5fdb18 6f537a25 System.Collections.Generic.List</code>1[[System.__Canon, mscorlib]]..ctor(System.Collections.Generic.IEnumerable`1&lt;System.__Canon&gt;)<br>0e5fdb50 1ce64bbe NPOI.HSSF.UserModel.HSSFRow.get_Cells()<br>0e5fdb60 1ce64a91 NPOI.HSSF.UserModel.HSSFSheet.NotifyRowShifting(NPOI.HSSF.UserModel.HSSFRow)<br>0e5fdba8 1ce64016 NPOI.HSSF.UserModel.HSSFSheet.ShiftRows(Int32, Int32, Int32, Boolean, Boolean, Boolean)<br>0e5fdc38 1ce63f14 NPOI.HSSF.UserModel.HSSFSheet.ShiftRows(Int32, Int32, Int32)<br>0e5fdc44 1ce628e2 NPOI.SS.Util.SheetUtil.CopyRow(NPOI.SS.UserModel.ISheet, Int32, Int32)<br>0e5fdc70 1ce6281a NPOI.HSSF.UserModel.HSSFSheet.CopyRow(Int32, Int32)</p></blockquote><p>如果將錯誤改成 dump 檔的話，然後再透過 DebugDiag Analysis 來分析，主要錯誤如下，</p><blockquote><p>ntdll!NtWaitForSingleObject+c<br>KERNELBASE!WaitForSingleObjectEx+99<br>mscorwks!CLREventWaitHelper+2f<br>mscorwks!CLREvent::WaitEx+117<br>mscorwks!CLREvent::Wait+17<br>mscorwks!ThreadpoolMgr::SafeWait+73<br>mscorwks!ThreadpoolMgr::WorkerThreadStart+11c<br>mscorwks!Thread::intermediateThreadProc+49<br>kernel32!BaseThreadInitThunk+24<br>ntdll!__RtlUserThreadStart+2f<br>ntdll!_RtlUserThreadStart+1b</p></blockquote><p>而它的錯誤點，就指到了上述 NPOI 的錯誤。</p><p>在沒什麼想法時，想說將那個有錯誤的應用程式，放到一個單獨使用的應用程式集區之中，比較好分析。<br>於是將它放過去之後，錯誤也隨之不見了。<br>再將它放在一起，錯誤又出現了。 @_@</p><h3 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h3><p>新增一個新的應用程式集區，然後讓那個會出錯的應用程式使用，再測試一次程式，居然就不會有問題了。<br>或許也可以更新 NPOI 版本到較新的版本試看看。</p><p>大家有其他的想法嗎? 歡迎提供出來討論哦 :)</p><ul><li>2019/06/20 Update<ul><li>有同事也遇到一樣的問題，但如果將 Application Pool 改成 x64 的話，就沒有問題。</li></ul></li></ul><h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><p><a href="https://stackify.com/troubleshoot-w3wp-crash/" target="_blank" rel="noopener">How to Troubleshoot an ASP.NET Crash &amp; Analyze w3wp Crash Dumps</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;環境&quot;&gt;&lt;a href=&quot;#環境&quot; class=&quot;headerlink&quot; title=&quot;環境&quot;&gt;&lt;/a&gt;環境&lt;/h3&gt;&lt;p&gt;Windows 2012 R2, IIS, NPOI v2.1.1.0&lt;br&gt;.net 3.x , 應用程式集區為 32 位元&lt;/p&gt;
&lt;h
      
    
    </summary>
    
    
      <category term="IIS" scheme="https://rainmakerho.github.io/tags/IIS/"/>
    
      <category term="NPOI" scheme="https://rainmakerho.github.io/tags/NPOI/"/>
    
      <category term="Windows 2012" scheme="https://rainmakerho.github.io/tags/Windows-2012/"/>
    
      <category term="Crash" scheme="https://rainmakerho.github.io/tags/Crash/"/>
    
      <category term="Application Pool" scheme="https://rainmakerho.github.io/tags/Application-Pool/"/>
    
  </entry>
  
  <entry>
    <title>NullReferenceException 在 new class 時?</title>
    <link href="https://rainmakerho.github.io/2019/05/28/2019013/"/>
    <id>https://rainmakerho.github.io/2019/05/28/2019013/</id>
    <published>2019-05-28T07:35:49.000Z</published>
    <updated>2019-05-30T07:30:32.346Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>最近同事詢問一個很奇怪的問題，在執行程式時會跳「System.NullReferenceException: 並未將物件參考設定為物件的執行個體。」的錯誤。但它錯誤的行號卻是在 new 一個 POCO 的 Class 。錯誤訊息如下，</p><blockquote><p>System.NullReferenceException: 並未將物件參考設定為物件的執行個體。<br>於 xxx.Controllers.rmController.rmAction(String num) 於 D:xxx\Controllers\rmController.cs: 行 482<br>於 lambda_method(Closure , ControllerBase , Object[] )<br>於 System.Web.Mvc.ReflectedActionDescriptor.Execute(ControllerContext controllerContext, IDictionary<code>2 parameters) 於 System.Web.Mvc.ControllerActionInvoker.InvokeActionMethod(ControllerContext controllerContext, ActionDescriptor actionDescriptor, IDictionary</code>2 parameters)</p></blockquote><p>而在 Server 端的錯誤黃畫面中，原始碼程式錯誤，卻沒有明確顯示出錯誤的程式碼，如下，<br><img src="/2019/05/28/2019013/001.png" title="[Error Page]"></p><h3 id="測試"><a href="#測試" class="headerlink" title="測試"></a>測試</h3><p>Controller 的程式碼如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ActionResult <span class="title">rmAction</span>(<span class="params"><span class="keyword">string</span> num</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> model = <span class="keyword">new</span> rmModel(); <span class="comment">//這裡是 482 行</span></span><br><span class="line">    <span class="comment">// check transfer data</span></span><br><span class="line">    <span class="keyword">bool</span> hasData = <span class="keyword">this</span>.rmBLL.HasTransferToData(<span class="keyword">this</span>.CompanyId, num);</span><br><span class="line">    <span class="comment">// ... 其他程式碼</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>跟同事 Garry, Leo 一直想不透 new 一個 POCO 的 Class，怎麼可能會噴 NullReferenceException。<br>於是使用了各種方式來測試，例如直接在 View 或是直接建立 aspx 去測試，都不會錯誤。<br>後來同事將下一行的程式碼，也搬到 View 及 aspx 去試，錯誤就在正確的地方噴錯。<br>原來不是那個 new 錯誤，而是下一行的所造成的錯誤。<br>所以下次有類似的問題，可以試著將程式碼搬到 View or aspx 去測試，或許可以加快查問題的速度。<br>aspx 的 inline code 方式，我在 Debug 時蠻長使用的，因為直接新增一支 aspx 然後寫程式碼就可以驗證了。<br>808dk 的範例如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ Import Namespace=<span class="string">"System"</span> %&gt;</span><br><span class="line">&lt;%@ Page Language=<span class="string">"c#"</span>%&gt;</span><br><span class="line"></span><br><span class="line">&lt;script runat=<span class="string">"server"</span>&gt;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">ServerSideFunction</span>(<span class="params"><span class="keyword">string</span> input</span>)</span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"Hello "</span> + input;</span><br><span class="line">  &#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;% <span class="keyword">string</span> pageVariable = <span class="string">"world"</span>; %&gt;</span><br><span class="line">&lt;!DOCTYPE html PUBLIC <span class="string">"-//W3C//DTD XHTML 1.0 Transitional//EN"</span></span><br><span class="line">    <span class="string">"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"</span>&gt;</span><br><span class="line">&lt;html xmlns=<span class="string">"http://www.w3.org/1999/xhtml"</span> xml:lang=<span class="string">"en"</span> lang=<span class="string">"en"</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta http-equiv=<span class="string">"Content-Type"</span> content=<span class="string">"text/html; charset=windows-1252"</span> /&gt;</span><br><span class="line">&lt;title&gt;ASP.NET inline&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;% =ServerSideFunction(pageVariable) %&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ Import <span class="keyword">Namespace</span>=<span class="string">"System"</span> %&gt;</span><br><span class="line">&lt;%@ Page Language=<span class="string">"VB"</span> %&gt;</span><br><span class="line"></span><br><span class="line">&lt;script runat=<span class="string">"server"</span>&gt;</span><br><span class="line">  <span class="keyword">Public</span> <span class="keyword">Function</span> ServerSideFunction(input <span class="keyword">As</span> <span class="built_in">String</span>) <span class="keyword">As</span> <span class="built_in">String</span></span><br><span class="line">    ServerSideFunction = <span class="string">"Hello "</span> &amp; input</span><br><span class="line">  <span class="keyword">End</span> <span class="keyword">Function</span></span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;% <span class="keyword">Dim</span> pageVariable <span class="keyword">As</span> <span class="built_in">String</span> = <span class="string">"world"</span> %&gt;</span><br><span class="line">&lt;!DOCTYPE html <span class="keyword">PUBLIC</span> <span class="string">"-//W3C//DTD XHTML 1.0 Transitional//EN"</span></span><br><span class="line">    <span class="string">"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"</span>&gt;</span><br><span class="line">&lt;html xmlns=<span class="string">"http://www.w3.org/1999/xhtml"</span> xml:lang=<span class="string">"en"</span> lang=<span class="string">"en"</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta http-equiv=<span class="string">"Content-Type"</span> content=<span class="string">"text/html; charset=windows-1252"</span> /&gt;</span><br><span class="line">&lt;title&gt;ASP.NET inline&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;% =ServerSideFunction(pageVariable) %&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><h3 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h3><p>從這例子中，可以發現，原來錯誤的行號也會騙人(如果 pdb 不對的話，行號或許也會不同)。<br>同一包建置出來的程式在 Local 或公司執行都沒有問題，部署到客戶端就噴錯，一度懷疑是否 web.config 有什麼差異。<br>最後同事以插旗子的方式去驗證不是掛在 new class 的地方。<br>將程式放到 aspx inline code 的方式，也是幫助我們快速找到問題的一個方式哦!</p><h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><p><a href="http://www.808.dk/?code-aspnet-inline" target="_blank" rel="noopener">Using inline code in ASP.NET (C# and VB.Net)</a></p><p>非常感謝同事 Garry, Leo 的分享</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;最近同事詢問一個很奇怪的問題，在執行程式時會跳「System.NullReferenceException: 並未將物件參考設定為物件的執行
      
    
    </summary>
    
    
      <category term="NullReferenceException" scheme="https://rainmakerho.github.io/tags/NullReferenceException/"/>
    
      <category term="ASP.NET MVC" scheme="https://rainmakerho.github.io/tags/ASP-NET-MVC/"/>
    
      <category term="Controller" scheme="https://rainmakerho.github.io/tags/Controller/"/>
    
      <category term="lambda_method" scheme="https://rainmakerho.github.io/tags/lambda-method/"/>
    
  </entry>
  
  <entry>
    <title>在目前的命令上發生嚴重錯誤。如果有任何結果，都必須捨棄。</title>
    <link href="https://rainmakerho.github.io/2019/05/24/2019012/"/>
    <id>https://rainmakerho.github.io/2019/05/24/2019012/</id>
    <published>2019-05-24T06:57:16.000Z</published>
    <updated>2019-05-24T07:32:16.904Z</updated>
    
    <content type="html"><![CDATA[<h3 id="環境"><a href="#環境" class="headerlink" title="環境"></a>環境</h3><p>SQL 2017(14.0.3103.1), Windows 2016 STD</p><h3 id="錯誤訊息"><a href="#錯誤訊息" class="headerlink" title="錯誤訊息"></a>錯誤訊息</h3><blockquote><p>訊息 596，層級 21，狀態 1，行 0<br>工作階段為清除狀態，無法繼續執行。</p></blockquote><blockquote><p>訊息 0，層級 20，狀態 0，行 0<br>在目前的命令上發生嚴重錯誤。如果有任何結果，都必須捨棄。</p></blockquote><blockquote><p>訊息 0，層級 11，狀態 0，行 0<br>在目前的命令上發生嚴重錯誤。如果有任何結果，都必須捨棄。</p></blockquote><blockquote><p>Msg 0, Level 20, State 0, Line 0<br>A severe error occurred on the current command.<br>The results, if any, should be discarded</p></blockquote><h3 id="測試的-SQL"><a href="#測試的-SQL" class="headerlink" title="測試的 SQL"></a>測試的 SQL</h3><p>這個狀況主要是有 Table-valued Functions, variable, view 加 if 所造成的問題，如下，</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--空的內容，主要測試使用</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">function</span> [dbo].[ufn_test3]()</span><br><span class="line"><span class="keyword">returns</span> @<span class="keyword">result</span> <span class="keyword">table</span></span><br><span class="line">(</span><br><span class="line">      TenantID <span class="built_in">int</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">as</span></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line">GO</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--定義一個變數</span></span><br><span class="line"><span class="keyword">DECLARE</span> @ORG_TYPE <span class="built_in">VARCHAR</span>(<span class="number">4</span>);</span><br><span class="line"><span class="comment">--執行 Table-valued Functions</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> [ufn_test3]();</span><br><span class="line">IF @ORG_TYPE = 'RMOK'</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">SELECT</span> <span class="keyword">count</span>(*) <span class="keyword">as</span> a</span><br><span class="line">  <span class="keyword">FROM</span> [EMP_RMOK]</span><br><span class="line">  <span class="keyword">WHERE</span> PER_SERIL_NO = <span class="string">'7'</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure><h3 id="解決方式"><a href="#解決方式" class="headerlink" title="解決方式"></a>解決方式</h3><p>感覺是否為 DB 的問題，做了 DBCC CHECKDB, 也沒有錯誤。<br>將原本那個 View 改建立另一個名稱，也不會有錯誤，但用原本的 View 的名稱就是會噴錯。<br>請同事將 Windows 更新跑一跑再重開機試看看，<br>如果沒有效果的話，以下是暫時的解決方式。</p><p>測試了幾次後，發現如果沒有 if 也不會有錯誤，於是先將變數設定一個初始值。</p><blockquote><p>DECLARE @ORG_TYPE VARCHAR(4);<br>改成<br>DECLARE @ORG_TYPE VARCHAR(4) = ‘’;<br>或是<br>DECLARE @ORG_TYPE VARCHAR(4);<br>SET @ORG_TYPE = ’’;</p></blockquote><p>就不會有那個問題發生了:)</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;環境&quot;&gt;&lt;a href=&quot;#環境&quot; class=&quot;headerlink&quot; title=&quot;環境&quot;&gt;&lt;/a&gt;環境&lt;/h3&gt;&lt;p&gt;SQL 2017(14.0.3103.1), Windows 2016 STD&lt;/p&gt;
&lt;h3 id=&quot;錯誤訊息&quot;&gt;&lt;a href=&quot;#錯誤
      
    
    </summary>
    
    
      <category term="mssql 2017" scheme="https://rainmakerho.github.io/tags/mssql-2017/"/>
    
      <category term="table function" scheme="https://rainmakerho.github.io/tags/table-function/"/>
    
      <category term="if" scheme="https://rainmakerho.github.io/tags/if/"/>
    
      <category term="variable" scheme="https://rainmakerho.github.io/tags/variable/"/>
    
  </entry>
  
  <entry>
    <title>推薦學習前端的好網站-Scrimba</title>
    <link href="https://rainmakerho.github.io/2019/05/14/2019011/"/>
    <id>https://rainmakerho.github.io/2019/05/14/2019011/</id>
    <published>2019-05-14T02:11:16.000Z</published>
    <updated>2019-05-14T02:47:43.411Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>最近使用 React 來寫一個簡單的頁面，從 <a href="https://facebook.github.io/create-react-app/docs/getting-started" target="_blank" rel="noopener">Facebook Create React App</a>開始，建立一個專案，就開始了 ReactJS 之旅。</p><h3 id="部署問題"><a href="#部署問題" class="headerlink" title="部署問題"></a>部署問題</h3><p>當透過 npm run build 產生部署的檔案後，放到 IIS 的虛擬目錄之中，立馬噴 404 ，找不到 js 。<br>原來 react 預設是在根目錄，如果要使用相對路徑的話，需要在 package.json 中設定 homepage 的值，如下，</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">"homepage": "./"</span><br></pre></td></tr></table></figure><p>詳細可以參考 <a href="https://facebook.github.io/create-react-app/docs/deployment" target="_blank" rel="noopener">React Deployment</a>。<br>可別以為每次搬程式都需要重 Build 一次哦 :)</p><h3 id="jsx-state-props-傻傻分不清"><a href="#jsx-state-props-傻傻分不清" class="headerlink" title="jsx, state, props 傻傻分不清"></a>jsx, state, props 傻傻分不清</h3><p>因為預設是使用 jsx ，所以常常在 {} 物件之間搞不清楚，常常噴錯，就上網去相關的問題來解決。</p><h3 id="Scrimba"><a href="#Scrimba" class="headerlink" title="Scrimba"></a>Scrimba</h3><p>雖然 react 蠻好入手的，但有一些基本的功還是需要學習的，在<a href="https://scrimba.com/g/glearnreact" target="_blank" rel="noopener">Scrimba react</a>中，除了它是免費的之外，它的 UI 本身就是可以讓學習者直接寫 Code 的 IDE。<br>而講師也常常說到一段，就停下來要我們去練習看看，然後再對照講師所寫的程式碼，學習上真的很方便。<br>而在 react 課程式，內容是從一個簡單的 ReactDOM.render 開始練習，從 function component 到 class component ，從小到大到拆分到別的 class，也有點到寫 Code 上需要注意的問題。<br>真的非常推薦，快上 <a href="https://scrimba.com/" target="_blank" rel="noopener">Scrimba</a> 好好學習吧 :)</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;最近使用 React 來寫一個簡單的頁面，從 &lt;a href=&quot;https://facebook.github.io/create-reac
      
    
    </summary>
    
    
      <category term="react" scheme="https://rainmakerho.github.io/tags/react/"/>
    
      <category term="scrimba" scheme="https://rainmakerho.github.io/tags/scrimba/"/>
    
      <category term="javascript" scheme="https://rainmakerho.github.io/tags/javascript/"/>
    
      <category term="vue" scheme="https://rainmakerho.github.io/tags/vue/"/>
    
      <category term="css" scheme="https://rainmakerho.github.io/tags/css/"/>
    
  </entry>
  
  <entry>
    <title>OpenTracing - Jaeger 接 Elastic Stack</title>
    <link href="https://rainmakerho.github.io/2019/04/02/2019010/"/>
    <id>https://rainmakerho.github.io/2019/04/02/2019010/</id>
    <published>2019-04-02T08:41:01.000Z</published>
    <updated>2019-04-02T10:10:43.659Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>當我們直接跑 jaeger-all-in-one 時，預設將資料放在 memory 之中。<br>如果要長期監控的話，我們可以將資料存起來。<br>所以我們就將資料放到 Elasticsearch 之中。</p><h3 id="實作"><a href="#實作" class="headerlink" title="實作"></a>實作</h3><p>我們可以參考 <a href="http://gigi.nullneuron.net/gigilabs/setting-up-elasticsearch-and-kibana-on-windows/" target="_blank" rel="noopener">SETTING UP ELASTICSEARCH AND KIBANA ON WINDOWS</a>就可以了，如下，</p><h4 id="安裝-Java-Runtime-Environment-JRE"><a href="#安裝-Java-Runtime-Environment-JRE" class="headerlink" title="安裝 Java Runtime Environment (JRE)"></a>安裝 Java Runtime Environment (JRE)</h4><p>請到 <a href="https://www.oracle.com/technetwork/java/javase/downloads/jre8-downloads-2133155.html" target="_blank" rel="noopener">Java SE Runtime Environment 8 Downloads</a> 下載，筆者是下載 Java SE Runtime Environment 8u201 來安裝。<br>安裝完成後，檔案會放在 C:\Program Files\Java\jre1.8.0_201 。</p><h5 id="設定-Java-環境變數"><a href="#設定-Java-環境變數" class="headerlink" title="設定 Java 環境變數"></a>設定 Java 環境變數</h5><p>請設定環境變數 JAVA_HOME 為 C:\Program Files\Java\jre1.8.0_201 (依您安裝的路徑)。<br>並將 C:\Program Files\Java\jre1.8.0_201\bin 加入到 Path 之中 (請注意，在 Path 之中是否有別的 Java 路徑)。<br><img src="/2019/04/02/2019010/001.png" title="[Java Home]"></p><p>在 Command 執行 java -version 看看是否為安裝的版本，<br><img src="/2019/04/02/2019010/002.png" title="[Check Java Version]"></p><h4 id="安裝-Elasticsearch"><a href="#安裝-Elasticsearch" class="headerlink" title="安裝 Elasticsearch"></a>安裝 Elasticsearch</h4><h5 id="下載及安裝-Elasticsearch-6-7-0"><a href="#下載及安裝-Elasticsearch-6-7-0" class="headerlink" title="下載及安裝 Elasticsearch 6.7.0"></a>下載及安裝 Elasticsearch 6.7.0</h5><p>請到 <a href="https://www.elastic.co/cn/downloads/elasticsearch" target="_blank" rel="noopener">Elasticsearch 官網下載網頁</a>，我的環境是 Windows ，所以我下載 MSI 檔來安裝。因為我是在本機上測試，所以安裝過程中，我不以 service 方式啟動。安裝完成後，程式會放在 C:\Program Files\Elastic\Elasticsearch\6.7.0 路徑(因為我裝的是 6.7.0 版本)，而設定及 Log 則放在 C:\ProgramData\Elastic\Elasticsearch 路徑。<br><img src="/2019/04/02/2019010/003.png" title="[Elasticsearch install path]"></p><h5 id="執行-Elasticsearch"><a href="#執行-Elasticsearch" class="headerlink" title="執行 Elasticsearch"></a>執行 Elasticsearch</h5><p>開啟 Command 視窗，cd 到 C:\Program Files\Elastic\Elasticsearch\6.7.0\bin 目錄，執行 elasticsearch ，如下，<br><img src="/2019/04/02/2019010/004.png" title="[Run elasticsearch.exe]"></p><p>再開啟瀏覽器，在網址列輸入 <a href="http://localhost:9200/" target="_blank" rel="noopener">http://localhost:9200/</a> 看看是否有正常的顯示資料。<br><img src="/2019/04/02/2019010/005.png" title="[Check Elasticsearch]"></p><h4 id="安裝-Kibana"><a href="#安裝-Kibana" class="headerlink" title="安裝 Kibana"></a>安裝 Kibana</h4><h5 id="下載及安裝-Kibana"><a href="#下載及安裝-Kibana" class="headerlink" title="下載及安裝 Kibana"></a>下載及安裝 Kibana</h5><p>請到 <a href="https://www.elastic.co/cn/downloads/kibana" target="_blank" rel="noopener">Kibana 官網下載網頁</a>，下載 Windows 平台的 zip 檔案。<br>下載完成後，請解壓縮到 C:\Program Files\Elastic 目錄，如下，<br><img src="/2019/04/02/2019010/006.png" title="[install kibana]"></p><h5 id="執行-Kibana"><a href="#執行-Kibana" class="headerlink" title="執行 Kibana"></a>執行 Kibana</h5><p>開啟 Command 視窗，cd 到 C:\Program Files\Elastic\kibana\kibana-6.7.0-windows-x86_64\bin 目錄，執行 kibana.bat ，如下，<br><img src="/2019/04/02/2019010/007.png" title="[Run kibana.bat]"><br>註:如果 Elasticsearch 在別台的話，請更改 C:\Program Files\Elastic\kibana\kibana-6.7.0-windows-x86_64\config\kibana.yml 中 elasticsearch.hosts 的設定值。</p><p>再開啟瀏覽器，在網址列輸入 <a href="http://localhost:5601/" target="_blank" rel="noopener">http://localhost:5601/</a> 看看是否有正常的顯示資料。<br><img src="/2019/04/02/2019010/008.png" title="[Check Kibana]"></p><h4 id="設定-Jaeger"><a href="#設定-Jaeger" class="headerlink" title="設定 Jaeger"></a>設定 Jaeger</h4><p>Elasticsearch 正常執行後，就可以開啟 Command 視窗，執行 jaeger-all-in-one.exe ，設定 span-storage.type 為 elasticsearch，如下，</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jaeger-all-in-one --collector.zipkin.http-port=9411 --span-storage.type=elasticsearch --es.server-urls=http://localhost:9200/ --es.tags-as-fields.all=true</span><br></pre></td></tr></table></figure><p>當然，如果分別執行 jaeger-collector.exe 及 jaeger-query.exe 也可以哦!</p><p>當服務都起來後，啟動 訂便當 Bot 來測試，然後到 Kibana 建立 Index (Management -&gt; Kibana -&gt; Index Patterns)，我們可以建立 jaeger-span-* ，如下，<br><img src="/2019/04/02/2019010/009.png" title="[create Index]"></p><img src="/2019/04/02/2019010/010.png" title="[create Index with timeFilter]"><p>再點選 Discover ，如果目前沒有資料的話，可以點右上方設定查詢的時間，<br><img src="/2019/04/02/2019010/011.png" title="[Discover]"></p><p>設定時間區間後，就可以看到從 Jaeger 送進來的資料，如下，<br><img src="/2019/04/02/2019010/012.png" title="[Discover jaeger-span-* Data]"></p><p>如果測試沒問題的話，就可以將它們設定為 Service 。</p><p>測試過程中，感謝 George 同事的幫忙。</p><h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><p><a href="http://gigi.nullneuron.net/gigilabs/setting-up-elasticsearch-and-kibana-on-windows/" target="_blank" rel="noopener">SETTING UP ELASTICSEARCH AND KIBANA ON WINDOWS</a><br><a href="https://hackmd.io/s/SytK_Y9HE#" target="_blank" rel="noopener">Elastic stack(安裝篇 via Docker)</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;當我們直接跑 jaeger-all-in-one 時，預設將資料放在 memory 之中。&lt;br&gt;如果要長期監控的話，我們可以將資料存起來。
      
    
    </summary>
    
    
      <category term="OpenTracing" scheme="https://rainmakerho.github.io/tags/OpenTracing/"/>
    
      <category term="Jaeger" scheme="https://rainmakerho.github.io/tags/Jaeger/"/>
    
      <category term="Elasticsearch" scheme="https://rainmakerho.github.io/tags/Elasticsearch/"/>
    
      <category term="Kibana" scheme="https://rainmakerho.github.io/tags/Kibana/"/>
    
  </entry>
  
  <entry>
    <title>document.[formName] is undefined</title>
    <link href="https://rainmakerho.github.io/2019/03/16/2019009/"/>
    <id>https://rainmakerho.github.io/2019/03/16/2019009/</id>
    <published>2019-03-16T05:48:31.000Z</published>
    <updated>2019-03-16T06:09:34.192Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>最近同時詢問一個 asp.net webform 系統從 .net framework 2.x 升到 .net 4.x 時，javascript 原本使用 document.formName 的物件，卻變成 undefined 而造成錯誤。</p><h3 id="研究與解決"><a href="#研究與解決" class="headerlink" title="研究與解決"></a>研究與解決</h3><p>到另一個沒有升級的版本去試，使用 document.formName 可以正常運作沒問題，但到 .net 4 的就是會變成 undefined。<br>於是檢查 Html 原始檔後發現， .net 4 的 Form 原本應該要有 name 屬性，卻不見了，只有 id 屬性。<br>而 .net 2.x 的 name 屬性有正常 Render 出來。</p><p>查看 <a href="https://docs.microsoft.com/en-us/aspnet/whitepapers/aspnet4/breaking-changes" target="_blank" rel="noopener">ASP.NET 4 Breaking Changes</a> ，原來預設 name 屬性是不會被 render 出來的，如果要讓 name 屬性 render 出來，要設定 pages 的 controlRenderingCompatibilityVersion 屬性，如下，</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">pages</span> <span class="attr">controlRenderingCompatibilityVersion</span>=<span class="string">"3.5"</span> /&gt;</span></span><br></pre></td></tr></table></figure><p>也要調整 requestValidationMode 為 2.0，如下，</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">httpRuntime</span> <span class="attr">requestValidationMode</span>=<span class="string">"2.0"</span> /&gt;</span></span><br></pre></td></tr></table></figure><p>當然，從舊版升級到新版的 .net 通常還要設定 xhtmlConformance 的 mode 屬性，有時升版後 js 變的怪怪的，可以 check 一下，設定成 Legacy 試看看哦! 如下，</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">xhtmlConformance</span> <span class="attr">mode</span>=<span class="string">"Legacy"</span> /&gt;</span></span><br></pre></td></tr></table></figure><h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><p><a href="https://docs.microsoft.com/en-us/aspnet/whitepapers/aspnet4/breaking-changes" target="_blank" rel="noopener">ASP.NET 4 Breaking Changes</a><br><a href="https://blogs.msdn.microsoft.com/rakkimk/2011/04/12/asp-net-form-tag-doesnt-have-name-attribute-xhtmlconformance/" target="_blank" rel="noopener">ASP.NET – Form tag doesn’t have “name” attribute – xhtmlConformance</a></p><blockquote><p>非常感謝同事 herman 的測試與回饋</p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;最近同時詢問一個 asp.net webform 系統從 .net framework 2.x 升到 .net 4.x 時，javascri
      
    
    </summary>
    
    
      <category term="軟體求生" scheme="https://rainmakerho.github.io/tags/%E8%BB%9F%E9%AB%94%E6%B1%82%E7%94%9F/"/>
    
      <category term="js" scheme="https://rainmakerho.github.io/tags/js/"/>
    
      <category term="document.formName" scheme="https://rainmakerho.github.io/tags/document-formName/"/>
    
      <category term="undefined" scheme="https://rainmakerho.github.io/tags/undefined/"/>
    
      <category term="asp.net 4" scheme="https://rainmakerho.github.io/tags/asp-net-4/"/>
    
      <category term="Legacy" scheme="https://rainmakerho.github.io/tags/Legacy/"/>
    
  </entry>
  
  <entry>
    <title>使用 OpenTracing - Jaeger (BFv3 使用 PostSharp)</title>
    <link href="https://rainmakerho.github.io/2019/03/11/2019008/"/>
    <id>https://rainmakerho.github.io/2019/03/11/2019008/</id>
    <published>2019-03-11T02:14:12.000Z</published>
    <updated>2019-03-11T03:39:59.746Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>在前一篇「<a href="https://rainmakerho.github.io/2019/02/19/2019006/">使用 OpenTracing - Jaeger (BFv3 使用 Fody)</a>」，我們使用 <a href="https://github.com/vescon/MethodBoundaryAspect.Fody" target="_blank" rel="noopener">MethodBoundaryAspect.Fody</a> 來處理 OpenTracing 的程式碼，但是在有些 async 及 Overloading methods 時，會有修改 il 出錯而無法建置的狀況。 所以我們可以改用 PostSharp 的 OnMethodBoundaryAspect 來處理就沒有問題了。</p><h3 id="實作"><a href="#實作" class="headerlink" title="實作"></a>實作</h3><p>到 <a href="https://www.postsharp.net/download" target="_blank" rel="noopener">DOWNLOAD POSTSHARP</a> 下載安裝檔，在安裝過程中先選 PostSharp Essentials (限制一個專案只 Support 10 個 Class，詳細請參考:<a href="https://www.postsharp.net/essentials" target="_blank" rel="noopener">PostSharp Essentials</a>)。<br><img src="/2019/03/11/2019008/001.png" title="[PostSharp Essentials License]"></p><h4 id="建立-OpenTracing-的-MethodBoundaryAspect-專案"><a href="#建立-OpenTracing-的-MethodBoundaryAspect-專案" class="headerlink" title="建立 OpenTracing 的 MethodBoundaryAspect 專案"></a>建立 OpenTracing 的 MethodBoundaryAspect 專案</h4><p>當安裝好 PostSharp Essentials 後，新增一個 類別庫 專案，從 Nuget 套件中加入 PostSharp , 或在專案上按右鍵，選擇「Add PostSharp to project 」。<br><img src="/2019/03/11/2019008/002.png" title="[install PostSharp package]"></p><p>新增繼承自 OnMethodBoundaryAspect 的類別，然後在 OnEntry、OnException 及 OnExit 加入 OpetTracing 處理的程式碼，如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">OpenTracing.PostSharp</span></span><br><span class="line">&#123;</span><br><span class="line">[<span class="meta">PSerializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">OpenTracingLoggingAspect</span> : <span class="title">OnMethodBoundaryAspect</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//接由外部 service 傳入的 Header 資料</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> AsyncLocal&lt;Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt;&gt; TracerHttpHeaders =</span><br><span class="line"><span class="keyword">new</span> AsyncLocal&lt;Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnEntry</span>(<span class="params">MethodExecutionArgs args</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (!GlobalTracer.IsRegistered()) <span class="keyword">return</span>;</span><br><span class="line"><span class="keyword">var</span> operationName = <span class="string">$"<span class="subst">&#123;args.Method.Name&#125;</span>.<span class="subst">&#123;args.Method.ReflectedType.Name&#125;</span>"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> tracer = GlobalTracer.Instance;</span><br><span class="line"><span class="keyword">var</span> spanBuilder = tracer.BuildSpan(operationName);</span><br><span class="line"><span class="keyword">if</span> (tracer.ActiveSpan != <span class="literal">null</span>)</span><br><span class="line">&#123;</span><br><span class="line">spanBuilder.AsChildOf(tracer.ActiveSpan);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (TracerHttpHeaders.Value != <span class="literal">null</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// check http</span></span><br><span class="line"><span class="keyword">var</span> parentSpanCtx = tracer.Extract(BuiltinFormats.HttpHeaders, <span class="keyword">new</span> TextMapExtractAdapter(TracerHttpHeaders.Value));</span><br><span class="line">spanBuilder.AsChildOf(parentSpanCtx);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> activeScope = spanBuilder.StartActive(<span class="literal">true</span>);</span><br><span class="line">args.MethodExecutionTag = activeScope;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnException</span>(<span class="params">MethodExecutionArgs args</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (!GlobalTracer.IsRegistered()) <span class="keyword">return</span>;</span><br><span class="line"><span class="comment">//args.FlowBehavior = FlowBehavior.ThrowException;</span></span><br><span class="line"><span class="keyword">var</span> operationName = <span class="string">$"<span class="subst">&#123;args.Method.Name&#125;</span>.<span class="subst">&#123;args.Method.ReflectedType.Name&#125;</span>"</span>;</span><br><span class="line"><span class="keyword">var</span> activeScope = args.MethodExecutionTag <span class="keyword">as</span> IScope;</span><br><span class="line">Tags.Error.Set(activeScope.Span, <span class="literal">true</span>);</span><br><span class="line">activeScope.Span.Log(<span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">object</span>&gt; &#123; [<span class="string">"error"</span>] = args.Exception.ToString() &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnExit</span>(<span class="params">MethodExecutionArgs args</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (!GlobalTracer.IsRegistered()) <span class="keyword">return</span>;</span><br><span class="line"><span class="keyword">var</span> operationName = <span class="string">$"<span class="subst">&#123;args.Method.Name&#125;</span>.<span class="subst">&#123;args.Method.ReflectedType.Name&#125;</span>"</span>;</span><br><span class="line"><span class="keyword">var</span> activeScope = args.MethodExecutionTag <span class="keyword">as</span> IScope;</span><br><span class="line">activeScope.Dispose();</span><br><span class="line">System.Diagnostics.Debug.WriteLine(<span class="string">$"[<span class="subst">&#123;operationName&#125;</span>]:OnExit"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="在-Bot-專案中加入"><a href="#在-Bot-專案中加入" class="headerlink" title="在 Bot 專案中加入"></a>在 Bot 專案中加入</h4><p>一樣在 Bot 專案中，一樣要加入 PostSharp 的套件，在 Global.asax.cs 中 Application_BeginRequest 中加入取得 Jaeger Http Header 然後指定給 OpenTracingLoggingAspect 的 TracerHttpHeaders 屬性，如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">Application_BeginRequest</span>(<span class="params"><span class="keyword">object</span> sender, EventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">//處理外部送進來的 opentracing data</span></span><br><span class="line"><span class="keyword">var</span> headerDict = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt;();</span><br><span class="line"><span class="keyword">var</span> headers = <span class="keyword">base</span>.Context.Request.Headers;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> k <span class="keyword">in</span> headers.AllKeys)</span><br><span class="line">&#123;</span><br><span class="line">headerDict.Add(k, headers[k]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (headerDict.Count &gt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">OpenTracingLoggingAspect.TracerHttpHeaders.Value = headerDict;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">OpenTracingLoggingAspect.TracerHttpHeaders.Value = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="呼叫外部-Service-加入-Jaeger-Http-Header"><a href="#呼叫外部-Service-加入-Jaeger-Http-Header" class="headerlink" title="呼叫外部 Service 加入 Jaeger Http Header"></a>呼叫外部 Service 加入 Jaeger Http Header</h4><p>我們要在呼叫 外部 Service 地方，加入 Jaeger Http Header，所以建議在生成 httpClient 時，可以統一由 Factory 來生成，如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//add opentracing</span></span><br><span class="line"><span class="keyword">if</span> (GlobalTracer.IsRegistered())</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> tracer = GlobalTracer.Instance;</span><br><span class="line">    <span class="keyword">var</span> dictionary = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt;();</span><br><span class="line">    <span class="keyword">var</span> span = tracer.ActiveSpan;</span><br><span class="line">    <span class="keyword">if</span> (span != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        tracer.Inject(span.Context, BuiltinFormats.HttpHeaders, <span class="keyword">new</span> TextMapInjectAdapter(dictionary));</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> entry <span class="keyword">in</span> dictionary)</span><br><span class="line">            HttpClient.DefaultRequestHeaders.Add(entry.Key, entry.Value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="設定-OpenTracingLoggingAspect-屬性"><a href="#設定-OpenTracingLoggingAspect-屬性" class="headerlink" title="設定 [OpenTracingLoggingAspect] 屬性"></a>設定 [OpenTracingLoggingAspect] 屬性</h4><p>我們可以在需要記錄的 Class 中設定，或是在 Properties / AssemblyInfo.cs 中設定，例如以下我針對 namespace EasyLifeBot.Actions 及 EasyLifeBot.Controllers 開頭的類別去記錄，詳細用法，請參考 <a href="https://doc.postsharp.net/attribute-multicasting" target="_blank" rel="noopener">Adding Aspects to Multiple Declarations Using Attributes</a>，如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">assembly: OpenTracingLoggingAspect(</span></span><br><span class="line"><span class="meta">   AttributeTargetTypes = <span class="meta-string">"EasyLifeBot.Actions.*"</span>)</span>]</span><br><span class="line">[<span class="meta">assembly: OpenTracingLoggingAspect(</span></span><br><span class="line"><span class="meta">   AttributeTargetTypes = <span class="meta-string">"EasyLifeBot.Controllers.*"</span>)</span>]</span><br></pre></td></tr></table></figure><p>因為是使用 PostSharp Essentials ，如果類別超過 10 個，就會出現 license 的錯誤，而無法建置哦! 如下，</p><blockquote><p>License error. The project uses non-licensed features. It is not allowed to enhance or analyze more than 10 classes in each project by features not covered by the installed licenses. Please visit <a href="https://www.postsharp.net/purchase" target="_blank" rel="noopener">https://www.postsharp.net/purchase</a> to acquire a license of PostSharp. EasyLifeBot</p></blockquote><h3 id="測試"><a href="#測試" class="headerlink" title="測試"></a>測試</h3><p>當順利建置，就可以把 Jaeger 開起來，並執行程式跑看看，我一樣使用 <strong>訂便當 BOT</strong> 來測試。<br>執行後，可以順利從 Jaeger Search UI 中看到從 Bot Connector =&gt; 訂便當 BOT =&gt; Bot Connector 都串起來了。<br><img src="/2019/03/11/2019008/003.png" title="[Jaeger Search UI]"></p><p>發生錯誤時，除了正常串接起來外，也可以收到 Error 的 Log ，如下，<br><img src="/2019/03/11/2019008/004.png" title="[Log Error]"></p><h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><p><a href="https://doc.postsharp.net/method-decorator" target="_blank" rel="noopener">Injecting Behaviors Before and After Method Execution</a><br><a href="https://doc.postsharp.net/attribute-multicasting" target="_blank" rel="noopener">Adding Aspects to Multiple Declarations Using Attributes</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;在前一篇「&lt;a href=&quot;https://rainmakerho.github.io/2019/02/19/2019006/&quot;&gt;使用 Op
      
    
    </summary>
    
    
      <category term="OpenTracing" scheme="https://rainmakerho.github.io/tags/OpenTracing/"/>
    
      <category term="Distributed Tracing" scheme="https://rainmakerho.github.io/tags/Distributed-Tracing/"/>
    
      <category term="Jaeger" scheme="https://rainmakerho.github.io/tags/Jaeger/"/>
    
      <category term="APM" scheme="https://rainmakerho.github.io/tags/APM/"/>
    
      <category term="Dynatrace" scheme="https://rainmakerho.github.io/tags/Dynatrace/"/>
    
      <category term=".NET" scheme="https://rainmakerho.github.io/tags/NET/"/>
    
      <category term="BFv3" scheme="https://rainmakerho.github.io/tags/BFv3/"/>
    
      <category term="Fody" scheme="https://rainmakerho.github.io/tags/Fody/"/>
    
      <category term="MethodBoundaryAspect.Fody" scheme="https://rainmakerho.github.io/tags/MethodBoundaryAspect-Fody/"/>
    
      <category term="IL Rewriting" scheme="https://rainmakerho.github.io/tags/IL-Rewriting/"/>
    
      <category term="IL weaving" scheme="https://rainmakerho.github.io/tags/IL-weaving/"/>
    
      <category term="PostSharp" scheme="https://rainmakerho.github.io/tags/PostSharp/"/>
    
  </entry>
  
  <entry>
    <title>Inheritance security rules violated by type: &#39;System.Net.Http.WebRequestHandler&#39;</title>
    <link href="https://rainmakerho.github.io/2019/02/23/2019007/"/>
    <id>https://rainmakerho.github.io/2019/02/23/2019007/</id>
    <published>2019-02-23T02:41:55.000Z</published>
    <updated>2019-02-23T02:51:08.748Z</updated>
    
    <content type="html"><![CDATA[<p>今天在執行程式時，居然噴「Inheritance security rules violated by type: ‘System.Net.Http.WebRequestHandler’.」的錯誤。</p><p>查了一下，似乎在 System.Net.Http 4.1.0.0 版本有一些問題，解法有 2 個，如下，</p><ol><li>改用回 4.0.0.0 版本<br>在 web.config 中的 bindingRedirect 改用 4.0.0.0 版本，如下，</li></ol><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bindingRedirect</span> <span class="attr">oldVersion</span>=<span class="string">"0.0.0.0-4.1.1.0"</span> <span class="attr">newVersion</span>=<span class="string">"4.0.0.0"</span> /&gt;</span></span><br></pre></td></tr></table></figure><ol start="2"><li>使用新版本<br>在 Nuget 中，找 System.Net.Http ，安裝新的版本，筆者是使用 4.1.1.3</li></ol><p>以上解法分享給大家。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;今天在執行程式時，居然噴「Inheritance security rules violated by type: ‘System.Net.Http.WebRequestHandler’.」的錯誤。&lt;/p&gt;
&lt;p&gt;查了一下，似乎在 System.Net.Http 4.1.0
      
    
    </summary>
    
    
      <category term="System.Net.Http" scheme="https://rainmakerho.github.io/tags/System-Net-Http/"/>
    
      <category term="4.1.0.0" scheme="https://rainmakerho.github.io/tags/4-1-0-0/"/>
    
      <category term="軟體求生" scheme="https://rainmakerho.github.io/tags/%E8%BB%9F%E9%AB%94%E6%B1%82%E7%94%9F/"/>
    
  </entry>
  
</feed>
