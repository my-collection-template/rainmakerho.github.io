<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>亂馬客 - back to basics</title>
  <icon>https://www.gravatar.com/avatar/cd3aed042ccd7a5a5d9956b0bc07dc81</icon>
  <subtitle>back to basics</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://rainmakerho.github.io/"/>
  <updated>2018-08-02T02:08:52.304Z</updated>
  <id>https://rainmakerho.github.io/</id>
  
  <author>
    <name>亂馬客</name>
    <email>rainmaker_ho@gss.com.tw</email>
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>RxJS 學習之旅 ~ Html DOM 操作</title>
    <link href="https://rainmakerho.github.io/2018/08/01/2018028/"/>
    <id>https://rainmakerho.github.io/2018/08/01/2018028/</id>
    <published>2018-08-01T09:41:36.000Z</published>
    <updated>2018-08-02T02:08:52.304Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>在前篇<a href="https://rainmakerho.github.io/2018/07/26/2018027/">RxJS 學習之旅 ~ 環境設定</a>設定好之後，就可以開始來練習使用 RxJS 常常會舉到的例子，透過 Mouse 在 Canvas 上畫圖。<br>如果直接寫程式的話，大約會設定一個 isMouseDown 的變數，然後在 mousedown event 中設定它為 true, 而在 mouseup event 中，設定它為 false，而在 mousemove event 中，如果 isMouseDown 為 true ，就把線畫到那上面去。<br>如果透過 RxJS 要如何做呢?</p><h3 id="實作"><a href="#實作" class="headerlink" title="實作"></a>實作</h3><p>首先，修改 index.html ，加入 canvas 做為我們的畫布 ，如下</p><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"ie=edge"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>RxJS Demo<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>RxJS Demo<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">canvas</span> <span class="attr">id</span>=<span class="string">"canvas"</span> <span class="attr">width</span>=<span class="string">"500"</span> <span class="attr">height</span>=<span class="string">"500"</span> <span class="attr">style</span>=<span class="string">"border:1px solid #000000;"</span>&gt;</span><span class="tag">&lt;/<span class="name">canvas</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"/bundle.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure><p>然後我們就可以透過 RxJS 來觀察 mouse 的 event ，然後將線畫出來。<br>mouse down (移動點) -&gt; mouse move (畫線) -&gt; mouse up (停止畫線)<br>因為畫線只需要 x, y ，所以我們將 MouseEvent 轉成 x, y 比較方便。</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> &#123; fromEvent, merge &#125; <span class="keyword">from</span> <span class="string">'rxjs'</span>;</div><div class="line"><span class="keyword">import</span> &#123; map, concatMap, takeUntil, tap &#125; <span class="keyword">from</span> <span class="string">'rxjs/operators'</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> canvas = &lt;HTMLCanvasElement&gt;<span class="built_in">document</span>.getElementById(<span class="string">'canvas'</span>);</div><div class="line"></div><div class="line"><span class="keyword">const</span> rect = canvas.getBoundingClientRect();</div><div class="line"><span class="keyword">const</span> ctx = canvas.getContext(<span class="string">'2d'</span>);</div><div class="line"></div><div class="line">ctx.beginPath(); <span class="comment">// 開始畫畫</span></div><div class="line"><span class="keyword">var</span> draw = <span class="function"><span class="keyword">function</span>(<span class="params">to: <span class="built_in">any</span></span>) </span>&#123;</div><div class="line">ctx.lineTo(to.x, to.y);</div><div class="line">ctx.stroke();</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">const</span> mouseEventToCoordinate = <span class="function">(<span class="params">mouseEvent: <span class="built_in">any</span></span>) =&gt;</span> &#123;</div><div class="line">mouseEvent.preventDefault();</div><div class="line"><span class="keyword">return</span> &#123;</div><div class="line">x: mouseEvent.clientX - rect.left,</div><div class="line">y: mouseEvent.clientY - rect.top</div><div class="line">&#125;;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">const</span> mouseDowns = fromEvent(canvas, <span class="string">'mousedown'</span>).pipe(</div><div class="line">map(mouseEventToCoordinate)</div><div class="line">);</div><div class="line"><span class="keyword">const</span> mouseMoves = fromEvent(canvas, <span class="string">'mousemove'</span>).pipe(</div><div class="line">map(mouseEventToCoordinate)</div><div class="line">);</div><div class="line"><span class="keyword">const</span> mouseUps = fromEvent(<span class="built_in">window</span>, <span class="string">'mouseup'</span>).pipe(</div><div class="line">map(<span class="function"><span class="params">e</span> =&gt;</span> &#123;</div><div class="line"><span class="built_in">console</span>.log(<span class="string">'mouseup'</span>);</div><div class="line"><span class="keyword">return</span> mouseEventToCoordinate(e);</div><div class="line">&#125;)</div><div class="line">);</div><div class="line"></div><div class="line"><span class="comment">//mouse down (移動點) -&gt; mouse move (畫線) -&gt; mouse up (停止畫線)</span></div><div class="line"><span class="keyword">const</span> mouseDraw = mouseDowns.pipe(</div><div class="line">tap(<span class="function"><span class="params">p</span> =&gt;</span> &#123;</div><div class="line"><span class="built_in">console</span>.log(<span class="string">'mouseDowns'</span>);</div><div class="line">ctx.moveTo(p.x, p.y);</div><div class="line">&#125;),</div><div class="line">concatMap(<span class="function"><span class="params">p</span> =&gt;</span> mouseMoves.pipe(takeUntil(mouseUps)))</div><div class="line">);</div><div class="line"><span class="comment">//將線畫出來</span></div><div class="line">mouseDraw.subscribe(<span class="function"><span class="params">p</span> =&gt;</span> draw(p));</div></pre></td></tr></table></figure><p>結果如下，<br><img src="/2018/08/01/2018028/001.png" alt="[Mouse Draw]" title="[Mouse Draw]"></p><p>除了 mouse 外，我們還有 touch event ，所以 touch 也是一樣可以做這樣子的處理哦!</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> touchEventToCoordinate = <span class="function">(<span class="params">touchEvent: <span class="built_in">any</span></span>) =&gt;</span> &#123;</div><div class="line">touchEvent.preventDefault();</div><div class="line"><span class="keyword">return</span> &#123;</div><div class="line">x: touchEvent.changedTouches[<span class="number">0</span>].clientX - rect.left,</div><div class="line">y: touchEvent.changedTouches[<span class="number">0</span>].clientY - rect.top</div><div class="line">&#125;;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">const</span> touchStarts = fromEvent(canvas, <span class="string">'touchstart'</span>).pipe(</div><div class="line">map(touchEventToCoordinate)</div><div class="line">);</div><div class="line"><span class="keyword">const</span> touchMoves = fromEvent(canvas, <span class="string">'touchmove'</span>).pipe(</div><div class="line">map(touchEventToCoordinate)</div><div class="line">);</div><div class="line"></div><div class="line"><span class="comment">//在asus touchscreen nb is not firing</span></div><div class="line"><span class="keyword">const</span> touchEnds = fromEvent(<span class="built_in">window</span>, <span class="string">'touched'</span>).pipe(</div><div class="line">map(<span class="function"><span class="params">e</span> =&gt;</span> &#123;</div><div class="line"><span class="built_in">console</span>.log(<span class="string">'touched'</span>);</div><div class="line"><span class="keyword">return</span> touchEventToCoordinate(e);</div><div class="line">&#125;)</div><div class="line">);</div><div class="line"><span class="comment">//在asus touchscreen nb is not firing</span></div><div class="line"><span class="keyword">const</span> touchCancels = fromEvent(<span class="built_in">window</span>, <span class="string">'touchcancel '</span>).pipe(</div><div class="line">map(<span class="function"><span class="params">e</span> =&gt;</span> &#123;</div><div class="line"><span class="built_in">console</span>.log(<span class="string">'touchcancel'</span>);</div><div class="line"><span class="keyword">return</span> touchEventToCoordinate;</div><div class="line">&#125;)</div><div class="line">);</div><div class="line"></div><div class="line"><span class="keyword">const</span> touchDraw = touchStarts.pipe(</div><div class="line">tap(<span class="function"><span class="params">p</span> =&gt;</span> &#123;</div><div class="line"><span class="built_in">console</span>.log(<span class="string">'touchStarts'</span>);</div><div class="line">ctx.moveTo(p.x, p.y);</div><div class="line">&#125;),</div><div class="line">concatMap(<span class="function"><span class="params">p</span> =&gt;</span> touchMoves.pipe(takeUntil(touchEnds)))</div><div class="line">);</div><div class="line"><span class="comment">//將線畫出來 touch</span></div><div class="line">touchDraw.subscribe(<span class="function"><span class="params">p</span> =&gt;</span> draw(p));</div></pre></td></tr></table></figure><p>在上面的程式中，我們將原本 MouseEvent 及 TouchEvent 的內容，透過 map 轉換成了 x, y。<br>所以我們可以透過 merge 將 mouseDowns 與 touchStarts , mouseMoves 與 touchMoves , mouseUps, touchEnds, touchCancels 組合，然後在這些組合中去畫線，如下，</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> starts = merge(mouseDowns, touchStarts);</div><div class="line"><span class="keyword">const</span> moves = merge(mouseMoves, touchMoves);</div><div class="line"><span class="keyword">const</span> ends = merge(mouseUps, touchEnds, touchCancels);</div><div class="line"></div><div class="line"><span class="keyword">const</span> draws = starts.pipe(</div><div class="line">tap(<span class="function"><span class="params">p</span> =&gt;</span> &#123;</div><div class="line"><span class="built_in">console</span>.log(<span class="string">'starts'</span>);</div><div class="line">ctx.moveTo(p.x, p.y);</div><div class="line">&#125;),</div><div class="line">concatMap(<span class="function"><span class="params">p</span> =&gt;</span> moves.pipe(takeUntil(ends)))</div><div class="line">);</div><div class="line"></div><div class="line"><span class="comment">//合併mouse &amp; touch</span></div><div class="line">draws.subscribe(<span class="function"><span class="params">p</span> =&gt;</span> &#123;</div><div class="line">draw(p);</div><div class="line">&#125;);</div></pre></td></tr></table></figure><ul><li>註: 因為 touch 事件在筆電上有可以不會被觸發，所以有可能在 touch 畫完後，mouse 一移動會一直畫線，是因為 touched 事件被沒觸發到。</li></ul><h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><p><a href="https://codepen.io/HunorMarton/post/handling-complex-mouse-and-touch-events-with-rxjs" target="_blank" rel="external">Handling complex mouse and touch events with RxJS</a><br><a href="https://developer.mozilla.org/zh-TW/docs/Web/API/Touch_events" target="_blank" rel="external">touch events may not fire at all on laptop</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;在前篇&lt;a href=&quot;https://rainmakerho.github.io/2018/07/26/2018027/&quot;&gt;RxJS 學習
      
    
    </summary>
    
    
      <category term="RxJS" scheme="https://rainmakerho.github.io/tags/RxJS/"/>
    
      <category term="DOM" scheme="https://rainmakerho.github.io/tags/DOM/"/>
    
      <category term="events" scheme="https://rainmakerho.github.io/tags/events/"/>
    
      <category term="mousedown" scheme="https://rainmakerho.github.io/tags/mousedown/"/>
    
      <category term="mousemove" scheme="https://rainmakerho.github.io/tags/mousemove/"/>
    
      <category term="mouseup" scheme="https://rainmakerho.github.io/tags/mouseup/"/>
    
      <category term="touchstart" scheme="https://rainmakerho.github.io/tags/touchstart/"/>
    
      <category term="touchmove" scheme="https://rainmakerho.github.io/tags/touchmove/"/>
    
      <category term="touched" scheme="https://rainmakerho.github.io/tags/touched/"/>
    
      <category term="darw" scheme="https://rainmakerho.github.io/tags/darw/"/>
    
  </entry>
  
  <entry>
    <title>RxJS 學習之旅 ~ 環境設定</title>
    <link href="https://rainmakerho.github.io/2018/07/26/2018027/"/>
    <id>https://rainmakerho.github.io/2018/07/26/2018027/</id>
    <published>2018-07-26T02:58:59.000Z</published>
    <updated>2018-07-26T05:29:11.703Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>在學習 RxJS 之前，我們要做環境設定，讓我們可以順利的完成我們的學習。<br>我是依 <a href="https://codingthesmartway.com/getting-started-with-rxjs-part-1-setting-up-the-development-environment-creating-observables/" target="_blank" rel="external">Getting Started With RxJS – Part 1: Setting Up The Development Environment &amp; Creating Observables</a> 這篇來實作。</p><h3 id="實作"><a href="#實作" class="headerlink" title="實作"></a>實作</h3><p>一開始建立測試的目錄，然後到目錄裡，透過 npm init -y 來建立 package.json，如下，</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mkdir rxjs-test</div><div class="line">cd rxjs-test</div><div class="line">npm init -y</div></pre></td></tr></table></figure><p>再來就是安裝需要的套件, 如下，</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">npm install rxjs core-js</div><div class="line">npm install webpack webpack-dev-server typescript ts-loader webpack-cli --save-dev</div></pre></td></tr></table></figure><p>如果我們有用到 Promise 的話，需要多加上 core-js 哦! 如果不會用到話，就可以不需要加它。</p><p>再來就是在 package.json 的 “scripts” 中加入 “start” ，讓我們可以啟動 webpack-dev-server 來測試，</p><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="string">"scripts"</span>: &#123;</div><div class="line">    <span class="string">"start"</span>: <span class="string">"webpack-dev-server --mode development"</span></div><div class="line">  &#125;,</div></pre></td></tr></table></figure><p>因為打包是透過 webpack ，所以我們新增 <em>webpack.config.js</em> 來讓 webpack 執行打包作業，</p><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line">entry: [<span class="string">'core-js/fn/promise'</span>, <span class="string">'./src/index.ts'</span>],</div><div class="line">devtool: <span class="string">'inline-source-map'</span>,</div><div class="line"><span class="built_in">module</span>: &#123;</div><div class="line">rules: [</div><div class="line">&#123;</div><div class="line">test: <span class="regexp">/\.tsx?$/</span>,</div><div class="line">use: <span class="string">'ts-loader'</span>,</div><div class="line">exclude: <span class="regexp">/node_modules/</span></div><div class="line">&#125;</div><div class="line">]</div><div class="line">&#125;,</div><div class="line">resolve: &#123;</div><div class="line">extensions: [<span class="string">'.tsx'</span>, <span class="string">'.ts'</span>, <span class="string">'.js'</span>]</div><div class="line">&#125;,</div><div class="line">output: &#123;</div><div class="line">filename: <span class="string">'bundle.js'</span>,</div><div class="line">path: path.resolve(__dirname, <span class="string">'dist'</span>)</div><div class="line">&#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// webpack-dev-server is serving bundle.js from memory</span></div></pre></td></tr></table></figure><p>如果會用到 Promis 的話，就需要多加 <em>core-js/fn/promise</em> 。<br>因為我們是使用 TypeScript ，所以新增 <em>tsconfig.json</em> 來決定要輸出到那裡，因為 webpack 是從 dist 目錄去找，所以這裡也要設定輸出到 dist 目錄 ，如下，</p><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line"><span class="string">"compilerOptions"</span>: &#123;</div><div class="line"><span class="string">"outDir"</span>: <span class="string">"./dist/"</span>,</div><div class="line"><span class="string">"sourceMap"</span>: <span class="literal">true</span>,</div><div class="line"><span class="string">"noImplicitAny"</span>: <span class="literal">true</span>,</div><div class="line"><span class="string">"module"</span>: <span class="string">"commonjs"</span>,</div><div class="line"><span class="string">"moduleResolution"</span>: <span class="string">"node"</span>,</div><div class="line"><span class="string">"target"</span>: <span class="string">"es5"</span>,</div><div class="line"><span class="string">"allowJs"</span>: <span class="literal">true</span>,</div><div class="line"><span class="string">"lib"</span>: [<span class="string">"es2017"</span>, <span class="string">"dom"</span>]</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>準備好 TypeScript ，打包工具 webpack 後，再來就是新增測試的 <em>index.html</em> ，script 的 src 是 /bundle.js 是因為 webpack 產出的就是 bundle.js , 如下，</p><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"ie=edge"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>RxJS Demo<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></div><div class="line"><span class="css">        <span class="selector-tag">body</span> &#123; <span class="attribute">font-family</span>: <span class="string">'Arial'</span>; <span class="attribute">background</span>: lightgray &#125;</span></div><div class="line"><span class="css">        <span class="selector-tag">ul</span> &#123; <span class="attribute">list-style-type</span>: none; <span class="attribute">padding</span>: <span class="number">20px</span>; &#125;</span></div><div class="line"><span class="css">        <span class="selector-tag">li</span> &#123; <span class="attribute">padding</span>: <span class="number">15px</span>; <span class="attribute">background</span>: lightcoral; <span class="attribute">margin-bottom</span>: <span class="number">10px</span>; &#125;</span></div><div class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>RxJS Demo<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">"list"</span>&gt;</span><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"/bundle.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure><p>有了 UI 後，我們就可以寫簡單的 RxJS 練習看看了，所以建立 <em>src</em> 目錄，然後新增 index.ts 。 logItem function 主要是將內容顯示到網頁上。</p><p>example 1 : 是建立一個 Observable 的物件，complete() 後的 next 是不會輸出的哦!</p><p>example 2 : 從一個 number array 來產生一個 Observable 物件，再透過 pipe 將 map 與 filter 串接起來。</p><p>example 3 : 建立一個會發出 error 的 Obserable 物件。</p><p>example 4 : 透過 setTimeout 來模擬 Stream 的感覺，所以資料會過 3 秒後才會再呈現在 UI 上面。</p><p>Promise 是測試 js 在 IE 上是否可以正常運行，</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 2 mb</span></div><div class="line"><span class="keyword">import</span> &#123; Observable, <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">'rxjs'</span>;</div><div class="line"><span class="keyword">import</span> &#123; map, filter &#125; <span class="keyword">from</span> <span class="string">'rxjs/operators'</span>;</div><div class="line"><span class="comment">// import 'rxjs/add/operator/map';</span></div><div class="line"><span class="comment">// import 'rxjs/add/operator/filter';</span></div><div class="line"></div><div class="line"><span class="comment">// 從個別的模組載入 1 mb</span></div><div class="line"><span class="comment">// import &#123; Observable &#125; from 'rxjs/internal/Observable';</span></div><div class="line"><span class="comment">// import &#123; from &#125; from 'rxjs/internal/observable/from';</span></div><div class="line"><span class="comment">// import &#123; map &#125; from 'rxjs/internal/operators/map';</span></div><div class="line"><span class="comment">// import &#123; filter &#125; from 'rxjs/internal/operators/filter';</span></div><div class="line"></div><div class="line"><span class="comment">//example 1</span></div><div class="line"><span class="keyword">var</span> observable = Observable.create(<span class="function">(<span class="params">observer: <span class="built_in">any</span></span>) =&gt;</span> &#123;</div><div class="line">observer.next(<span class="string">'Hello World!'</span>);</div><div class="line">observer.next(<span class="string">'example 1:Hello Again!'</span>);</div><div class="line">observer.complete();</div><div class="line">observer.next(<span class="string">'example 1:Bye Bye! After Complete'</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">observable.subscribe(</div><div class="line">(x: <span class="built_in">any</span>) =&gt; logItem(<span class="string">`example 1:<span class="subst">$&#123;x&#125;</span>`</span>),</div><div class="line">(error: <span class="built_in">any</span>) =&gt; logItem(<span class="string">`example 1:Error: <span class="subst">$&#123;error&#125;</span>`</span>),</div><div class="line">() =&gt; logItem(<span class="string">'example 1:Completed'</span>)</div><div class="line">);</div><div class="line"></div><div class="line"><span class="comment">//example 2</span></div><div class="line"><span class="keyword">let</span> numbers = [<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">10</span>];</div><div class="line"><span class="keyword">let</span> numbersSource = <span class="keyword">from</span>(numbers).pipe(</div><div class="line">map(<span class="function"><span class="params">x</span> =&gt;</span> x + <span class="number">1</span>),</div><div class="line">filter(<span class="function"><span class="params">x</span> =&gt;</span> x &gt; <span class="number">3</span>)</div><div class="line">);</div><div class="line"><span class="keyword">class</span> NumberObserver &#123;</div><div class="line">next(value: <span class="built_in">any</span>) &#123;</div><div class="line">logItem(<span class="string">`NumberObserver:<span class="subst">$&#123;value&#125;</span>`</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line">error(e: <span class="built_in">any</span>) &#123;</div><div class="line">logItem(<span class="string">`NumberObserver:Error: <span class="subst">$&#123;e&#125;</span>`</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line">complete() &#123;</div><div class="line">logItem(<span class="string">'NumberObserver:Completed'</span>);</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">numbersSource.subscribe(<span class="keyword">new</span> NumberObserver());</div><div class="line"></div><div class="line"><span class="comment">//example 3 with error</span></div><div class="line"><span class="keyword">var</span> obsservableErr = Observable.create(<span class="function">(<span class="params">observer: <span class="built_in">any</span></span>) =&gt;</span> &#123;</div><div class="line"><span class="keyword">for</span> (<span class="keyword">let</span> n of numbers) &#123;</div><div class="line">observer.next(n);</div><div class="line"><span class="keyword">if</span> (n === <span class="number">5</span>) &#123;</div><div class="line">observer.error(<span class="string">`number can't be 5`</span>);</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">observer.complete();</div><div class="line">&#125;);</div><div class="line">obsservableErr.subscribe(<span class="keyword">new</span> NumberObserver());</div><div class="line"></div><div class="line"><span class="comment">//example 4 setTimeout</span></div><div class="line"><span class="keyword">var</span> obsservableTimeout = Observable.create(<span class="function">(<span class="params">observer: <span class="built_in">any</span></span>) =&gt;</span> &#123;</div><div class="line"><span class="keyword">let</span> index = <span class="number">0</span>;</div><div class="line"><span class="keyword">let</span> produceValue = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">observer.next(numbers[index++]);</div><div class="line"><span class="keyword">if</span> (index &lt; numbers.length) &#123;</div><div class="line">setTimeout(produceValue, <span class="number">3000</span>);</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">observer.complete();</div><div class="line">&#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">produceValue();</div><div class="line">&#125;);</div><div class="line">obsservableTimeout.subscribe(<span class="keyword">new</span> NumberObserver());</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">logItem</span>(<span class="params">val: <span class="built_in">any</span></span>) </span>&#123;</div><div class="line"><span class="keyword">var</span> node = <span class="built_in">document</span>.createElement(<span class="string">'li'</span>);</div><div class="line"><span class="keyword">var</span> textnode = <span class="built_in">document</span>.createTextNode(val);</div><div class="line">node.appendChild(textnode);</div><div class="line"><span class="built_in">document</span>.getElementById(<span class="string">'list'</span>).appendChild(node);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> t1 = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">a</span>) </span>&#123;&#125;);</div></pre></td></tr></table></figure><p>這時可以在 command 下輸入 npm start, 執行結果如下，<br><img src="/2018/07/26/2018027/001.png" alt="[RxJS Demo]" title="[RxJS Demo]"></p><p>環境設定好了之後，我們就可以開始練習 RxJS 的相關操作了哦 :)</p><h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><p><a href="https://legacy.gitbook.com/book/chrisnoring/rxjs-5-ultimate/details" target="_blank" rel="external">Rxjs ultimate gitbook</a></p><p><a href="https://codingthesmartway.com/getting-started-with-rxjs-part-1-setting-up-the-development-environment-creating-observables/" target="_blank" rel="external">Getting Started With RxJS – Part 1: Setting Up The Development Environment &amp; Creating Observables</a></p><p><a href="https://stackoverflow.com/questions/35642223/angular2-why-do-we-need-the-es6-shim" target="_blank" rel="external">Angular2 why do we need the es6-shim</a></p><p><a href="https://stackoverflow.com/questions/38960490/how-can-i-polyfill-promise-with-webpack/39824671" target="_blank" rel="external">How can I polyfill Promise with webpack?</a></p><p><a href="https://stackoverflow.com/questions/50186371/property-from-does-not-exist-on-type-typeof-observable-angular-6" target="_blank" rel="external">Property ‘from’ does not exist on type ‘typeof Observable’</a></p><p><a href="https://github.com/ReactiveX/rxjs/blob/master/docs_app/content/guide/v6/migration.md" target="_blank" rel="external">RxJS v5.x to v6 Update Guide</a></p><p><a href="https://medium.com/coding-snippets/rxjs-5-5-property-map-does-not-exist-on-type-observable-e825129c2068" target="_blank" rel="external">Property ‘map’ does not exist on type Observable…</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;在學習 RxJS 之前，我們要做環境設定，讓我們可以順利的完成我們的學習。&lt;br&gt;我是依 &lt;a href=&quot;https://codingth
      
    
    </summary>
    
    
      <category term="RxJS" scheme="https://rainmakerho.github.io/tags/RxJS/"/>
    
      <category term="Development Environment" scheme="https://rainmakerho.github.io/tags/Development-Environment/"/>
    
      <category term="環境設定" scheme="https://rainmakerho.github.io/tags/%E7%92%B0%E5%A2%83%E8%A8%AD%E5%AE%9A/"/>
    
  </entry>
  
  <entry>
    <title>為什麼設定了 DataColumn.DefaultValue 會無效?</title>
    <link href="https://rainmakerho.github.io/2018/07/20/2018026/"/>
    <id>https://rainmakerho.github.io/2018/07/20/2018026/</id>
    <published>2018-07-20T05:04:16.000Z</published>
    <updated>2018-07-22T09:18:56.114Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>最近需要將原本從資料庫取出的資料再加入額外的欄位，並給預設值。但是預設值卻沒有顯示出來，是什麼原因呢?</p><h3 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h3><p>我們的程式寫法如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//取得原始的資料</span></div><div class="line"><span class="keyword">var</span> dtFromDB = GetDataSource();</div><div class="line"><span class="comment">//要額外加入欄位，並給予預設值</span></div><div class="line"><span class="keyword">var</span> colMemo1 = dtFromDB.Columns.Add(<span class="string">"缺料註記"</span>, <span class="keyword">typeof</span>(<span class="keyword">string</span>));</div><div class="line">colMemo1.DefaultValue = <span class="string">"是 否 "</span>;</div><div class="line">GridView1.DataSource = dtFromDB;</div><div class="line">GridView1.DataBind();</div></pre></td></tr></table></figure><p>先加入欄位，並設定 DataColumn.DefaultValue ，結果呈現如下，<br><img src="/2018/07/20/2018026/001.png" alt="[DataColumn.DefaultValue 無效]" title="[DataColumn.DefaultValue 無效]"></p><p>因為我們是先將欄位加入，才設定值，所以它會沒有效。<br>所以如果這時，我們再加入一筆新的資料，它就會有效果，如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//取得原始的資料</span></div><div class="line"><span class="keyword">var</span> dtFromDB = GetDataSource();</div><div class="line"><span class="comment">//要額外加入欄位，並給予預設值</span></div><div class="line"><span class="keyword">var</span> colMemo1 = dtFromDB.Columns.Add(<span class="string">"缺料註記"</span>, <span class="keyword">typeof</span>(<span class="keyword">string</span>));</div><div class="line">colMemo1.DefaultValue = <span class="string">"是 否 "</span>;</div><div class="line">dtFromDB.Rows.Add(<span class="number">999</span>, <span class="string">$"產品名稱-999"</span>, <span class="string">$"產品描述 -999 "</span>, <span class="number">999</span>, DateTime.Now.ToString(<span class="string">"yyyy/MM/dd HH:mm:ss"</span>));</div><div class="line">GridView1.DataSource = dtFromDB;</div><div class="line">GridView1.DataBind();</div></pre></td></tr></table></figure><img src="/2018/07/20/2018026/003.png" alt="[新增的 DataRow DataColumn.DefaultValue 有效]" title="[新增的 DataRow DataColumn.DefaultValue 有效]"><p>所以，要讓 DataColumn.DefaultValue 一開始就要有效，就需要在建立 DataColumn 時，就指定它的預設值，如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//取得原始的資料</span></div><div class="line"><span class="keyword">var</span> dtFromDB = GetDataSource();</div><div class="line"><span class="comment">//要額外加入欄位，並給予預設值</span></div><div class="line"><span class="comment">//要先設定，再加入</span></div><div class="line"><span class="keyword">var</span> colMemo1 = <span class="keyword">new</span> DataColumn(<span class="string">"缺料註記"</span>, <span class="keyword">typeof</span>(<span class="keyword">string</span>));</div><div class="line">colMemo1.DefaultValue = <span class="string">"是 否 "</span>;</div><div class="line">dtFromDB.Columns.Add(colMemo1);</div><div class="line">GridView1.DataSource = dtFromDB;</div><div class="line">GridView1.DataBind();</div></pre></td></tr></table></figure><img src="/2018/07/20/2018026/002.png" alt="[先新增 DataColumn， DataColumn.DefaultValue 有效]" title="[先新增 DataColumn， DataColumn.DefaultValue 有效]"><p>雖然多一行，但是 DataColumn.DefaultValue 有效了哦! :)</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> DataTable <span class="title">GetDataSource</span>(<span class="params"></span>)</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line"><span class="comment">// Instantiating a "Products" DataTable object</span></div><div class="line"><span class="keyword">var</span> dataTable = <span class="keyword">new</span> DataTable(<span class="string">"Products"</span>);</div><div class="line"><span class="comment">// Adding columns to the DataTable object</span></div><div class="line">dataTable.Columns.Add(<span class="string">"ProductID"</span>, <span class="keyword">typeof</span>(Int32));</div><div class="line">dataTable.Columns.Add(<span class="string">"ProductName"</span>, <span class="keyword">typeof</span>(<span class="keyword">string</span>));</div><div class="line">dataTable.Columns.Add(<span class="string">"ProductDesc"</span>, <span class="keyword">typeof</span>(<span class="keyword">string</span>));</div><div class="line">dataTable.Columns.Add(<span class="string">"Units"</span>, <span class="keyword">typeof</span>(Double));</div><div class="line">dataTable.Columns.Add(<span class="string">"CreDte"</span>, <span class="keyword">typeof</span>(DateTime));</div><div class="line"><span class="keyword">var</span> rand = <span class="keyword">new</span> Random();</div><div class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">90</span>; i++)</div><div class="line">&#123;</div><div class="line">dataTable.Rows.Add(i, <span class="string">$"產品名稱-<span class="subst">&#123;i&#125;</span> 讓產品名稱自己說話 abc <span class="subst">&#123;i&#125;</span> ...<span class="subst">&#123;i&#125;</span>"</span>, <span class="string">$"產品描述 -<span class="subst">&#123;i&#125;</span>塑造出帶有「情感」的品牌概念 -<span class="subst">&#123;i&#125;</span>產品描述 -產品描述 -產品描述 -"</span>, rand.NextDouble(), DateTime.Now.ToString(<span class="string">"yyyy/MM/dd HH:mm:ss"</span>));</div><div class="line">&#125;</div><div class="line"><span class="keyword">return</span> dataTable;</div><div class="line">&#125;</div></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;最近需要將原本從資料庫取出的資料再加入額外的欄位，並給預設值。但是預設值卻沒有顯示出來，是什麼原因呢?&lt;/p&gt;
&lt;h3 id=&quot;解法&quot;&gt;&lt;a
      
    
    </summary>
    
    
      <category term="DataColumn" scheme="https://rainmakerho.github.io/tags/DataColumn/"/>
    
      <category term="DefaultValue" scheme="https://rainmakerho.github.io/tags/DefaultValue/"/>
    
  </entry>
  
  <entry>
    <title>In-House certificate 要過期了怎麼辦?</title>
    <link href="https://rainmakerho.github.io/2018/07/20/2018025/"/>
    <id>https://rainmakerho.github.io/2018/07/20/2018025/</id>
    <published>2018-07-20T01:17:13.000Z</published>
    <updated>2018-07-25T07:10:20.615Z</updated>
    
    <content type="html"><![CDATA[<h3 id="問題"><a href="#問題" class="headerlink" title="問題"></a>問題</h3><p>我們公司 Apple Enterprise Store 中的 In-House certificate 快過期了，而所有依據它所建罝出來的 Provisioning Profiles 也跟著快過期了，要怎麼辦呢? Revoke 嗎?</p><h3 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h3><p>如下圖，我們公司的 In-House certificate 有效只到 2018/8/2 ，到時我們相對應的 iOS App 不就 GG 了。 我們就只能等著它過期嗎 ? 過期後，會自動 renew 嗎?<br><img src="/2018/07/20/2018025/001.png" alt="[快過期的In-House certificate]" title="[快過期的In-House certificate]"></p><h4 id="Apple-Developer"><a href="#Apple-Developer" class="headerlink" title="Apple Developer"></a><a href="https://developer.apple.com" target="_blank" rel="external">Apple Developer</a></h4><p>嗯… 這時就需要再建立一個 In-House certificate，到 (<a href="https://developer.apple.com/account/ios/certificate/" target="_blank" rel="external">certificate</a>=&gt;Certificates) 按右上方的 + 號，Production 那選取「In-House and Ad Hoc」，如下圖(因為我已建立，最多同時只能有 2 個)，然後按下 Continue<br><img src="/2018/07/20/2018025/002.png" alt="[新增In-House certificate]" title="[新增In-House certificate]"></p><p>下個畫面就從本機上建立一個 Certificate Signing Request (CSR) 後，上傳給它，就可以建立第 2 個 In-House certificate 了哦! 如下圖，<br><img src="/2018/07/20/2018025/003.png" alt="[建立第2個In-House certificate]" title="[建立第2個In-House certificate]"></p><p>新的 In-House certificate 建立好了之後，在 App 那的 Provisioning Profiles 就可以選取新的 In-House certificate 後，按下 Generate 就可以了哦，如下圖，<br><img src="/2018/07/20/2018025/004.png" alt="[選取新的In-House certificate來建立 Provisioning Profile]" title="[選取新的In-House certificate來建立 Provisioning Profile]"></p><h4 id="Mac-開發環境"><a href="#Mac-開發環境" class="headerlink" title="Mac 開發環境"></a>Mac 開發環境</h4><p>在 <a href="https://developer.apple.com" target="_blank" rel="external">Apple Developer</a> 設定好了後，就可以在 Mac 開發環境中，開啟 Xcode 然後將 Provisioning Profiles 下載下來，如下圖，<br><img src="/2018/07/20/2018025/005.png" alt="[Xcode Preferences]" title="[Xcode Preferences]"><br><img src="/2018/07/20/2018025/006.png" alt="[Download Provisioning Profile]" title="[Download Provisioning Profile]"></p><p>然後就可以 Build 了哦!<br>那別的開發人員呢? 這時要將這台 In-House certificate 匯出(含 private key)給他們去安裝。</p><p>所以要開啟 keychain ，然後將 In-House certificate 匯出成 p12 的檔案 (含 private key)，並設定密碼，如下圖，<br><img src="/2018/07/20/2018025/007.png" alt="[Export In-House certificate]" title="[Export In-House certificate]"><br><img src="/2018/07/20/2018025/008.png" alt="[Export In-House certificate include private key]" title="[Export In-House certificate include private key]"></p><p>別人開發人員再匯入自已的 keychain (輸入該密碼)後，就可以從 Xcode 下載新的 Provisioning Profiles 來，並選取使用新的 In-House certificate 來 Build 哦!</p><p>註:</p><ol><li>這時您會發現環境中有 2 個 In-House certificate ，如果不會用到舊的就可以將它從 keychain 那刪除 (記得先備份出 p12 檔哦!)。</li><li>如果您出現 「error : No installed provisioning profiles match the installed iOS signing identities.」的錯誤，那應該是沒有下載對應的 Provisioning Profiles ，請重 Xcode 那手動下載。</li></ol><p>感謝同事 Henry 的幫忙 :)</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;問題&quot;&gt;&lt;a href=&quot;#問題&quot; class=&quot;headerlink&quot; title=&quot;問題&quot;&gt;&lt;/a&gt;問題&lt;/h3&gt;&lt;p&gt;我們公司 Apple Enterprise Store 中的 In-House certificate 快過期了，而所有依據它所建罝出來的 
      
    
    </summary>
    
    
      <category term="In-House certificate" scheme="https://rainmakerho.github.io/tags/In-House-certificate/"/>
    
      <category term="expired" scheme="https://rainmakerho.github.io/tags/expired/"/>
    
      <category term="Provisioning Profiles" scheme="https://rainmakerho.github.io/tags/Provisioning-Profiles/"/>
    
      <category term="Revoke" scheme="https://rainmakerho.github.io/tags/Revoke/"/>
    
      <category term="keychain" scheme="https://rainmakerho.github.io/tags/keychain/"/>
    
      <category term="No installed provisioning profiles" scheme="https://rainmakerho.github.io/tags/No-installed-provisioning-profiles/"/>
    
  </entry>
  
  <entry>
    <title>透過 Aspose 將 datatable 的資料轉出成有浮水印的 PDF 檔 (2)</title>
    <link href="https://rainmakerho.github.io/2018/07/13/2018024/"/>
    <id>https://rainmakerho.github.io/2018/07/13/2018024/</id>
    <published>2018-07-13T05:44:05.000Z</published>
    <updated>2018-07-17T05:55:29.704Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>在 <a href="https://rainmakerho.github.io/2018/07/03/2018022/">透過 Aspose 將 datatable 的資料轉出成有浮水印的 PDF 檔</a> 一文中，驗證可透過 Aspose 元件來達到將 DataTable 的資料轉成有浮水印的 PDF 檔案。但實際用在專案上還有段距離，例如，</p><ol><li>設定表頭/表尾</li><li>欄位名稱可否換行，對齊方式</li><li>可否設定欄位的寬度，格式(日期、數值)，對齊方式</li><li>可否設定列印比例</li><li>浮水印要有一定的覆蓋比率</li></ol><h3 id="實作"><a href="#實作" class="headerlink" title="實作"></a>實作</h3><p><strong>DataTable =&gt; 換 ColumnName =&gt; Excel =&gt; Pdf =&gt; Pdf+浮水印</strong><br>以上面的需求，我們可以將程式切分成 2 段，一是 DataTable 轉資料到 Excel 轉存成 PDF，二再將該 PDF 加上浮水印。</p><ol><li><p><strong>設定表頭/表尾</strong><br>可以透過 PageSetup.SetHeader(0, “表頭左邊”); 或是 PageSetup.SetFooter(2, “表尾右邊”); 它是使用 0 ~ 2 來表示 左、中、右 區段。這裡有一個部份要注意的是，如果在表頭、表尾區段要換行的話，也是使用 \n 嗎? 不可以哦~ 用 \n 中間會多一行哦! 所以這裡要改用 <strong>\r</strong> 才可以哦!</p></li><li><p><strong>欄位名稱可否換行，對齊方式</strong><br>在 ColumnName 中加入 \n 來換行，同時要設定 Cell 的 Stype IsTextWrapped 值為 true。如果 IsTextWrapped 設定為 fasle 的話，在 ColumnName 設定 \n 也不會換行的哦! 另外，程式中會呼叫 <a href="https://apireference.aspose.com/net/cells/aspose.cells/worksheet/methods/autofitcolumns" target="_blank" rel="external">AutoFitColumns</a> 及 <a href="https://apireference.aspose.com/net/cells/aspose.cells/worksheet/methods/autofitrows" target="_blank" rel="external">AutoFitRows</a> ，所以要讓它可以計算正常的話，請記得要設定系統中有的字型哦~ 例如「標楷體」</p></li><li><p><strong>可否設定欄位的寬度，格式(日期、數值)，對齊方式</strong><br>可以透過 Worksheet.Cells.SetColumnWidth 來設定欄寬 (0~255)<a href="https://apireference.aspose.com/net/cells/aspose.cells/cells/methods/setcolumnwidth" target="_blank" rel="external">Cells.SetColumnWidth</a>，因為在設定欄位部份，除了設定顯示名稱之外，多了一個設定欄寬 及 欄位的屬性(用於格式(日期、數值)，對齊方式)，所以傳遞參數中我們改用 <a href="https://msdn.microsoft.com/zh-tw/library/system.tuple(v=vs.110" target="_blank" rel="external">Tuple</a>.aspx&gt;) 可以讓我們存放多個值。</p></li><li><p><strong>可否設定列印比例</strong><br>可以設定 PageSetup.Zoom 的值 (10~400)，預設值是 100。有時如果我們的內容太長時，有可能會跨頁，所以我們可以設定「列印比例」來讓 Excel 印到 PDF 時，可以縮到一頁以內，這時就可以設定這個值了哦!</p></li><li><p><strong>浮水印要有一定的覆蓋比率</strong><br>在 PDF 要使用浮水印，我們可以透過 Stamp 物件來貼到 PDF 文件之中，因為我們範例是使用文字，所以是建立 TextStamp 物件，要針對文字做處理，可以透過 FormattedText 來處理。所以，如果浮水印要換行的話，可以使用 \n 或是加入 Environment.NewLine 即可。<br>建立好 TextStamp 後，就要依需求來貼到 PDF 之中，如果是蓋滿整個 PDF 文件的話，就可以設定 TextStamp 物件的 Width, Height 跟 PDF Page 的 CropBox Width 及 Height 一樣的大小。<br>如果是要依 TextStamp 物件去蓋滿 PDF Page 的話，就可以從 PDF Page 的 CropBox Width 及 Height 去 loop 貼到 PDF Page 上。</p></li></ol><p>透過以上的分析後，我們就可以將它抽出來成為公用的 PDFReportUtility Class，如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PDFReportUtility</span></div><div class="line">&#123;</div><div class="line"></div><div class="line"><span class="comment">// 增加功能</span></div><div class="line"><span class="comment">// 1.excel header 及 footer 及 可設定欄寬</span></div><div class="line"><span class="comment">// 2.pdf watermark 整頁或是充滿</span></div><div class="line"></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> DataTable 轉到 Excel 的參數</span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> 2018/07/16 欄位需要設定數值或是日期</span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></div><div class="line"><span class="keyword">public</span> <span class="keyword">struct</span> ExportDataTable2ExcelArg</div><div class="line">&#123;</div><div class="line"><span class="keyword">public</span> DataTable dataSource;</div><div class="line"><span class="comment">//columnId, columnDisplayName, columnWidth, cloumnStyle</span></div><div class="line"><span class="keyword">public</span> Dictionary&lt;<span class="keyword">string</span>, Tuple&lt;<span class="keyword">string</span>, <span class="keyword">double</span>, Style&gt;&gt; ColumnInfos;</div><div class="line"><span class="comment">//是否允許換行</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">bool</span> IsTextWrapped;</div><div class="line"><span class="comment">//字型名稱，如果不允許換行的話，autoFitColumns 會依字型去算寬度</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">string</span> FontName;</div><div class="line"><span class="comment">//直/橫 印</span></div><div class="line"><span class="keyword">public</span> PageOrientationType PageOrientation;</div><div class="line"><span class="comment">//縮放比例</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">int</span> PageScale; <span class="comment">//10~400</span></div><div class="line"></div><div class="line"><span class="comment">//表頭 左、中、右</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">string</span> HeaderLeft;</div><div class="line"><span class="keyword">public</span> <span class="keyword">string</span> HeaderCenter;</div><div class="line"><span class="keyword">public</span> <span class="keyword">string</span> HeaderRight;</div><div class="line"><span class="comment">//表尾 左、中、右</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">string</span> FooterLeft;</div><div class="line"><span class="keyword">public</span> <span class="keyword">string</span> FooterCenter;</div><div class="line"><span class="keyword">public</span> <span class="keyword">string</span> FooterRight;</div><div class="line"><span class="comment">//欄位對齊方式</span></div><div class="line"><span class="keyword">public</span> TextAlignmentType HeaderHorizontalAlignment;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> 浮水印設定參數</span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line"><span class="keyword">public</span> <span class="keyword">struct</span> WatermarkArg</div><div class="line">&#123;</div><div class="line"><span class="comment">//浮水印字串</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">string</span> Watermark;</div><div class="line"><span class="comment">//浮水印 Stamp 的 Height</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">double</span> WatermarkHeight;</div><div class="line"><span class="comment">//浮水印 Stamp 的 Width</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">double</span> WatermarkWidth;</div><div class="line"><span class="comment">//浮水印 Stamp 的 水平間隔</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">double</span> WatermarkHorizontalSpace;</div><div class="line"><span class="comment">//浮水印 Stamp 的 垂直間隔</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">double</span> WatermarkVerticalSpace;</div><div class="line"><span class="comment">//浮水印 Stamp 貼上Style，目前有蓋滿一頁及水平蓋滿</span></div><div class="line"><span class="keyword">public</span> WatermarkStyle WMStyle;</div><div class="line"><span class="comment">//不透明度 0~ `</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">double</span> Opacity;</div><div class="line"><span class="comment">//旋轉角度</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">double</span> RotateAngle;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> WatermarkStyle</div><div class="line">&#123;</div><div class="line"><span class="comment">//蓋滿一頁</span></div><div class="line">FitPage,</div><div class="line"><span class="comment">//水平蓋滿</span></div><div class="line">RepeatHorizontal</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> 設定 DataTable 的 Column Name</span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="dt"&gt;</span>datatable<span class="doctag">&lt;/param&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="columnInfos"&gt;</span>item1:Column Name, item2:Column Width<span class="doctag">&lt;/param&gt;</span></span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ChangedDataTableColumnName</span>(<span class="params">DataTable dt, Dictionary&lt;<span class="keyword">string</span>, Tuple&lt;<span class="keyword">string</span>, <span class="keyword">double</span>, Style&gt;&gt; columnInfos</span>)</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line"></div><div class="line"><span class="comment">//change columnName</span></div><div class="line"><span class="keyword">if</span> (columnInfos != <span class="literal">null</span>)</div><div class="line">&#123;</div><div class="line"><span class="keyword">foreach</span> (KeyValuePair&lt;<span class="keyword">string</span>, Tuple&lt;<span class="keyword">string</span>, <span class="keyword">double</span>, Style&gt;&gt; columnInfo <span class="keyword">in</span> columnInfos)</div><div class="line">&#123;</div><div class="line"><span class="keyword">if</span> (dt.Columns[columnInfo.Key] != <span class="literal">null</span>)</div><div class="line">dt.Columns[columnInfo.Key].ColumnName = columnInfo.Value.Item1;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> 設定 Worksheet 的 欄位寬度</span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="sheet"&gt;</span>綁定 DataTable 的 Worksheet <span class="doctag">&lt;/param&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="columnInfos"&gt;</span>item1:Column Name, item2:Column Width<span class="doctag">&lt;/param&gt;</span></span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ChangedSheetColumnStyle</span>(<span class="params">Worksheet sheet, Dictionary&lt;<span class="keyword">string</span>, Tuple&lt;<span class="keyword">string</span>, <span class="keyword">double</span>, Style&gt;&gt; columnInfos, TextAlignmentType headerHorizontalAlignment</span>)</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line"><span class="comment">//change columnName</span></div><div class="line"><span class="keyword">if</span> (columnInfos != <span class="literal">null</span>)</div><div class="line">&#123;</div><div class="line"><span class="keyword">var</span> columnIndex = <span class="number">0</span>;</div><div class="line"><span class="keyword">foreach</span> (KeyValuePair&lt;<span class="keyword">string</span>, Tuple&lt;<span class="keyword">string</span>, <span class="keyword">double</span>, Style&gt;&gt; columnInfo <span class="keyword">in</span> columnInfos)</div><div class="line">&#123;</div><div class="line"><span class="keyword">if</span> (columnInfo.Value.Item2 &gt; <span class="number">-1</span>)</div><div class="line">&#123;</div><div class="line">sheet.Cells.SetColumnWidth(columnIndex, columnInfo.Value.Item2);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span>(columnInfo.Value.Item3 != <span class="literal">null</span>)</div><div class="line">&#123;</div><div class="line"><span class="keyword">var</span> styleFlag = <span class="keyword">new</span> StyleFlag();</div><div class="line">styleFlag.NumberFormat = <span class="literal">true</span>;</div><div class="line">styleFlag.HorizontalAlignment = <span class="literal">true</span>;</div><div class="line">sheet.Cells.Columns[columnIndex].ApplyStyle(columnInfo.Value.Item3, styleFlag);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//設定 header 列</span></div><div class="line"><span class="keyword">var</span> cellStyle = sheet.Cells[columnIndex, <span class="number">0</span>].GetStyle();</div><div class="line"><span class="keyword">var</span> cellStyleFlag = <span class="keyword">new</span> StyleFlag();</div><div class="line">cellStyleFlag.HorizontalAlignment = <span class="literal">true</span>;</div><div class="line">cellStyle.HorizontalAlignment = headerHorizontalAlignment;</div><div class="line">sheet.Cells[<span class="number">0</span>, columnIndex].SetStyle(cellStyle, cellStyleFlag);</div><div class="line">columnIndex++;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> 將 DataTable 的資料轉到Excel處理並存成 PDF Stream</span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="arg"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MemoryStream <span class="title">GenPDFFromDataTable</span>(<span class="params">ExportDataTable2ExcelArg arg</span>)</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line"><span class="comment">//Change DataTable's ColumnName</span></div><div class="line">ChangedDataTableColumnName(arg.dataSource, arg.ColumnInfos);</div><div class="line"></div><div class="line"><span class="comment">//proc excel</span></div><div class="line"><span class="comment">// Instantiating a Workbook object</span></div><div class="line"><span class="keyword">var</span> workbook = <span class="keyword">new</span> Workbook();</div><div class="line"><span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrWhiteSpace(arg.FontName))</div><div class="line">&#123;</div><div class="line"><span class="keyword">var</span> wbStyle = workbook.DefaultStyle;</div><div class="line">wbStyle.Font.Name = arg.FontName;</div><div class="line">workbook.DefaultStyle = wbStyle;</div><div class="line">&#125;</div><div class="line"><span class="keyword">var</span> worksheet = workbook.Worksheets[<span class="number">0</span>];</div><div class="line">worksheet.Cells.ImportDataTable(arg.dataSource, <span class="literal">true</span>, <span class="string">"A1"</span>);</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//https://docs.aspose.com/display/cellsnet/Setting+Page+Options</span></div><div class="line"><span class="keyword">var</span> pageSetup = workbook.Worksheets[<span class="number">0</span>].PageSetup;</div><div class="line">pageSetup.PrintTitleRows = <span class="string">"$1:$1"</span>;</div><div class="line">pageSetup.IsPercentScale = <span class="literal">true</span>;</div><div class="line">pageSetup.Orientation = arg.PageOrientation;</div><div class="line">pageSetup.Zoom = arg.PageScale &lt; <span class="number">10</span> ? <span class="number">100</span> : arg.PageScale;</div><div class="line"><span class="comment">//https://docs.aspose.com/display/cellsnet/Setting+Headers+and+Footers</span></div><div class="line"><span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrEmpty(arg.HeaderLeft))</div><div class="line">&#123;</div><div class="line">pageSetup.SetHeader(<span class="number">0</span>, arg.HeaderLeft);</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrEmpty(arg.HeaderCenter))</div><div class="line">&#123;</div><div class="line">pageSetup.SetHeader(<span class="number">1</span>, arg.HeaderCenter);</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrEmpty(arg.HeaderRight))</div><div class="line">&#123;</div><div class="line">pageSetup.SetHeader(<span class="number">2</span>, arg.HeaderRight);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrEmpty(arg.FooterLeft))</div><div class="line">&#123;</div><div class="line">pageSetup.SetFooter(<span class="number">0</span>, arg.FooterLeft);</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrEmpty(arg.FooterCenter))</div><div class="line">&#123;</div><div class="line">pageSetup.SetFooter(<span class="number">1</span>, arg.FooterCenter);</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrEmpty(arg.FooterRight))</div><div class="line">&#123;</div><div class="line">pageSetup.SetFooter(<span class="number">2</span>, arg.FooterRight);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> range = worksheet.Cells.MaxDisplayRange;</div><div class="line"><span class="comment">//border</span></div><div class="line"><span class="comment">//Setting border for each cell in the range</span></div><div class="line"><span class="keyword">var</span> style = workbook.CreateStyle();</div><div class="line"><span class="keyword">var</span> colorBlack = System.Drawing.Color.Black;</div><div class="line">style.SetBorder(BorderType.BottomBorder, CellBorderType.Medium, colorBlack);</div><div class="line">style.SetBorder(BorderType.LeftBorder, CellBorderType.Medium, colorBlack);</div><div class="line">style.SetBorder(BorderType.RightBorder, CellBorderType.Medium, colorBlack);</div><div class="line">style.SetBorder(BorderType.TopBorder, CellBorderType.Medium, colorBlack);</div><div class="line">style.IsTextWrapped = arg.IsTextWrapped;</div><div class="line">range.SetStyle(style);</div><div class="line">worksheet.AutoFitColumns();</div><div class="line"><span class="comment">//adjust columns</span></div><div class="line">ChangedSheetColumnStyle(worksheet, arg.ColumnInfos, arg.HeaderHorizontalAlignment);</div><div class="line">worksheet.AutoFitRows();</div><div class="line"><span class="comment">//string xlsFile = Path.Combine(HttpContext.Current.Server.MapPath("./data"), $"test.xlsx");</span></div><div class="line"><span class="comment">//workbook.Save(xlsFile, Aspose.Cells.SaveFormat.Xlsx);</span></div><div class="line"><span class="comment">//save to stream</span></div><div class="line"><span class="keyword">var</span> pdfStream = <span class="keyword">new</span> MemoryStream();</div><div class="line">workbook.Save(pdfStream, Aspose.Cells.SaveFormat.Pdf);</div><div class="line"></div><div class="line"><span class="keyword">return</span> pdfStream;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> 將 PDF 加上 浮水印</span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="pdfStream"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="arg"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MemoryStream <span class="title">AddWatermark</span>(<span class="params">MemoryStream pdfStream, WatermarkArg arg</span>)</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line"></div><div class="line"><span class="keyword">var</span> pdfDocument = <span class="keyword">new</span> Aspose.Pdf.Document(pdfStream);</div><div class="line"><span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrWhiteSpace(arg.Watermark))</div><div class="line">&#123;</div><div class="line"><span class="keyword">var</span> text = <span class="keyword">new</span> FormattedText(arg.Watermark);</div><div class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> page <span class="keyword">in</span> pdfDocument.Pages)</div><div class="line">&#123;</div><div class="line"><span class="keyword">switch</span> (arg.WMStyle)</div><div class="line">&#123;</div><div class="line"><span class="keyword">case</span> WatermarkStyle.FitPage:</div><div class="line">AddWatermarkFitPage(page, arg);</div><div class="line"><span class="keyword">break</span>;</div><div class="line"><span class="keyword">case</span> WatermarkStyle.RepeatHorizontal:</div><div class="line">AddWatermarkRepeatHorizontal(page, arg);</div><div class="line"><span class="keyword">break</span>;</div><div class="line"></div><div class="line"><span class="keyword">default</span>:</div><div class="line"><span class="keyword">break</span>;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">var</span> newPdfStream = <span class="keyword">new</span> MemoryStream();</div><div class="line">pdfDocument.Save(newPdfStream);</div><div class="line"><span class="keyword">return</span> newPdfStream;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> 浮水印跟頁面一樣大</span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="pdfPage"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="arg"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">AddWatermarkFitPage</span>(<span class="params">Aspose.Pdf.Page pdfPage, WatermarkArg arg</span>)</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line"><span class="keyword">var</span> text = <span class="keyword">new</span> FormattedText(arg.Watermark);</div><div class="line"><span class="keyword">var</span> stamp = <span class="keyword">new</span> TextStamp(text);</div><div class="line">stamp.RotateAngle = arg.RotateAngle;</div><div class="line">stamp.XIndent = arg.WatermarkHorizontalSpace;</div><div class="line">stamp.YIndent = arg.WatermarkVerticalSpace;</div><div class="line">stamp.Opacity = arg.Opacity;</div><div class="line">stamp.Width = pdfPage.CropBox.Width;</div><div class="line">stamp.Height = pdfPage.CropBox.Height;</div><div class="line">pdfPage.AddStamp(stamp);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//最小的 浮水印 長、寬</span></div><div class="line"><span class="keyword">const</span> <span class="keyword">double</span> minValue = <span class="number">30</span>;</div><div class="line"></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> 依 浮水印 水平地蓋滿整個頁面</span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="pdfPage"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="arg"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">AddWatermarkRepeatHorizontal</span>(<span class="params">Aspose.Pdf.Page pdfPage, WatermarkArg arg</span>)</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (arg.WatermarkHeight &lt; minValue)</div><div class="line"><span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">$"<span class="subst">&#123;<span class="keyword">nameof</span>(arg.WatermarkHeight)&#125;</span> must greater than <span class="subst">&#123;minValue&#125;</span>"</span>);</div><div class="line"><span class="keyword">if</span> (arg.WatermarkWidth &lt; minValue)</div><div class="line"><span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">$"<span class="subst">&#123;<span class="keyword">nameof</span>(arg.WatermarkWidth)&#125;</span> must greater than <span class="subst">&#123;minValue&#125;</span>"</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> text = <span class="keyword">new</span> FormattedText(arg.Watermark);</div><div class="line"><span class="keyword">var</span> yIndent = pdfPage.CropBox.Height - arg.WatermarkHeight;</div><div class="line"><span class="keyword">var</span> yLimit = <span class="number">0</span> - (arg.WatermarkHeight + arg.WatermarkVerticalSpace);</div><div class="line"><span class="keyword">var</span> pageWidth = pdfPage.CropBox.Width;</div><div class="line"><span class="keyword">var</span> xIndent = <span class="number">0</span>d;</div><div class="line"><span class="keyword">while</span> (yIndent &gt; yLimit)</div><div class="line">&#123;</div><div class="line"><span class="keyword">while</span> (xIndent &lt; pageWidth)</div><div class="line">&#123;</div><div class="line"><span class="keyword">var</span> stamp = <span class="keyword">new</span> TextStamp(text);</div><div class="line">stamp.RotateAngle = arg.RotateAngle;</div><div class="line">stamp.XIndent = xIndent;</div><div class="line">stamp.YIndent = yIndent;</div><div class="line">stamp.Opacity = arg.Opacity;</div><div class="line">stamp.Width = arg.WatermarkWidth;</div><div class="line">stamp.Height = arg.WatermarkHeight;</div><div class="line">pdfPage.AddStamp(stamp);</div><div class="line">xIndent += (arg.WatermarkWidth + arg.WatermarkHorizontalSpace);</div><div class="line">&#125;</div><div class="line">xIndent = <span class="number">0</span>;</div><div class="line"><span class="keyword">var</span> yIdentReduce = (arg.WatermarkHeight + arg.WatermarkVerticalSpace);</div><div class="line"></div><div class="line">yIndent -= yIdentReduce;</div><div class="line">&#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> 以角度線性期function來呈現</span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="pdfPage"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="arg"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">AddWatermarkRepeatRotateAngle</span>(<span class="params">Aspose.Pdf.Page pdfPage, WatermarkArg arg</span>)</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (arg.WatermarkHeight &lt; minValue)</div><div class="line"><span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">$"<span class="subst">&#123;<span class="keyword">nameof</span>(arg.WatermarkHeight)&#125;</span> must greater than <span class="subst">&#123;minValue&#125;</span>"</span>);</div><div class="line"><span class="keyword">if</span> (arg.WatermarkWidth &lt; minValue)</div><div class="line"><span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">$"<span class="subst">&#123;<span class="keyword">nameof</span>(arg.WatermarkWidth)&#125;</span> must greater than <span class="subst">&#123;minValue&#125;</span>"</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> text = <span class="keyword">new</span> FormattedText(arg.Watermark);</div><div class="line"><span class="keyword">var</span> yIndent = pdfPage.CropBox.Height - arg.WatermarkHeight;</div><div class="line"><span class="keyword">var</span> yLimit = <span class="number">0</span> - (arg.WatermarkHeight + arg.WatermarkVerticalSpace);</div><div class="line"><span class="keyword">var</span> pageWidth = pdfPage.CropBox.Width;</div><div class="line"><span class="keyword">var</span> pageHeight = pdfPage.CropBox.Height;</div><div class="line"><span class="keyword">var</span> xIndent = <span class="number">0</span>d;</div><div class="line"><span class="keyword">while</span> (yIndent &gt; yLimit)</div><div class="line">&#123;</div><div class="line"><span class="keyword">var</span> y = yIndent;</div><div class="line"><span class="keyword">while</span> (xIndent &lt; pageWidth &amp;&amp; y &lt; pageHeight)</div><div class="line">&#123;</div><div class="line"><span class="keyword">var</span> stamp = <span class="keyword">new</span> TextStamp(text);</div><div class="line">stamp.RotateAngle = arg.RotateAngle;</div><div class="line">stamp.XIndent = xIndent;</div><div class="line">stamp.YIndent = y;</div><div class="line">stamp.Opacity = arg.Opacity;</div><div class="line">stamp.Width = arg.WatermarkWidth;</div><div class="line">stamp.Height = arg.WatermarkHeight;</div><div class="line">pdfPage.AddStamp(stamp);</div><div class="line">xIndent += (arg.WatermarkWidth + arg.WatermarkHorizontalSpace);</div><div class="line">xIndent = xIndent + Math.Cos(<span class="number">30</span>) * arg.WatermarkWidth;</div><div class="line">y = y + Math.Sign(<span class="number">30</span>) * (arg.WatermarkHeight + arg.WatermarkVerticalSpace);</div><div class="line">&#125;</div><div class="line">xIndent = <span class="number">0</span>;</div><div class="line"><span class="keyword">var</span> yIdentReduce = (arg.WatermarkHeight + arg.WatermarkVerticalSpace);</div><div class="line">yIndent -= yIdentReduce;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//到底了，要再連走 X</span></div><div class="line"><span class="keyword">var</span> baseX = <span class="number">0</span>d;</div><div class="line"><span class="keyword">while</span> (baseX &lt; pageWidth)</div><div class="line">&#123;</div><div class="line"><span class="keyword">var</span> y = yIndent;</div><div class="line">xIndent = baseX;</div><div class="line"><span class="keyword">while</span> (xIndent &lt; pageWidth)</div><div class="line">&#123;</div><div class="line"><span class="keyword">var</span> stamp = <span class="keyword">new</span> TextStamp(text);</div><div class="line">stamp.RotateAngle = arg.RotateAngle;</div><div class="line">stamp.XIndent = xIndent;</div><div class="line">stamp.YIndent = y;</div><div class="line">stamp.Opacity = arg.Opacity;</div><div class="line">stamp.Width = arg.WatermarkWidth;</div><div class="line">stamp.Height = arg.WatermarkHeight;</div><div class="line">pdfPage.AddStamp(stamp);</div><div class="line">xIndent += (arg.WatermarkWidth + arg.WatermarkHorizontalSpace);</div><div class="line">xIndent = xIndent + Math.Cos(<span class="number">30</span>) * arg.WatermarkWidth;</div><div class="line">y = y + Math.Sign(<span class="number">30</span>) * (arg.WatermarkHeight + arg.WatermarkVerticalSpace);</div><div class="line">&#125;</div><div class="line">baseX += (arg.WatermarkWidth + arg.WatermarkHorizontalSpace); ;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="測試"><a href="#測試" class="headerlink" title="測試"></a>測試</h3><p>所以我們新增 2 個 Button 來測試，</p><p><em>註: 因為共用的 function 都是回傳 Stream，所以這們可以將做好的 PDF 檔放到 Byte Array 之中，再透過 Response.BinaryWrite 傳給使用者下載檔案 ^\</em>^_</p><p>產生測試的 DataTable</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> DataTable <span class="title">GetDataSource</span>(<span class="params"></span>)</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line"><span class="comment">// Instantiating a "Products" DataTable object</span></div><div class="line"><span class="keyword">var</span> dataTable = <span class="keyword">new</span> DataTable(<span class="string">"Products"</span>);</div><div class="line"><span class="comment">// Adding columns to the DataTable object</span></div><div class="line">dataTable.Columns.Add(<span class="string">"ProductID"</span>, <span class="keyword">typeof</span>(Int32));</div><div class="line">dataTable.Columns.Add(<span class="string">"ProductName"</span>, <span class="keyword">typeof</span>(<span class="keyword">string</span>));</div><div class="line">dataTable.Columns.Add(<span class="string">"ProductDesc"</span>, <span class="keyword">typeof</span>(<span class="keyword">string</span>));</div><div class="line">dataTable.Columns.Add(<span class="string">"Units"</span>, <span class="keyword">typeof</span>(Double));</div><div class="line">dataTable.Columns.Add(<span class="string">"CreDte"</span>, <span class="keyword">typeof</span>(DateTime));</div><div class="line"><span class="keyword">var</span> rand = <span class="keyword">new</span> Random();</div><div class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">90</span>; i++)</div><div class="line">&#123;</div><div class="line">dataTable.Rows.Add(i, <span class="string">$"產品名稱-<span class="subst">&#123;i&#125;</span> 讓產品名稱自己說話 abc <span class="subst">&#123;i&#125;</span> ...<span class="subst">&#123;i&#125;</span>"</span>, <span class="string">$"產品描述 -<span class="subst">&#123;i&#125;</span>塑造出帶有「情感」的品牌概念 -<span class="subst">&#123;i&#125;</span>產品描述 -產品描述 -產品描述 -"</span>, rand.NextDouble(), DateTime.Now.ToString(<span class="string">"yyyy/MM/dd HH:mm:ss"</span>));</div><div class="line">&#125;</div><div class="line"><span class="keyword">return</span> dataTable;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>1.ColumnName 換行，IsTextWrapped = true, 設定寬度為 5，右表頭加入 2 列(換行)，設定日期格式，第一列表頭對齊方式為置中，浮水印蓋滿一頁。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">btnGenPDFFitPage_Click</span>(<span class="params"><span class="keyword">object</span> sender, EventArgs e</span>)</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line"></div><div class="line"><span class="keyword">var</span> excelArg = <span class="keyword">new</span> ExportDataTable2ExcelArg</div><div class="line">&#123;</div><div class="line">dataSource = GetDataSource(),</div><div class="line">HeaderCenter = <span class="string">"&amp;24 This is Report Header ..."</span>,</div><div class="line">HeaderRight = <span class="string">$"&amp;10 使用者:Rainmaker\r日期:<span class="subst">&#123;DateTime.Now.ToString(<span class="string">"yyyy/MM/dd HH:mm:ss"</span>)&#125;</span>"</span>,</div><div class="line">FooterRight = <span class="string">"&amp;10 &amp;P/&amp;N"</span>,</div><div class="line">ColumnInfos = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, Tuple&lt;<span class="keyword">string</span>, <span class="keyword">double</span>, Aspose.Cells.Style&gt;&gt;</div><div class="line">&#123;</div><div class="line">&#123;<span class="string">"ProductID"</span>, <span class="keyword">new</span> Tuple&lt;<span class="keyword">string</span>, <span class="keyword">double</span>, Aspose.Cells.Style&gt;(<span class="string">$"產品\n代號"</span>, <span class="number">5</span>, <span class="literal">null</span>) &#125;,</div><div class="line">&#123;<span class="string">"ProductName"</span>, <span class="keyword">new</span> Tuple&lt;<span class="keyword">string</span>, <span class="keyword">double</span>, Aspose.Cells.Style&gt;(<span class="string">"產品名稱"</span> , <span class="number">-1</span>, <span class="literal">null</span>) &#125;,</div><div class="line">&#123;<span class="string">"ProductDesc"</span>, <span class="keyword">new</span> Tuple&lt;<span class="keyword">string</span>, <span class="keyword">double</span>, Aspose.Cells.Style&gt;(<span class="string">"產品 \n描述"</span> , <span class="number">-1</span>,<span class="literal">null</span>) &#125;,</div><div class="line">&#123;<span class="string">"Units"</span>, <span class="keyword">new</span> Tuple&lt;<span class="keyword">string</span>, <span class="keyword">double</span>, Aspose.Cells.Style&gt;(<span class="string">"產品 庫存"</span> , <span class="number">-1</span>, <span class="keyword">new</span> Aspose.Cells.Style&#123;  HorizontalAlignment= TextAlignmentType.Center&#125;)&#125;,</div><div class="line"> &#123;<span class="string">"CreDte"</span>, <span class="keyword">new</span> Tuple&lt;<span class="keyword">string</span>, <span class="keyword">double</span>, Aspose.Cells.Style&gt;(<span class="string">"日期"</span> , <span class="number">20</span>, <span class="keyword">new</span> Aspose.Cells.Style&#123; Number=<span class="number">22</span>, Custom = <span class="string">"yyyy/mm/dd hh:mm:ss"</span> , HorizontalAlignment= TextAlignmentType.Center&#125;) &#125;</div><div class="line">&#125;,</div><div class="line">PageOrientation = PageOrientationType.Landscape,</div><div class="line">IsTextWrapped = <span class="literal">true</span>,</div><div class="line">PageScale = <span class="number">80</span>,</div><div class="line">HeaderHorizontalAlignment = TextAlignmentType.Center</div><div class="line">&#125;;</div><div class="line"><span class="keyword">var</span> pdfStream = GenPDFFromDataTable(excelArg);</div><div class="line"><span class="keyword">var</span> fileNameWithoutExt = <span class="string">$"<span class="subst">&#123;Guid.NewGuid().ToString(<span class="string">"N"</span>)&#125;</span>"</span>;</div><div class="line"><span class="comment">//string pdfFileName = Path.Combine(Server.MapPath("./data"), $"&#123;fileNameWithoutExt&#125;_temp.pdf");</span></div><div class="line"><span class="comment">//using (FileStream file = new FileStream(pdfFileName, FileMode.Create, System.IO.FileAccess.Write))</span></div><div class="line"><span class="comment">//    pdfStream.CopyTo(file);</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> watermarkArg = <span class="keyword">new</span> WatermarkArg</div><div class="line">&#123;</div><div class="line">Watermark = <span class="string">$"* 使用者:亂馬客 *<span class="subst">&#123;Environment.NewLine&#125;</span><span class="subst">&#123;DateTime.Now.ToString(<span class="string">"yyyy/MM/dd HH:mm:ss"</span>)&#125;</span>"</span>,</div><div class="line">WMStyle = WatermarkStyle.FitPage,</div><div class="line">RotateAngle = <span class="number">0</span>,</div><div class="line">Opacity = <span class="number">.1</span></div><div class="line"></div><div class="line">&#125;;</div><div class="line"><span class="keyword">var</span> waterStream = AddWatermark(pdfStream, watermarkArg);</div><div class="line"><span class="comment">//另存檔案</span></div><div class="line"><span class="comment">//string watermarkFileName = Path.Combine(Server.MapPath("./data"), $"&#123;fileNameWithoutExt&#125;.pdf");</span></div><div class="line"><span class="comment">//using (FileStream file = new FileStream(watermarkFileName, FileMode.Create, System.IO.FileAccess.Write))</span></div><div class="line"><span class="comment">//    waterStream.CopyTo(file);</span></div><div class="line"><span class="comment">//直接給Client</span></div><div class="line">Response.ContentType = <span class="string">"application/pdf"</span>;</div><div class="line">Response.AddHeader(<span class="string">"content-disposition"</span>, <span class="string">"attachment; filename="</span> + <span class="string">$"<span class="subst">&#123;fileNameWithoutExt&#125;</span>.pdf"</span>);</div><div class="line"><span class="keyword">var</span> fileSize = waterStream.Length;</div><div class="line"><span class="keyword">byte</span>[] pdfBuffer = <span class="keyword">new</span> <span class="keyword">byte</span>[(<span class="keyword">int</span>)fileSize];</div><div class="line">waterStream.Read(pdfBuffer, <span class="number">0</span>, (<span class="keyword">int</span>)fileSize);</div><div class="line">waterStream.Close();</div><div class="line">Response.BinaryWrite(pdfBuffer);</div><div class="line">Response.End();</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>產生出來的 PDF 如下圖，<br><img src="/2018/07/13/2018024/onePage.png" alt="[浮水印蓋滿一頁的PDF]" title="[浮水印蓋滿一頁的PDF]"></p><p>2.ColumnName 自動調整，IsTextWrapped = false，列印比例設定為 90，右表頭加入 2 列(換行)，Cell 字型設定為 “標楷體”(請檢查 Windows\fonts 中是否有該字型)，浮水印水平蓋滿一頁，旋轉角度 30 度。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">btnGenPDFRepeatHorizontal_Click</span>(<span class="params"><span class="keyword">object</span> sender, EventArgs e</span>)</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line"><span class="keyword">var</span> excelArg = <span class="keyword">new</span> ExportDataTable2ExcelArg</div><div class="line">&#123;</div><div class="line">dataSource = GetDataSource(),</div><div class="line">HeaderCenter = <span class="string">"&amp;24 This is Report Header ..."</span>,</div><div class="line">HeaderRight = <span class="string">$"&amp;12 使用者:Rainmaker\r日期:<span class="subst">&#123;DateTime.Now.ToString(<span class="string">"yyyy/MM/dd HH:mm:ss"</span>)&#125;</span>"</span>,</div><div class="line">FooterRight = <span class="string">"&amp;10 &amp;P/&amp;N"</span>,</div><div class="line">ColumnInfos = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, Tuple&lt;<span class="keyword">string</span>, <span class="keyword">double</span>, Aspose.Cells.Style&gt;&gt;</div><div class="line">&#123;</div><div class="line">&#123;<span class="string">"ProductID"</span>, <span class="keyword">new</span> Tuple&lt;<span class="keyword">string</span>, <span class="keyword">double</span>, Aspose.Cells.Style&gt;(<span class="string">$"產品代號"</span>, <span class="number">-1</span>, <span class="literal">null</span>) &#125;,</div><div class="line">&#123;<span class="string">"ProductName"</span>, <span class="keyword">new</span> Tuple&lt;<span class="keyword">string</span>, <span class="keyword">double</span>, Aspose.Cells.Style&gt;(<span class="string">"產品名稱"</span> , <span class="number">-1</span>, <span class="literal">null</span>) &#125;,</div><div class="line">&#123;<span class="string">"ProductDesc"</span>, <span class="keyword">new</span> Tuple&lt;<span class="keyword">string</span>, <span class="keyword">double</span>, Aspose.Cells.Style&gt;(<span class="string">"產品描述"</span> , <span class="number">-1</span>, <span class="literal">null</span>) &#125;,</div><div class="line">&#123;<span class="string">"Units"</span>, <span class="keyword">new</span> Tuple&lt;<span class="keyword">string</span>, <span class="keyword">double</span>, Aspose.Cells.Style&gt;(<span class="string">"產品 庫存"</span> , <span class="number">-1</span>, <span class="literal">null</span>) &#125;,</div><div class="line">&#123;<span class="string">"CreDte"</span>, <span class="keyword">new</span> Tuple&lt;<span class="keyword">string</span>, <span class="keyword">double</span>, Aspose.Cells.Style&gt;(<span class="string">"日期"</span> , <span class="number">10</span>, <span class="keyword">new</span> Aspose.Cells.Style&#123; Number = <span class="number">14</span> &#125;) &#125;</div><div class="line">&#125;,</div><div class="line">PageOrientation = PageOrientationType.Landscape,</div><div class="line">IsTextWrapped = <span class="literal">false</span>,</div><div class="line">PageScale = <span class="number">80</span>,</div><div class="line">FontName = <span class="string">"標楷體"</span>,</div><div class="line">HeaderHorizontalAlignment = TextAlignmentType.Center</div><div class="line">&#125;;</div><div class="line"><span class="keyword">var</span> pdfStream = GenPDFFromDataTable(excelArg);</div><div class="line"><span class="keyword">var</span> fileNameWithoutExt = <span class="string">$"<span class="subst">&#123;Guid.NewGuid().ToString(<span class="string">"N"</span>)&#125;</span>"</span>;</div><div class="line"><span class="comment">//string pdfFileName = Path.Combine(Server.MapPath("./data"), $"&#123;fileNameWithoutExt&#125;_temp.pdf");</span></div><div class="line"><span class="comment">//using (FileStream file = new FileStream(pdfFileName, FileMode.Create, System.IO.FileAccess.Write))</span></div><div class="line"><span class="comment">//    pdfStream.CopyTo(file);</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> watermarkArg = <span class="keyword">new</span> WatermarkArg</div><div class="line">&#123;</div><div class="line">Watermark = <span class="string">$"* 使用者:亂馬客  *<span class="subst">&#123;Environment.NewLine&#125;</span><span class="subst">&#123;DateTime.Now.ToString(<span class="string">"yyyy/MM/dd HH:mm:ss"</span>)&#125;</span>"</span>,</div><div class="line">WMStyle = WatermarkStyle.RepeatHorizontal,</div><div class="line">WatermarkHeight = <span class="number">100</span>,</div><div class="line">WatermarkWidth = <span class="number">130</span>,</div><div class="line">WatermarkHorizontalSpace = <span class="number">50</span>,</div><div class="line">WatermarkVerticalSpace = <span class="number">30</span>,</div><div class="line">RotateAngle = <span class="number">30</span>,</div><div class="line">Opacity = <span class="number">.1</span></div><div class="line"></div><div class="line">&#125;;</div><div class="line"><span class="keyword">var</span> waterStream = AddWatermark(pdfStream, watermarkArg);</div><div class="line"><span class="comment">//string watermarkFileName = Path.Combine(Server.MapPath("./data"), $"&#123;fileNameWithoutExt&#125;.pdf");</span></div><div class="line"><span class="comment">//using (FileStream file = new FileStream(watermarkFileName, FileMode.Create, System.IO.FileAccess.Write))</span></div><div class="line"><span class="comment">//    waterStream.CopyTo(file);</span></div><div class="line">Response.ContentType = <span class="string">"application/pdf"</span>;</div><div class="line">Response.AddHeader(<span class="string">"content-disposition"</span>, <span class="string">"attachment; filename="</span> + <span class="string">$"<span class="subst">&#123;fileNameWithoutExt&#125;</span>.pdf"</span>);</div><div class="line"><span class="keyword">var</span> fileSize = waterStream.Length;</div><div class="line"><span class="keyword">byte</span>[] pdfBuffer = <span class="keyword">new</span> <span class="keyword">byte</span>[(<span class="keyword">int</span>)fileSize];</div><div class="line">waterStream.Read(pdfBuffer, <span class="number">0</span>, (<span class="keyword">int</span>)fileSize);</div><div class="line">waterStream.Close();</div><div class="line">Response.BinaryWrite(pdfBuffer);</div><div class="line">Response.End();</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>產生出來的 PDF 如下圖，<br><img src="/2018/07/13/2018024/repeatPage.png" alt="[浮水印水平蓋滿一頁的PDF]" title="[浮水印水平蓋滿一頁的PDF]"></p><h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><p><a href="https://rainmakerho.github.io/2018/07/03/2018022/">透過 Aspose 將 datatable 的資料轉出成有浮水印的 PDF 檔</a><br><a href="https://docs.aspose.com/display/cellsnet/Setting+Page+Options" target="_blank" rel="external">Setting Page Options</a><br><a href="https://docs.aspose.com/display/cellsnet/Setting+Headers+and+Footers" target="_blank" rel="external">Setting Headers and Footers</a><br><a href="https://github.com/aspose-pdf/Aspose.PDF-for-.NET/tree/master/Examples/CSharp/AsposePDF/Stamps-Watermarks" target="_blank" rel="external">Aspose Stamps-Watermarks</a><br><a href="https://apireference.aspose.com/net/cells/aspose.cells/style/properties/number" target="_blank" rel="external">Aspose Cells Style.Number Property</a><br><a href="https://support.microsoft.com/en-us/help/264372/how-to-control-and-understand-settings-in-the-format-cells-dialog-box" target="_blank" rel="external">How to control and understand settings in the Format Cells dialog box in Excel</a><br><a href="https://forum.aspose.com/t/column-number-format-to-4-decimal-places/41465" target="_blank" rel="external">Column Number format to 4 decimal places</a></p><p>Demo 專案:<a href="https://github.com/rainmakerho/asposeExcel2PDF" target="_blank" rel="external">rainmakerho/asposeExcel2PDF</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;在 &lt;a href=&quot;https://rainmakerho.github.io/2018/07/03/2018022/&quot;&gt;透過 Aspos
      
    
    </summary>
    
    
      <category term="Aspose" scheme="https://rainmakerho.github.io/tags/Aspose/"/>
    
      <category term="Aspose.Cells" scheme="https://rainmakerho.github.io/tags/Aspose-Cells/"/>
    
      <category term="datatable" scheme="https://rainmakerho.github.io/tags/datatable/"/>
    
      <category term="Aspose.Pdf" scheme="https://rainmakerho.github.io/tags/Aspose-Pdf/"/>
    
      <category term="pdf" scheme="https://rainmakerho.github.io/tags/pdf/"/>
    
      <category term="watermark" scheme="https://rainmakerho.github.io/tags/watermark/"/>
    
      <category term="浮水印" scheme="https://rainmakerho.github.io/tags/%E6%B5%AE%E6%B0%B4%E5%8D%B0/"/>
    
      <category term="asp.net" scheme="https://rainmakerho.github.io/tags/asp-net/"/>
    
      <category term="Aspose.Pdf.Facades.Stamp" scheme="https://rainmakerho.github.io/tags/Aspose-Pdf-Facades-Stamp/"/>
    
  </entry>
  
  <entry>
    <title>從 Bot 送訊息到 IM Channel 時，加入額外的 Header 資訊</title>
    <link href="https://rainmakerho.github.io/2018/07/05/2018023/"/>
    <id>https://rainmakerho.github.io/2018/07/05/2018023/</id>
    <published>2018-07-05T02:45:19.000Z</published>
    <updated>2018-07-05T07:07:54.804Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>我們使用 <a href="https://github.com/rainmakerho/offline_dl" target="_blank" rel="external">offline_dl</a> 來達到使用 botframework 開發全地端的 Chatbot (<a href="https://rainmakerhoblog.wordpress.com/2017/08/30/20170830/" target="_blank" rel="external">使用 Microsoft Bot Framework 地端的 WebChat 機器人(企業內)</a>).<br>我們想要在 <a href="https://github.com/rainmakerho/offline_dl" target="_blank" rel="external">offline_dl</a> 中去驗證由 Bot 送過來的訊息是否可靠，所以想在 Bot 發送訊息時 (Conversations.ReplyToActivityAsync or DialogContext.PostAsync)，多加入一個 Header 的資料，來讓 <a href="https://github.com/rainmakerho/offline_dl" target="_blank" rel="external">offline_dl</a> 中可以去驗證。</p><h3 id="實作"><a href="#實作" class="headerlink" title="實作"></a>實作</h3><p>一開始有看到 Conversations 有一個 <a href="https://github.com/Microsoft/botbuilder-dotnet/blob/master/libraries/Microsoft.Bot.Connector/Conversations.cs#L903" target="_blank" rel="external">ReplyToActivityWithHttpMessagesAsync</a> Method ，可以讓我們放要額外加的 Header ，但那就要從 <a href="https://github.com/Microsoft/BotBuilder/blob/master/CSharp/Library/Microsoft.Bot.Connector.Shared/ConnectorAPI/ConversationsExtensions.cs#L333" target="_blank" rel="external">ReplyToActivityAsync</a> 改成 <a href="https://github.com/Microsoft/botbuilder-dotnet/blob/master/libraries/Microsoft.Bot.Connector/Conversations.cs#L903" target="_blank" rel="external">ReplyToActivityWithHttpMessagesAsync</a>. 那用 <a href="https://github.com/Microsoft/BotBuilder/blob/master/CSharp/Library/Microsoft.Bot.Builder/Dialogs/DialogContext.cs#L85" target="_blank" rel="external">DialogContext.PostAsync</a> Method 要怎麼辦呢?</p><p>參考 github 上的一些討論後發現，其實可以透過抽換 ConnectorClient 來達到我們的需求。從 Bot Call Connector 是透過 ConnectorClient 的 HttpClient 來處理的。所以只要 2 步驟就可以了哦!</p><h4 id="1-繼承自-ConnectorClient-，然後在建構子中，將我們想要加的-Header-加到-HttpClient-DefaultRequestHeaders-之中，如下。"><a href="#1-繼承自-ConnectorClient-，然後在建構子中，將我們想要加的-Header-加到-HttpClient-DefaultRequestHeaders-之中，如下。" class="headerlink" title="1.繼承自 ConnectorClient ，然後在建構子中，將我們想要加的 Header 加到 HttpClient.DefaultRequestHeaders 之中，如下。"></a>1.繼承自 ConnectorClient ，然後在建構子中，將我們想要加的 Header 加到 HttpClient.DefaultRequestHeaders 之中，如下。</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyConnectorClient</span> : <span class="title">ConnectorClient</span></div><div class="line">&#123;</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="title">MyConnectorClient</span>(<span class="params"><span class="keyword">params</span> DelegatingHandler[] handlers</span>)</span></div><div class="line"><span class="function">: <span class="title">base</span>(<span class="params">handlers</span>)</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">AddCustomHeaders();</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">MyConnectorClient</span>(<span class="params">ServiceClientCredentials credentials, <span class="keyword">params</span> DelegatingHandler[] handlers</span>)</span></div><div class="line"><span class="function">:<span class="title">base</span>(<span class="params">credentials, handlers</span>)</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">AddCustomHeaders();</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">MyConnectorClient</span>(<span class="params">HttpClientHandler rootHandler, <span class="keyword">params</span> DelegatingHandler[] handlers</span>) : <span class="title">base</span>(<span class="params">rootHandler, handlers</span>)</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">AddCustomHeaders();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">MyConnectorClient</span>(<span class="params">Uri baseUri, <span class="keyword">string</span> microsoftAppId = <span class="literal">null</span>, <span class="keyword">string</span> microsoftAppPassword = <span class="literal">null</span>, <span class="keyword">params</span> DelegatingHandler[] handlers</span>)</span></div><div class="line"><span class="function">: <span class="title">base</span>(<span class="params">baseUri, microsoftAppId, microsoftAppPassword, handlers</span>)</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">AddCustomHeaders();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">MyConnectorClient</span>(<span class="params">Uri baseUri, MicrosoftAppCredentials credentials, <span class="keyword">bool</span> addJwtTokenRefresher = <span class="literal">true</span>, <span class="keyword">params</span> DelegatingHandler[] handlers</span>)</span></div><div class="line"><span class="function">: <span class="title">base</span>(<span class="params">baseUri, credentials, addJwtTokenRefresher, handlers</span>)</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">AddCustomHeaders();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">MyConnectorClient</span>(<span class="params">Uri baseUri, MicrosoftAppCredentials credentials, HttpClientHandler httpClientHandler, <span class="keyword">bool</span> addJwtTokenRefresher = <span class="literal">true</span>, <span class="keyword">params</span> DelegatingHandler[] handlers</span>)</span></div><div class="line"><span class="function">:<span class="title">base</span>(<span class="params">baseUri, credentials, httpClientHandler, addJwtTokenRefresher, handlers</span>)</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">AddCustomHeaders();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">MyConnectorClient</span>(<span class="params">Uri uri, MicrosoftAppCredentials microsoftAppCredentials</span>)</span></div><div class="line"><span class="function">: <span class="title">base</span>(<span class="params">uri, microsoftAppCredentials</span>)</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">AddCustomHeaders();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">MyConnectorClient</span>(<span class="params">Uri uri</span>)</span></div><div class="line"><span class="function">: <span class="title">base</span>(<span class="params">uri</span>)</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">AddCustomHeaders();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">MyConnectorClient</span>(<span class="params"></span>) : <span class="title">base</span>(<span class="params"></span>)</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">AddCustomHeaders();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">AddCustomHeaders</span>(<span class="params"></span>)</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line"><span class="comment">//在這裡操作 HttpClient</span></div><div class="line"><span class="keyword">base</span>.HttpClient.DefaultRequestHeaders.TryAddWithoutValidation(<span class="string">"x-rm"</span>, <span class="string">"rmvalue"</span>);</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h4 id="2-透過-Autofac-將原本的-ConnectorClient-置換成-MyConnectorClient-，如下，"><a href="#2-透過-Autofac-將原本的-ConnectorClient-置換成-MyConnectorClient-，如下，" class="headerlink" title="2.透過 Autofac 將原本的 ConnectorClient 置換成 MyConnectorClient ，如下，"></a>2.透過 Autofac 將原本的 ConnectorClient 置換成 MyConnectorClient ，如下，</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Conversation.UpdateContainer(builder =&gt;</div><div class="line">&#123;</div><div class="line"><span class="comment">//ConnectorClient override add custom headers</span></div><div class="line">builder</div><div class="line">.Register(c =&gt; <span class="keyword">new</span> MyConnectorClient(<span class="keyword">new</span> Uri(c.Resolve&lt;IAddress&gt;().ServiceUrl)</div><div class="line">, c.Resolve&lt;MicrosoftAppCredentials&gt;()))</div><div class="line">.As&lt;IConnectorClient&gt;()</div><div class="line">.InstancePerMatchingLifetimeScope(<span class="keyword">typeof</span>(DialogModule));</div><div class="line">&#125;);</div></pre></td></tr></table></figure><p><br><br>所以在 Dialog 中使用 await context.PostAsync 就會直接用到我們的 MyConnectorClient. 而如果在 Controller 中使用的話，就要將原本是 new ConnectorClient 改成 MyConnectorClient. 不然就要透過 Autofac 來建立它，如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> (<span class="keyword">var</span> scope = DialogModule.BeginLifetimeScope(Conversation.Container, message))</div><div class="line">&#123;</div><div class="line"><span class="keyword">var</span> RootDialog_Welcome_Message = <span class="string">"你好，我是亂馬客，很高興為您服務 ^_^"</span>;</div><div class="line"><span class="keyword">var</span> reply = message.CreateReply(RootDialog_Welcome_Message);</div><div class="line"><span class="keyword">var</span> connector = scope.Resolve&lt;IConnectorClient&gt;();</div><div class="line"><span class="keyword">await</span> connector.Conversations.ReplyToActivityAsync(reply);</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>從 <a href="https://github.com/rainmakerho/offline_dl" target="_blank" rel="external">offline_dl</a> 的 v3/conversations/:conversationId/activities/:activityId log Request 的 Headers ，可以發現，它已經包含了我們新增的 Header (x-rm)了哦! 如下，<br><img src="/2018/07/05/2018023/CustomHeader.png" alt="[offline_dl log Request.Headers]" title="[offline_dl log Request.Headers]"></p><h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><p><a href="https://github.com/Microsoft/BotBuilder/issues/4075" target="_blank" rel="external">[Question] How can I override Autofac configuration to provide my own custom ConnectorClient?</a><br><a href="https://github.com/Microsoft/BotBuilder/issues/954" target="_blank" rel="external">Intercepting every message between bot and user</a><br><a href="https://rainmakerhoblog.wordpress.com/2017/08/30/20170830/" target="_blank" rel="external">使用 Microsoft Bot Framework 地端的 WebChat 機器人(企業內)</a><br><a href="https://stackoverflow.com/questions/51128475/add-custom-header-when-call-conversations-replytoactivityasync-and-dialogcontext" target="_blank" rel="external">Add custom header when call Conversations.ReplyToActivityAsync and DialogContext.PostAsync</a><br><a href="https://github.com/rainmakerho/offline_dl" target="_blank" rel="external">offline_dl</a><br><a href="https://github.com/Microsoft/BotBuilder/issues/2258" target="_blank" rel="external">Conversation.SendAsync Authentication using custom multi-tenant authentication (Bot Builder 3.5.2)</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;我們使用 &lt;a href=&quot;https://github.com/rainmakerho/offline_dl&quot; target=&quot;_blan
      
    
    </summary>
    
    
      <category term="botframework" scheme="https://rainmakerho.github.io/tags/botframework/"/>
    
      <category term="BotToUser" scheme="https://rainmakerho.github.io/tags/BotToUser/"/>
    
      <category term="ConnectorClient" scheme="https://rainmakerho.github.io/tags/ConnectorClient/"/>
    
      <category term="TryAddWithoutValidation" scheme="https://rainmakerho.github.io/tags/TryAddWithoutValidation/"/>
    
      <category term="Header" scheme="https://rainmakerho.github.io/tags/Header/"/>
    
  </entry>
  
  <entry>
    <title>透過 Aspose 將 datatable 的資料轉出成有浮水印的 PDF 檔</title>
    <link href="https://rainmakerho.github.io/2018/07/03/2018022/"/>
    <id>https://rainmakerho.github.io/2018/07/03/2018022/</id>
    <published>2018-07-03T07:55:15.000Z</published>
    <updated>2018-07-09T09:12:59.978Z</updated>
    
    <content type="html"><![CDATA[<h3 id="問題"><a href="#問題" class="headerlink" title="問題"></a>問題</h3><p>最近同事想要將 datatable 轉出 excel, 但又需要不能讓使用者修改，上面還要有浮水印.<br>本來想要直接 Render 出 Html 的 Table 並加入 page-break-after 去讓 Browser 分頁, 但 CSS 控制上不是很順利.</p><h3 id="實作"><a href="#實作" class="headerlink" title="實作"></a>實作</h3><p>Aspose.Cells 可以將各種資料源轉成 Excel (可參考<a href="https://apireference.aspose.com/net/cells/aspose.cells/cells/methods/index" target="_blank" rel="external">cells methods</a>的 Import 相關 Methods).<br>所以我們想要的做法如下，</p><p><strong>DataTable =&gt; 換 ColumnName =&gt; Excel =&gt; Pdf =&gt; Pdf+浮水印</strong></p><p>所以就可以抽一個共用的 Method 出來如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div></pre></td><td class="code"><pre><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> 輸入 DataTable 轉成 有浮水印 的 PDF</span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="dt"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="columnNameMappings"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="folderName"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="watermark"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="pot"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>產生的 pdf 檔名 (fullpath) <span class="doctag">&lt;/returns&gt;</span></span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">GenPDF</span>(<span class="params">DataTable dt, Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt; columnNameMappings</span></span></div><div class="line"><span class="function"><span class="params">, <span class="keyword">string</span> folderName, <span class="keyword">string</span> watermark, PageOrientationType pot</span>)</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">ChangeColumnDisplayName(dt, columnNameMappings);</div><div class="line"></div><div class="line"><span class="comment">//output file name</span></div><div class="line"><span class="keyword">var</span> fileNameWithoutExt = <span class="string">$"<span class="subst">&#123;Guid.NewGuid().ToString(<span class="string">"N"</span>)&#125;</span>"</span>;</div><div class="line"><span class="keyword">var</span> outputExcel = Path.Combine(folderName, <span class="string">$"<span class="subst">&#123;fileNameWithoutExt&#125;</span>_tmp.xlsx"</span>);</div><div class="line"><span class="keyword">var</span> tempPdf = Path.Combine(folderName, <span class="string">$"<span class="subst">&#123;fileNameWithoutExt&#125;</span>_tmp.pdf"</span>);</div><div class="line"><span class="keyword">var</span> outputPdf = Path.Combine(folderName, <span class="string">$"<span class="subst">&#123;fileNameWithoutExt&#125;</span>.pdf"</span>);</div><div class="line"></div><div class="line"><span class="comment">//proc excel</span></div><div class="line"><span class="comment">// Instantiating a Workbook object</span></div><div class="line"><span class="keyword">var</span> workbook = <span class="keyword">new</span> Workbook();</div><div class="line"><span class="keyword">var</span> worksheet = workbook.Worksheets[<span class="number">0</span>];</div><div class="line">worksheet.Cells.ImportDataTable(dt, <span class="literal">true</span>, <span class="string">"A1"</span>);</div><div class="line">worksheet.AutoFitColumns();</div><div class="line">worksheet.AutoFitRows();</div><div class="line"></div><div class="line"><span class="keyword">var</span> range = worksheet.Cells.MaxDisplayRange;</div><div class="line"><span class="keyword">var</span> pageSetup = workbook.Worksheets[<span class="number">0</span>].PageSetup;</div><div class="line"><span class="comment">//var titleEndColumnName = CellsHelper.ColumnIndexToName(range.ColumnCount-1);</span></div><div class="line"><span class="comment">//pageSetup.PrintTitleColumns = $"$A:$&#123;titleEndColumnName&#125;";</span></div><div class="line">pageSetup.PrintTitleRows = <span class="string">"$1:$1"</span>;</div><div class="line">pageSetup.IsPercentScale = <span class="literal">true</span>;</div><div class="line">pageSetup.Orientation = pot;</div><div class="line"><span class="comment">//縮放比例(column 資料太長，可設定縮放比例)</span></div><div class="line">    <span class="comment">//pageSetup.Zoom = zoom;</span></div><div class="line"></div><div class="line"><span class="comment">//border</span></div><div class="line"><span class="comment">//Setting border for each cell in the range</span></div><div class="line"><span class="keyword">var</span> style = workbook.CreateStyle();</div><div class="line"><span class="keyword">var</span> colorBlack = System.Drawing.Color.Black;</div><div class="line">style.SetBorder(BorderType.BottomBorder, CellBorderType.Medium, colorBlack);</div><div class="line">style.SetBorder(BorderType.LeftBorder, CellBorderType.Medium, colorBlack);</div><div class="line">style.SetBorder(BorderType.RightBorder, CellBorderType.Medium, colorBlack);</div><div class="line">style.SetBorder(BorderType.TopBorder, CellBorderType.Medium, colorBlack);</div><div class="line">range.SetStyle(style);</div><div class="line"></div><div class="line"><span class="comment">// Saving the Excel file</span></div><div class="line"><span class="comment">//workbook.Save(outputExcel);</span></div><div class="line"><span class="comment">//workbook.Save(tempPdf);</span></div><div class="line"><span class="comment">//save to stream</span></div><div class="line"><span class="keyword">var</span> pdfStream = <span class="keyword">new</span> MemoryStream();</div><div class="line">workbook.Save(pdfStream, Aspose.Cells.SaveFormat.Pdf);</div><div class="line"></div><div class="line"><span class="keyword">var</span> pdfDocument = <span class="keyword">new</span> Aspose.Pdf.Document(pdfStream);</div><div class="line"><span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrWhiteSpace(watermark))</div><div class="line">&#123;</div><div class="line"><span class="comment">//針對 PDF 加入 Watermark</span></div><div class="line">Aspose.Pdf.Facades.Stamp aStamp = <span class="keyword">new</span> Aspose.Pdf.Facades.Stamp();</div><div class="line">aStamp.Rotation = <span class="number">45</span>;</div><div class="line"><span class="keyword">var</span> textStamp = <span class="keyword">new</span> TextStamp(watermark);</div><div class="line"><span class="comment">//set properties of the stamp</span></div><div class="line"><span class="comment">// textStamp.Background = true;</span></div><div class="line">textStamp.Opacity = <span class="number">0.2</span>;</div><div class="line">textStamp.TextState.FontSize = <span class="number">60.0</span>F;</div><div class="line">textStamp.HorizontalAlignment = HorizontalAlignment.Center;</div><div class="line">textStamp.VerticalAlignment = VerticalAlignment.Center;</div><div class="line">textStamp.RotateAngle = aStamp.Rotation;</div><div class="line">textStamp.TextState.Font = FontRepository.FindFont(<span class="string">"Arial"</span>);</div><div class="line">textStamp.TextState.ForegroundColor = Aspose.Pdf.Color.Gray;</div><div class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> page <span class="keyword">in</span> pdfDocument.Pages)</div><div class="line">&#123;</div><div class="line">page.AddStamp(textStamp);</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">pdfDocument.Save(outputPdf);</div><div class="line"><span class="keyword">return</span> outputPdf;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> 將目前DataTable的資料依 Dictionary 來改它的 ColumnName</span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="dt"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="columnNameMappings"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ChangeColumnDisplayName</span>(<span class="params">DataTable dt, Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt; columnNameMappings</span>)</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line"><span class="comment">//change columnName</span></div><div class="line"><span class="keyword">if</span> (columnNameMappings != <span class="literal">null</span>)</div><div class="line">&#123;</div><div class="line"><span class="keyword">foreach</span> (KeyValuePair&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt; columnMapping <span class="keyword">in</span> columnNameMappings)</div><div class="line">&#123;</div><div class="line">dt.Columns[columnMapping.Key].ColumnName = columnMapping.Value;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>所以可以用測試的 DataTable 資料來測試看看，如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> DataTable <span class="title">GetDataSource</span>(<span class="params"></span>)</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line"><span class="comment">// Instantiating a "Products" DataTable object</span></div><div class="line"><span class="keyword">var</span> dataTable = <span class="keyword">new</span> DataTable(<span class="string">"Products"</span>);</div><div class="line"><span class="comment">// Adding columns to the DataTable object</span></div><div class="line">dataTable.Columns.Add(<span class="string">"ProductID"</span>, <span class="keyword">typeof</span>(Int32));</div><div class="line">dataTable.Columns.Add(<span class="string">"ProductName"</span>, <span class="keyword">typeof</span>(<span class="keyword">string</span>));</div><div class="line">dataTable.Columns.Add(<span class="string">"ProductDesc"</span>, <span class="keyword">typeof</span>(<span class="keyword">string</span>));</div><div class="line">dataTable.Columns.Add(<span class="string">"Units"</span>, <span class="keyword">typeof</span>(Double));</div><div class="line"><span class="keyword">var</span> rand = <span class="keyword">new</span> Random();</div><div class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">90</span>; i++)</div><div class="line">&#123;</div><div class="line">dataTable.Rows.Add(i, <span class="string">$"產品名稱-<span class="subst">&#123;i&#125;</span>"</span>, <span class="string">$"產品描述 -<span class="subst">&#123;i&#125;</span>"</span>, rand.NextDouble());</div><div class="line">&#125;</div><div class="line"><span class="keyword">return</span> dataTable;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">btnGenPDF_Click</span>(<span class="params"><span class="keyword">object</span> sender, EventArgs e</span>)</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line"><span class="keyword">var</span> ds = GetDataSource();</div><div class="line"><span class="keyword">var</span> columnMapping = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt;</div><div class="line">&#123;</div><div class="line">&#123;<span class="string">"ProductID"</span>, <span class="string">"產品代號"</span> &#125;,</div><div class="line">&#123;<span class="string">"ProductName"</span>, <span class="string">"產品名稱"</span> &#125;,</div><div class="line">&#123;<span class="string">"ProductDesc"</span>, <span class="string">"產品 描述"</span> &#125;,</div><div class="line"> &#123;<span class="string">"Units"</span>, <span class="string">"產品 庫存"</span> &#125;</div><div class="line">&#125;;</div><div class="line"><span class="keyword">var</span> outFileName = GenPDF(ds, columnMapping,</div><div class="line">Server.MapPath(<span class="string">"./data"</span>), <span class="string">"你好，我是亂馬客!!!"</span></div><div class="line">, PageOrientationType.Landscape);</div><div class="line">Response.Write(<span class="string">$"&lt;hr&gt;Export to Pdf-1:<span class="subst">&#123;outFileName&#125;</span>"</span>);</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">var</span> ds2 = GetDataSource();</div><div class="line"><span class="comment">//沒有 mapping 就用原生的 Column Name</span></div><div class="line"><span class="keyword">var</span> outFileName2 = GenPDF(ds2, <span class="literal">null</span>,</div><div class="line">Server.MapPath(<span class="string">"./data"</span>), <span class="string">""</span></div><div class="line">, PageOrientationType.Portrait);</div><div class="line">Response.Write(<span class="string">$"&lt;hr&gt;Export to Pdf-2:<span class="subst">&#123;outFileName2&#125;</span>"</span>);</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><p>所以產生的結果如下，<br><img src="/2018/07/03/2018022/dt2pdf.png" alt="[DataTable產生pdf]" title="[DataTable產生pdf]"><br>註:</p><ol><li>因為使用 Aspose.Cells 及 Aspose.Pdf ，所以請記得從 Nuget 去下載哦~</li><li>有時資料欄位太多時，可以設定列印的縮放比例 pageSetup.Zoom 的值，詳細請參考<a href="https://docs.aspose.com/display/cellsnet/Setting+Page+Options#SettingPageOptions-ScalingFactor" target="_blank" rel="external">Scaling Factor</a></li></ol><p>Demo 專案:<a href="https://github.com/rainmakerho/asposeExcel2PDF" target="_blank" rel="external">rainmakerho/asposeExcel2PDF</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;問題&quot;&gt;&lt;a href=&quot;#問題&quot; class=&quot;headerlink&quot; title=&quot;問題&quot;&gt;&lt;/a&gt;問題&lt;/h3&gt;&lt;p&gt;最近同事想要將 datatable 轉出 excel, 但又需要不能讓使用者修改，上面還要有浮水印.&lt;br&gt;本來想要直接 Render 出 
      
    
    </summary>
    
    
      <category term="Aspose" scheme="https://rainmakerho.github.io/tags/Aspose/"/>
    
      <category term="Aspose.Cells" scheme="https://rainmakerho.github.io/tags/Aspose-Cells/"/>
    
      <category term="datatable" scheme="https://rainmakerho.github.io/tags/datatable/"/>
    
      <category term="Aspose.Pdf" scheme="https://rainmakerho.github.io/tags/Aspose-Pdf/"/>
    
      <category term="pdf" scheme="https://rainmakerho.github.io/tags/pdf/"/>
    
      <category term="watermark" scheme="https://rainmakerho.github.io/tags/watermark/"/>
    
      <category term="浮水印" scheme="https://rainmakerho.github.io/tags/%E6%B5%AE%E6%B0%B4%E5%8D%B0/"/>
    
      <category term="asp.net" scheme="https://rainmakerho.github.io/tags/asp-net/"/>
    
      <category term="Aspose.Pdf.Facades.Stamp" scheme="https://rainmakerho.github.io/tags/Aspose-Pdf-Facades-Stamp/"/>
    
  </entry>
  
  <entry>
    <title>Open Html Excel File from Aspose.Cells 透過 Aspose.Cells 開啟 Html 格式的 Excel 檔案</title>
    <link href="https://rainmakerho.github.io/2018/07/02/2018021/"/>
    <id>https://rainmakerho.github.io/2018/07/02/2018021/</id>
    <published>2018-07-02T02:41:25.000Z</published>
    <updated>2018-07-02T02:59:48.200Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>我們之前透過程式產生 Excel 檔時，是先將一份 Excel 另存成 Html 格式的檔案，然後在裡面設定一些 Tag 。<br>程式就透過去 Replace 這些 Tag 後，再將程式另存，並將檔名改成 xls 。<br>這樣使用者就可以透過 Excel 去開啟它了。<br>只是最近的 Excel 開啟這樣的檔案，都會先 alert 使用者 (可以透過調整 機碼 讓它不要 alert)。<br>那有辦法讓它變成真正的 Excel 檔，或是轉成 PDF 嗎?</p><h3 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h3><p>我們可以透過 Aspose 的元件來處理哦! 它有提供一個 HTMLLoadOptions 可以讓我們達到這樣子的目的哦! 程式如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> filePath = <span class="string">"hr840401.xls"</span>;</div><div class="line"><span class="keyword">var</span> opts = <span class="keyword">new</span> HTMLLoadOptions(LoadFormat.Html);</div><div class="line"><span class="keyword">var</span> workbook = <span class="keyword">new</span> Workbook(filePath, opts);</div><div class="line">workbook.Save(<span class="string">"hr840401_out.xls"</span>);</div></pre></td></tr></table></figure><p>它還可以載其他的格式哦，詳細可以參考<a href="https://apireference.aspose.com/net/pdf/aspose.pdf/loadformat" target="_blank" rel="external">Aspose LoadFormat Enumeration</a></p><h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><p><a href="https://forum.aspose.com/t/open-excel-html-file/44690/3" target="_blank" rel="external">Open Excel/html file</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;我們之前透過程式產生 Excel 檔時，是先將一份 Excel 另存成 Html 格式的檔案，然後在裡面設定一些 Tag 。&lt;br&gt;程式就透
      
    
    </summary>
    
    
      <category term="aspose" scheme="https://rainmakerho.github.io/tags/aspose/"/>
    
      <category term="aspose.cells" scheme="https://rainmakerho.github.io/tags/aspose-cells/"/>
    
      <category term="Html" scheme="https://rainmakerho.github.io/tags/Html/"/>
    
      <category term="Excell" scheme="https://rainmakerho.github.io/tags/Excell/"/>
    
  </entry>
  
  <entry>
    <title>IBotDataStore.FlushAsync Exception: The data is changed</title>
    <link href="https://rainmakerho.github.io/2018/07/01/2018020/"/>
    <id>https://rainmakerho.github.io/2018/07/01/2018020/</id>
    <published>2018-07-01T03:29:38.000Z</published>
    <updated>2018-07-01T04:06:36.657Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>最新有個需求就是要判斷目前 User 是不是在進行某項作業, 如果不是就推送包含 Button 的訊息給 User, 不然就推文字通知訊息等目前的作業完成後，再顯示待辦的 Button 訊息給 User .</p><h3 id="研究"><a href="#研究" class="headerlink" title="研究"></a>研究</h3><p>最簡單的就是將這個 flag 寫在 BotState 之中，所以我們可以在使用者加入時，將它的 Conversation 記錄下來，如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (message.Type == ActivityTypes.ConversationUpdate)</div><div class="line">&#123;</div><div class="line">Func&lt;ChannelAccount, <span class="keyword">bool</span>&gt; isChatbot =</div><div class="line">channelAcct =&gt; channelAcct.Id == message.Recipient.Id;</div><div class="line"><span class="keyword">if</span> (message.MembersAdded.Any(isChatbot))</div><div class="line">&#123;</div><div class="line"><span class="keyword">var</span> memberAdded = message.MembersAdded.FirstOrDefault();</div><div class="line"><span class="comment">//這裡請自行處理將該 user 的 Conversation 儲存起來，為了方便，這裡將它存在一個變數之中</span></div><div class="line">WebApiApplication._ConversationReference = message.ToConversationReference();</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>然後在申請作業記錄這個 Flag ，當然，結束時請記得將這個 Flag 清除哦!</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> (<span class="keyword">var</span> scope = DialogModule.BeginLifetimeScope(Conversation.Container, context.Activity.AsMessageActivity()))</div><div class="line">&#123;</div><div class="line"><span class="keyword">var</span> botDataStore = scope.Resolve&lt;IBotDataStore&lt;BotData&gt;&gt;();</div><div class="line"><span class="keyword">var</span> key = Address.FromActivity(context.Activity);</div><div class="line"><span class="keyword">var</span> botUserData = <span class="keyword">await</span> botDataStore.LoadAsync(key, BotStoreType.BotUserData, <span class="keyword">default</span>(CancellationToken));</div><div class="line">botUserData.SetProperty&lt;<span class="keyword">string</span>&gt;(<span class="string">"dialog"</span>, <span class="string">"RootDialog:MessageReceivedAsync"</span>);</div><div class="line"><span class="keyword">await</span> botDataStore.SaveAsync(key, BotStoreType.BotUserData, botUserData, <span class="keyword">default</span>(CancellationToken));</div><div class="line"><span class="keyword">await</span> botDataStore.FlushAsync(key, <span class="keyword">default</span>(CancellationToken));</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>可是執行時，卻發生了「Exception: The data is changed」的錯誤，如下圖，<br><img src="/2018/07/01/2018020/eDataChanged.png" alt="[Exception: The data is changed]" title="[Exception: The data is changed]"></p><p>因為 botframework 會自動去幫我們將 State 存檔，所以當它存檔時，發現狀態被改掉了，所以就出現「Exception: The data is changed」的錯誤 .</p><p>嗯, 那怎麼辦呢? 那就調整程式, 不要去呼叫 FlushAsync, 讓 botframework 去存就可以了, 所以程式調整如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> (<span class="keyword">var</span> scope = DialogModule.BeginLifetimeScope(Conversation.Container, context.Activity.AsMessageActivity()))</div><div class="line">&#123;</div><div class="line"><span class="keyword">var</span> botDataStore = scope.Resolve&lt;IBotDataStore&lt;BotData&gt;&gt;();</div><div class="line"><span class="keyword">var</span> key = Address.FromActivity(context.Activity);</div><div class="line"><span class="keyword">var</span> botUserData = <span class="keyword">await</span> botDataStore.LoadAsync(key, BotStoreType.BotUserData, <span class="keyword">default</span>(CancellationToken));</div><div class="line">botUserData.SetProperty&lt;<span class="keyword">string</span>&gt;(<span class="string">"dialog"</span>, <span class="string">"RootDialog:MessageReceivedAsync"</span>);</div><div class="line"><span class="keyword">await</span> botDataStore.SaveAsync(key, BotStoreType.BotUserData, botUserData, <span class="keyword">default</span>(CancellationToken));</div><div class="line">    <span class="comment">//await botDataStore.FlushAsync(key, default(CancellationToken));</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><p>所以我們的通知程式就可以透過 ConversationReference 轉回 Activity, 取回 BotState, 例如，我新增一個 api method 來顯示 BotState , 如下,</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">[<span class="meta">Route(<span class="meta-string">"api/Messages/GetDialogData"</span>)</span>]</div><div class="line">[<span class="meta">HttpGet</span>]</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;HttpResponseMessage&gt; <span class="title">GetDialogData</span>(<span class="params"></span>)</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line"><span class="keyword">var</span> resp = <span class="keyword">new</span> HttpResponseMessage(HttpStatusCode.OK);</div><div class="line"><span class="keyword">if</span> (WebApiApplication._ConversationReference != <span class="literal">null</span>)</div><div class="line">&#123;</div><div class="line"><span class="keyword">var</span> message = WebApiApplication._ConversationReference.GetPostToBotMessage();</div><div class="line"><span class="keyword">using</span> (<span class="keyword">var</span> scope = DialogModule.BeginLifetimeScope(Conversation.Container, message.AsMessageActivity()))</div><div class="line">&#123;</div><div class="line"><span class="keyword">var</span> botDataStore = scope.Resolve&lt;IBotDataStore&lt;BotData&gt;&gt;();</div><div class="line"><span class="keyword">var</span> key = Address.FromActivity(message);</div><div class="line"><span class="keyword">var</span> botUserData = <span class="keyword">await</span> botDataStore.LoadAsync(key, BotStoreType.BotUserData, <span class="keyword">default</span>(CancellationToken));</div><div class="line"><span class="keyword">var</span> dialogData = botUserData.GetProperty&lt;<span class="keyword">string</span>&gt;(<span class="string">"dialog"</span>);</div><div class="line">resp.Content = <span class="keyword">new</span> StringContent(<span class="string">$"&lt;html&gt;&lt;body&gt;Dialogs:<span class="subst">&#123;dialogData&#125;</span>&lt;/body&gt;&lt;/html&gt;"</span>, System.Text.Encoding.UTF8, <span class="string">@"text/html"</span>);</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">return</span> resp;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>所以在 Dialog 中儲存 State 時 , 可以注意一下這種狀況哦 ^_^</p><p>Demo 專案可以參考 <a href="https://github.com/rainmakerho/Exception_DataChanged" target="_blank" rel="external">rainmakerho/Exception_DataChanged</a></p><h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><p><a href="https://stackoverflow.com/questions/42860020/microsoft-bot-framework-exception-the-data-is-changed" target="_blank" rel="external">Microsoft Bot Framework: Exception: The data is changed</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;最新有個需求就是要判斷目前 User 是不是在進行某項作業, 如果不是就推送包含 Button 的訊息給 User, 不然就推文字通知訊息等
      
    
    </summary>
    
    
      <category term="botframework" scheme="https://rainmakerho.github.io/tags/botframework/"/>
    
      <category term="IBotDataStore" scheme="https://rainmakerho.github.io/tags/IBotDataStore/"/>
    
      <category term="FlushAsync" scheme="https://rainmakerho.github.io/tags/FlushAsync/"/>
    
      <category term="The data is changed" scheme="https://rainmakerho.github.io/tags/The-data-is-changed/"/>
    
  </entry>
  
  <entry>
    <title>Implement global message handlers and resets the dialog stack</title>
    <link href="https://rainmakerho.github.io/2018/06/05/2018019/"/>
    <id>https://rainmakerho.github.io/2018/06/05/2018019/</id>
    <published>2018-06-05T01:45:23.000Z</published>
    <updated>2018-06-05T06:42:55.874Z</updated>
    
    <content type="html"><![CDATA[<p>在 <a href="https://docs.microsoft.com/en-us/azure/bot-service/dotnet/bot-builder-dotnet-global-handlers?view=azure-bot-service-3.0" target="_blank" rel="external">Implement global message handlers</a> 有說明如何透過 global message handlers 來處理一些 help, cancel 等等的全域處理。例如在一個對話當中，使用者輸入了取得待批示的指令，這時需要將處理待批示清單的 Dialog 叫出來，並且將目前處理中的對話堆疉清除(this.task.Reset())。</p><p>這裡要注意的是 this.task.Reset() 一定要放在最後面，不然會噴錯哦! 例如，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">async</span> Task <span class="title">PostAsync</span>(<span class="params">IActivity item, <span class="keyword">string</span> state, CancellationToken token</span>)</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">var</span> message = item <span class="keyword">as</span> IMessageActivity;</div><div class="line">    <span class="keyword">if</span> (message != <span class="literal">null</span>)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">var</span> settingsDialog = <span class="keyword">new</span> SettingsDialog();</div><div class="line">        <span class="keyword">var</span> interruption = settingsDialog.Void&lt;<span class="keyword">object</span>, IMessageActivity&gt;();</div><div class="line">        <span class="keyword">this</span>.task.Call(interruption, <span class="literal">null</span>);</div><div class="line">        <span class="keyword">await</span> <span class="keyword">this</span>.task.PollAsync(token);</div><div class="line">        <span class="comment">// 要清除 DialogStack 的話，請加上 this.task.Reset()</span></div><div class="line">        <span class="keyword">this</span>.task.Reset();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>另外，如果無法在繼承 ScorableBase 的 Class 中去 Reset DialogStack 的話。<br>在 Dialog 中則可以透過 context.EndConversation 去清 DialogStack (非常感謝同事 Marty 的分享)，如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">context.EndConversation(EndOfConversationCodes.CompletedSuccessfully);</div><div class="line">context.Done&lt;<span class="keyword">string</span>&gt;(<span class="literal">null</span>);</div></pre></td></tr></table></figure><p>也可以參考 <a href="https://stackoverflow.com/questions/39113403/terminate-all-dialogs-and-exit-conversation-in-ms-bot-framework-when-the-user-ty/39160430" target="_blank" rel="external">Terminate all dialogs and exit conversation in MS Bot Framework when the user types “exit”, “quit” etc</a> 的方式，如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> (<span class="keyword">var</span> scope = DialogModule.BeginLifetimeScope(Conversation.Container, (IMessageActivity)context.Activity))</div><div class="line">&#123;</div><div class="line"><span class="keyword">var</span> botData = scope.Resolve&lt;IBotData&gt;();</div><div class="line"><span class="keyword">await</span> botData.LoadAsync(<span class="keyword">default</span>(CancellationToken));</div><div class="line"><span class="keyword">var</span> stack = scope.Resolve&lt;IDialogStack&gt;();</div><div class="line">stack.Reset();</div><div class="line"><span class="keyword">await</span> botData.FlushAsync(<span class="keyword">default</span>(CancellationToken));</div><div class="line">&#125;</div><div class="line">context.Done&lt;<span class="keyword">string</span>&gt;(<span class="literal">null</span>);</div></pre></td></tr></table></figure><p>如果在 Dialog 中直接 call context.Reset(); 可是會噴錯的哦!</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;在 &lt;a href=&quot;https://docs.microsoft.com/en-us/azure/bot-service/dotnet/bot-builder-dotnet-global-handlers?view=azure-bot-service-3.0&quot; targe
      
    
    </summary>
    
    
      <category term="botframework" scheme="https://rainmakerho.github.io/tags/botframework/"/>
    
      <category term="IDialogTask" scheme="https://rainmakerho.github.io/tags/IDialogTask/"/>
    
      <category term="ScorableBase" scheme="https://rainmakerho.github.io/tags/ScorableBase/"/>
    
  </entry>
  
  <entry>
    <title>Access BotState when use custom BotDataStore</title>
    <link href="https://rainmakerho.github.io/2018/06/04/2018018/"/>
    <id>https://rainmakerho.github.io/2018/06/04/2018018/</id>
    <published>2018-06-04T08:06:11.000Z</published>
    <updated>2018-06-04T08:31:12.303Z</updated>
    
    <content type="html"><![CDATA[<p>botframework 預設會將 State 存到 state.botframework.com 上去(使用 emulator 則會存在 emulator 上面)。<br><img src="/2018/06/04/2018018/defaultBotStore.png" alt="[defaultBotStore.png]" title="[defaultBotStore.png]"></p><p>目前的 .NET Samples 也都改成使用 InMemoryDataStore 的方式，使用方式如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">Application_Start</span>(<span class="params"></span>)</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line"><span class="comment">//加以下這一段Codes</span></div><div class="line">Conversation.UpdateContainer(</div><div class="line">   builder =&gt;</div><div class="line">   &#123;</div><div class="line">   <span class="comment">//in Memory store</span></div><div class="line">   <span class="keyword">var</span> store = <span class="keyword">new</span> InMemoryDataStore();</div><div class="line">   builder.Register(c =&gt; <span class="keyword">new</span> CachingBotDataStore(store,</div><div class="line">  CachingBotDataStoreConsistencyPolicy.LastWriteWins))</div><div class="line">  .As&lt;IBotDataStore&lt;BotData&gt;&gt;()</div><div class="line">  .AsSelf()</div><div class="line">  .SingleInstance();</div><div class="line">   &#125;);</div><div class="line"><span class="comment">//加以上這一段Codes</span></div><div class="line"></div><div class="line">GlobalConfiguration.Configure(WebApiConfig.Register);</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><p>您也可以將 State 存到 SQL 之中，可以參考 <a href="https://blog.botframework.com/2017/07/26/saving-state-sql-dotnet/" target="_blank" rel="external">Saving State data in SQL with .NET</a>.<br>所以從 Emulator 來看就會看不到 getUserData 及 setUserData 的 event，如下圖，<br><img src="/2018/06/04/2018018/inMemoryBotStore.png" alt="[BotDataStore 讀自 inMemoryBotStore]" title="[BotDataStore 讀自 inMemoryBotStore]"></p><p>當您使用客製的 DataStore 後，Access BotDataStore 就不能直接用 var stateClient = activity.GetStateClient() 。而是要透過 DialogModule.BeginLifetimeScope 來取得，如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> (<span class="keyword">var</span> scope = DialogModule.BeginLifetimeScope(Conversation.Container, activity))</div><div class="line">&#123;</div><div class="line"><span class="keyword">var</span> botDataStore = scope.Resolve&lt;IBotDataStore&lt;BotData&gt;&gt;();</div><div class="line"><span class="keyword">var</span> key = Address.FromActivity(activity);</div><div class="line"><span class="keyword">var</span> chatbotData = <span class="keyword">await</span> botDataStore.LoadAsync(key, BotStoreType.BotUserData, CancellationToken.None);</div><div class="line"><span class="keyword">int</span> ties = chatbotData.GetProperty&lt;<span class="keyword">int</span>&gt;(<span class="string">"ties"</span>);</div><div class="line"><span class="comment">//...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><p>刪除資料就透過 RemoveProperty 來刪除，如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> (<span class="keyword">var</span> scope = DialogModule.BeginLifetimeScope(Conversation.Container, activity))</div><div class="line">&#123;</div><div class="line"><span class="keyword">var</span> botDataStore = scope.Resolve&lt;IBotDataStore&lt;BotData&gt;&gt;();</div><div class="line"><span class="keyword">var</span> key = Address.FromActivity(activity);</div><div class="line"><span class="keyword">var</span> chatbotData = <span class="keyword">await</span> botDataStore.LoadAsync(key, BotStoreType.BotUserData , CancellationToken.None);</div><div class="line">chatbotData.RemoveProperty(<span class="string">"ties"</span>);</div><div class="line"><span class="keyword">await</span> botDataStore.SaveAsync(key, BotStoreType.BotUserData, chatbotData, CancellationToken.None);</div><div class="line"><span class="keyword">await</span> botDataStore.FlushAsync(key, CancellationToken.None);</div><div class="line"><span class="comment">// ...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;botframework 預設會將 State 存到 state.botframework.com 上去(使用 emulator 則會存在 emulator 上面)。&lt;br&gt;&lt;img src=&quot;/2018/06/04/2018018/defaultBotStore.png&quot;
      
    
    </summary>
    
    
      <category term="botframework" scheme="https://rainmakerho.github.io/tags/botframework/"/>
    
      <category term="BotDataStore" scheme="https://rainmakerho.github.io/tags/BotDataStore/"/>
    
      <category term="autofac" scheme="https://rainmakerho.github.io/tags/autofac/"/>
    
      <category term="DialogModule.BeginLifetimeScope" scheme="https://rainmakerho.github.io/tags/DialogModule-BeginLifetimeScope/"/>
    
  </entry>
  
  <entry>
    <title>談談 MSDTC 的問題</title>
    <link href="https://rainmakerho.github.io/2018/05/16/2018017/"/>
    <id>https://rainmakerho.github.io/2018/05/16/2018017/</id>
    <published>2018-05-16T03:01:04.000Z</published>
    <updated>2018-05-16T03:27:03.392Z</updated>
    
    <content type="html"><![CDATA[<h3 id="問題"><a href="#問題" class="headerlink" title="問題"></a>問題</h3><p>MSDTC 不通，無法啟用 MSDTC，協力電腦異動管理員已經停用了對遠端/網路異動的支援，現在看見 MSDTC 真是頭大呀 ~~~</p><h3 id="解決"><a href="#解決" class="headerlink" title="解決"></a>解決</h3><p>昨天客戶的系統有一個請假功能忽然就無法沒有作用，但其他功能是好的。詢問客戶之前有做了些什麼嗎? 客戶說只有一台 switch 壞掉，換新的 siwtch 而已。當下真覺那會不會是網路動了什麼，所以一到客戶那就試看看到底是什麼問題。最後從 log 中發現「MSDTC」的問題。立馬試了 ap &lt;-&gt; db ，用 name 是否可以 ping 得到，結果是可以的。詢問客戶網管，ap &lt;-&gt; db 是否有什麼 rule 擋了那些 port 呢?<br>記得 MSDTC 需要 port 135, ping icmp, 如果有 firewall 的話，要設定某 Port Range 給它，例如 port 5001-6000(可以參考<a href="https://blogs.technet.microsoft.com/askcore/2014/04/29/how-to-configure-msdtc-to-use-a-specific-port-in-windows-server-20122012r2/" target="_blank" rel="external">How to Configure MSDTC to Use a Specific Port in Windows Server 2012/2012R2</a> )。可是網管說沒有擋那些 Port 呀!!!<br>正當一籌莫展之時，客戶的 DBA 詢問說，那 ap 跟 db 本身的 firewall 有沒有開呀!?<br>疑 !!! 檢查了一下，真是有開呢? 先將它關閉試看看，MSDTC 果然就通了。真的非常感謝客戶 IT 的幫忙。</p><p>回到這問題，下次 MSDTC 問題呢? 還是要先從 ap，db 的環境來看 firewall，都沒問題後，再往外去查。附上我們公司整理 MSDTC 排除的相關文件，希望對大家在排除 MSDTC 上有所益助。</p><a href="/2018/05/16/2018017/故障排除指南.doc" title="[MSSQLDTC 故障排除指南.doc]">[MSSQLDTC 故障排除指南.doc]</a><a href="/2018/05/16/2018017/MSDTC.doc" title="[MSDTC.doc]">[MSDTC.doc]</a><a href="/2018/05/16/2018017/CRDSUPPORT3406.txt" title="[協力電腦異動管理員已經停用了對遠端/網路異動的支援.txt]">[協力電腦異動管理員已經停用了對遠端/網路異動的支援.txt]</a>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;問題&quot;&gt;&lt;a href=&quot;#問題&quot; class=&quot;headerlink&quot; title=&quot;問題&quot;&gt;&lt;/a&gt;問題&lt;/h3&gt;&lt;p&gt;MSDTC 不通，無法啟用 MSDTC，協力電腦異動管理員已經停用了對遠端/網路異動的支援，現在看見 MSDTC 真是頭大呀 ~~~&lt;/p&gt;
      
    
    </summary>
    
    
      <category term="MSDTC" scheme="https://rainmakerho.github.io/tags/MSDTC/"/>
    
      <category term="firewall" scheme="https://rainmakerho.github.io/tags/firewall/"/>
    
      <category term="協力電腦異動管理員已經停用了對遠端/網路異動的支援" scheme="https://rainmakerho.github.io/tags/%E5%8D%94%E5%8A%9B%E9%9B%BB%E8%85%A6%E7%95%B0%E5%8B%95%E7%AE%A1%E7%90%86%E5%93%A1%E5%B7%B2%E7%B6%93%E5%81%9C%E7%94%A8%E4%BA%86%E5%B0%8D%E9%81%A0%E7%AB%AF-%E7%B6%B2%E8%B7%AF%E7%95%B0%E5%8B%95%E7%9A%84%E6%94%AF%E6%8F%B4/"/>
    
  </entry>
  
  <entry>
    <title>透過 Microsoft BotFramework-WebChat 的 botchat.js 連接 Botframework 做的 Chatbot ，輕鬆整合到 Web Application 之中</title>
    <link href="https://rainmakerho.github.io/2018/05/10/2018016/"/>
    <id>https://rainmakerho.github.io/2018/05/10/2018016/</id>
    <published>2018-05-10T07:12:02.000Z</published>
    <updated>2018-05-10T09:12:55.987Z</updated>
    
    <content type="html"><![CDATA[<h3 id="問題"><a href="#問題" class="headerlink" title="問題"></a>問題</h3><p>  我們透過 Microsoft BotFramework 來製作 Chatbot 程式後，除了可以接各透的 IM Channel 外，最快速的就是將它整合到現有的 Web Application 之中。<a href="https://github.com/Microsoft/BotFramework-WebChat" target="_blank" rel="external">Microsoft BotFramework-WebChat</a> 已有提供範例讓我們去整合。<br>  但是一般的網站並不需要一下子就顯示 WebChat ，而是在下方需要一個機器人的小圖示，按下去之後再顯示出 WebChat 。</p><h3 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h3><p>  依上面的需求，我們需要 2 個 div, 一個放網頁下方的小圖示(WebChatButton), 另一個是放 WebChat (WebChatDialog)。<br>  所以預設的 html 如下，<br>  <figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">ID</span>=<span class="string">"WebChatButtonD"</span> <span class="attr">onclick</span>=<span class="string">"開啟WebChat的function"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"WebChatDialog"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure></p><p>  透過 botchat.js 來建立 WebChat 需要一些設定值，所以就先定訂這些設定值的 interface ，如下，<br>  <figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">interface</span> IBotChatUIConfig &#123;</div><div class="line">  botId: <span class="built_in">string</span>, </div><div class="line">  botName: <span class="built_in">string</span>,</div><div class="line">  userId: <span class="built_in">string</span>,</div><div class="line">  userName: <span class="built_in">string</span>,</div><div class="line">  botChatIconUrl: <span class="built_in">string</span>, <span class="comment">//下方機器人的圖示</span></div><div class="line">  chatTitle: <span class="built_in">string</span>, <span class="comment">// WebChat Header 的文字</span></div><div class="line">  directLineOptions: <span class="built_in">any</span>, <span class="comment">//DirectLine 的設定</span></div><div class="line">  locale: <span class="built_in">string</span>,  <span class="comment">//語系</span></div><div class="line">  showWebChatButton: <span class="built_in">boolean</span> <span class="comment">// 是否顯示下方的機器人圖示 </span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>  再來可以透過 BotChatUI 來封裝要一開始顯示出網頁下方的機器人圖示，按下後，要開啟 WebChat ，而按下 WebChat 的 Header 後，要將 WebChat Hide 起來，並顯示出機器人的圖示。<br>  <img src="https://github.com/rainmakerho/WebChatCustomization/raw/master/init.png" alt="開始的畫面"><br>  另外，我們也可以透過調整 css 來讓 WebChat 長的不一樣，例如我們可以在 WebChat 中也顯示機器人的圖示。<br>  <img src="https://github.com/rainmakerho/WebChatCustomization/raw/master/chating.png" alt="開啟 WebChat 畫面"></p><p>  所以在即有的 Web Application 之中只要加入 <a href="https://github.com/rainmakerho/WebChatCustomization" target="_blank" rel="external">WebChatCustomization</a> 的 Botchat 目錄中的檔案，然後在要加入 WebChat 的網頁中加入以下的 Script 及設定您要的值，您就會有美美的 WebChat 了哦!<br>  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">&lt;!-- chatbot --&gt;</div><div class="line">&lt;link href=<span class="string">"Botchat/CSS/botchat.css"</span> rel=<span class="string">"stylesheet"</span> /&gt;</div><div class="line">&lt;link href=<span class="string">"Botchat/CSS/botchat-fullwindow.css"</span> rel=<span class="string">"stylesheet"</span> /&gt;</div><div class="line">&lt;link href=<span class="string">"Botchat/CSS/botchatCustom.css"</span> rel=<span class="string">"stylesheet"</span> /&gt;</div><div class="line">&lt;script src=<span class="string">"Botchat/Scripts/botchat-es5.js"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></div><div class="line">&lt;script src=<span class="string">"Botchat/Scripts/BotChatUI.js"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></div><div class="line">&lt;script&gt;</div><div class="line"><span class="keyword">var</span> botChatUI = <span class="keyword">new</span> BotChatUI(&#123;</div><div class="line">botId: <span class="string">'RainmakerBot'</span>,</div><div class="line">botName: <span class="string">'小亂機器人'</span>,</div><div class="line">userId: <span class="string">'Rainmaker'</span>,</div><div class="line">userName: <span class="string">'亂馬客'</span>,</div><div class="line">chatTitle: <span class="string">'小亂機器人, 按我可縮小'</span>,</div><div class="line">locale: <span class="string">'zh-tw'</span>,</div><div class="line">directLineOptions: &#123;</div><div class="line">secret: <span class="string">''</span>,</div><div class="line">token: <span class="string">''</span>,</div><div class="line">domain: <span class="string">'http://localhost:3000/directline/gssbot'</span>,</div><div class="line">pollingInterval: <span class="number">1000</span>,</div><div class="line">webSocket: <span class="literal">false</span></div><div class="line">&#125;,</div><div class="line">botChatIconUrl: <span class="string">'https://avatars2.githubusercontent.com/u/11240907?s=400&amp;u=597a9c2ae536885dae848ed245dc2dfb591a8c28&amp;v=4'</span>,</div><div class="line">showWebChatButton: <span class="literal">true</span></div><div class="line">&#125;);</div><div class="line">&lt;<span class="regexp">/script&gt;</span></div><div class="line"><span class="regexp">&lt;!-- chatbot --&gt;</span></div></pre></td></tr></table></figure></p><p>  因為我想讓 IE 也可以 run ，所以我加入的是 botchat-es5.js。如果您不考慮 IE 的話，可以使用 botchat.js。<br>  在 BotChatUI.ts 中，有特別處理，開啟 WebChat 時才建立 DirectLine 及 WebChat，關閉 WebChat 時，會先儲存 DirectLine 的 ConversationId，並 close 連線。重新開啟 WebChat 時，才知道原本的 ConversationId 是什麼，重新將原本的內容 Load 回來。<br>  為什麼要這樣子呢? 因為我們是使用 <a href="https://github.com/rainmakerho/offline_dl" target="_blank" rel="external">offline Direct Line</a>，目前還不 Support WebSocket ，所以 WebChat 會一直 Polling。所以當關掉 WebChat 時，DirectLine close 後，它就不會再 polling。<br>  那要怎麼讓它重新再連線呢? 目前我們的做法是將原本的 WebChat 移掉再重新建立。詳細可以參考 <a href="https://github.com/rainmakerho/WebChatCustomization/blob/master/BotChatClient/Botchat/TypeScripts/BotChatUI.ts" target="_blank" rel="external">BotChatUI.ts</a> startConversation / endConversation functions。<br>  而重新連的方式，如果有更好的方式會更新上去，如果大家知道的話，也請跟大家分享。</p><h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><p><a href="https://github.com/rainmakerho/WebChatCustomization" target="_blank" rel="external">WebChatCustomization</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;問題&quot;&gt;&lt;a href=&quot;#問題&quot; class=&quot;headerlink&quot; title=&quot;問題&quot;&gt;&lt;/a&gt;問題&lt;/h3&gt;&lt;p&gt;  我們透過 Microsoft BotFramework 來製作 Chatbot 程式後，除了可以接各透的 IM Channel 外，最快
      
    
    </summary>
    
    
      <category term="BotFramework-WebChat" scheme="https://rainmakerho.github.io/tags/BotFramework-WebChat/"/>
    
      <category term="botchat.js" scheme="https://rainmakerho.github.io/tags/botchat-js/"/>
    
      <category term="Botframework" scheme="https://rainmakerho.github.io/tags/Botframework/"/>
    
      <category term="Web Application" scheme="https://rainmakerho.github.io/tags/Web-Application/"/>
    
      <category term="DirectLine" scheme="https://rainmakerho.github.io/tags/DirectLine/"/>
    
  </entry>
  
  <entry>
    <title>Replace JSON 字串中的屬性值 (Replace JSON Value String)</title>
    <link href="https://rainmakerho.github.io/2018/04/17/2018015/"/>
    <id>https://rainmakerho.github.io/2018/04/17/2018015/</id>
    <published>2018-04-17T13:12:50.000Z</published>
    <updated>2018-04-17T13:30:41.556Z</updated>
    
    <content type="html"><![CDATA[<h3 id="問題"><a href="#問題" class="headerlink" title="問題"></a>問題</h3><p>  同事需要將一個 JSON 字串，裡面屬性值需要透過 Replace 的方式，來置換新的內容。但那些內容之中包含一些 JSON 的保留字，例如 / // 等字串。所以字串 Replace 之後，透過 JObject.Parse 去處理就報錯了。<br>  <figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> tmpJsonStringBefore = <span class="string">@"&#123;s:""@s""&#125;"</span>;</div><div class="line"><span class="keyword">var</span> o = JObject.Parse(tmpJsonStringBefore);</div><div class="line"><span class="keyword">var</span> s = <span class="string">"A\" string !@#$%^&amp;*()&#123;&#125;:\"?/?/|\"':&gt;;&gt;&lt;&#123;\"d\":\"v\" value"</span>;</div><div class="line"><span class="keyword">var</span> tmpJsonAfter = tmpJsonStringBefore.Replace(<span class="string">"@s"</span>, s);</div><div class="line"><span class="keyword">var</span> tmpJson = JObject.Parse(tmpJsonAfter);</div><div class="line">Console.WriteLine(tmpJson.ToString());</div></pre></td></tr></table></figure></p><p>  以上的 Code 一執行就會出「<em>Newtonsoft.Json.JsonReaderException: ‘After parsing a value an unexpected character was encountered: s. Path ‘s’, line 1, position 7.’</em>」</p><h3 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h3><p>  這時我們需要針對內容來做 Encode ，可以透過 HttpUtility.JavaScriptStringEncode (加入 System.Web 參考)，如下，<br>  <figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> tmpJsonStringBefore = <span class="string">@"&#123;s:""@s""&#125;"</span>;</div><div class="line"><span class="keyword">var</span> o = JObject.Parse(tmpJsonStringBefore);</div><div class="line"><span class="keyword">var</span> s = <span class="string">"A\" string !@#$%^&amp;*()&#123;&#125;:\"?/?/|\"':&gt;;&gt;&lt;&#123;\"d\":\"v\" value"</span>;</div><div class="line"><span class="keyword">var</span> encodeS = HttpUtility.JavaScriptStringEncode(s);</div><div class="line"><span class="keyword">var</span> tmpJsonAfter = tmpJsonStringBefore.Replace(<span class="string">"@s"</span>, encodeS);</div><div class="line"><span class="keyword">var</span> tmpJson = JObject.Parse(tmpJsonAfter);</div><div class="line">Console.WriteLine(tmpJson.ToString());</div></pre></td></tr></table></figure></p><p>  執行結果如下圖，<br>  <img src="/2018/04/17/2018015/2018015001.png" alt="HttpUtility.JavaScriptStringEncode" title="HttpUtility.JavaScriptStringEncode"> </p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;問題&quot;&gt;&lt;a href=&quot;#問題&quot; class=&quot;headerlink&quot; title=&quot;問題&quot;&gt;&lt;/a&gt;問題&lt;/h3&gt;&lt;p&gt;  同事需要將一個 JSON 字串，裡面屬性值需要透過 Replace 的方式，來置換新的內容。但那些內容之中包含一些 JSON 的保留字，
      
    
    </summary>
    
    
      <category term="JSON" scheme="https://rainmakerho.github.io/tags/JSON/"/>
    
      <category term="Replace" scheme="https://rainmakerho.github.io/tags/Replace/"/>
    
      <category term="special character" scheme="https://rainmakerho.github.io/tags/special-character/"/>
    
      <category term="JavaScriptStringEncode" scheme="https://rainmakerho.github.io/tags/JavaScriptStringEncode/"/>
    
  </entry>
  
  <entry>
    <title>OWASP ZAP 憑證安裝的方式(OWASP ZAP Certificate)</title>
    <link href="https://rainmakerho.github.io/2018/04/10/2018014/"/>
    <id>https://rainmakerho.github.io/2018/04/10/2018014/</id>
    <published>2018-04-10T01:36:19.000Z</published>
    <updated>2018-04-10T03:10:22.368Z</updated>
    
    <content type="html"><![CDATA[<h3 id="問題"><a href="#問題" class="headerlink" title="問題"></a>問題</h3><p>  透過 ZAP 去錄 https 時，如果沒有安裝憑證時，在 Browser 就會出現「 “Your connection is not private”, “你的連線並不安全”」的警告訊息，如下圖所示。<br>  <img src="/2018/04/10/2018014/2018014001.png" alt="Chrome的警告" title="Chrome的警告"> </p>  <img src="/2018/04/10/2018014/2018014002.png" alt="Firefox的警告" title="Firefox的警告"> <h3 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h3><p>  為什麼會出現那個警告訊息呢? 因為 Browser 用的那個憑證已經不是原本連接的那個 host 的憑證，而變成了 OWASP Zed Attack Proxy Root CA 了哦! 而這個憑證並沒有被電腦 Trust 所以就會有那個警告訊息哦!<br>  那要怎麼辦呢? 就是把憑證裝進去電腦的信任區。<br>  以下我們就一步步來說明，</p><h4 id="1-儲存-ZAP-憑證"><a href="#1-儲存-ZAP-憑證" class="headerlink" title="1.儲存 ZAP 憑證"></a>1.儲存 ZAP 憑證</h4><p>  開啟 OWASP ZAP ，Tools -&gt; Options -&gt; Dynamic SSL Certificates -&gt; Save<br>  <img src="/2018/04/10/2018014/2018014003.png" alt="儲存 ZAP 憑證" title="儲存 ZAP 憑證"> </p><h4 id="2-匯入-ZAP-憑證"><a href="#2-匯入-ZAP-憑證" class="headerlink" title="2.匯入 ZAP 憑證"></a>2.匯入 ZAP 憑證</h4><p>  DbClick剛才儲存的憑證檔，按下「Install Certificate…」，並將憑證存到「Trusted Root Certification Authorities」之中，如下，<br>  <img src="/2018/04/10/2018014/2018014004.png" alt="Certificate Import Wizard" title="Certificate Import Wizard"> </p><p>  記得要將憑證存到「Trusted Root Certification Authorities」之中<br>  <img src="/2018/04/10/2018014/2018014005.png" alt="存到「Trusted Root Certification Authorities」" title="存到「Trusted Root Certification Authorities」"> </p><p>  最後按下 Finish 就可以了哦!<br>  <img src="/2018/04/10/2018014/2018014006.png" alt="Import 完成" title="Import 完成"> </p><h4 id="Firefox-匯入-ZAP-憑證"><a href="#Firefox-匯入-ZAP-憑證" class="headerlink" title="Firefox 匯入 ZAP 憑證"></a>Firefox 匯入 ZAP 憑證</h4><p>  因為 firefox 憑證是自已管理的，所以 firefox 也要匯入 ZAP 憑證 ，如果會用 firefox 來錄的話，可以省略這步哦!<br>  firefox 選項 -&gt; 隱私權與安全性 (或在網址列輸入 about:preferences#privacy) -&gt; 檢視憑證<br>  <img src="/2018/04/10/2018014/2018014007.png" alt="隱私權與安全性" title="隱私權與安全性"> </p><p>  匯入 ZAP 憑證<br>  <img src="/2018/04/10/2018014/2018014008.png" alt="匯入 ZAP 憑證" title="匯入 ZAP 憑證"> </p><p>  勾選「信任此憑證機構以識別網站」<br>  <img src="/2018/04/10/2018014/2018014009.png" alt="勾選「信任此憑證機構以識別網站」" title="勾選「信任此憑證機構以識別網站」"> </p><p>  註:透過上述的方式，我們就可以錄 https 的網站，而不會一直出現警告訊息。 如果不會再錄的話，就請記得將 ZAP 的憑證移除哦!</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;問題&quot;&gt;&lt;a href=&quot;#問題&quot; class=&quot;headerlink&quot; title=&quot;問題&quot;&gt;&lt;/a&gt;問題&lt;/h3&gt;&lt;p&gt;  透過 ZAP 去錄 https 時，如果沒有安裝憑證時，在 Browser 就會出現「 “Your connection is not 
      
    
    </summary>
    
    
      <category term="ZAP" scheme="https://rainmakerho.github.io/tags/ZAP/"/>
    
      <category term="Certificate" scheme="https://rainmakerho.github.io/tags/Certificate/"/>
    
      <category term="Chrome" scheme="https://rainmakerho.github.io/tags/Chrome/"/>
    
      <category term="Firefox" scheme="https://rainmakerho.github.io/tags/Firefox/"/>
    
      <category term="Foxproxy" scheme="https://rainmakerho.github.io/tags/Foxproxy/"/>
    
      <category term="ERR_CERT_AUTHORITY_INVALID" scheme="https://rainmakerho.github.io/tags/ERR-CERT-AUTHORITY-INVALID/"/>
    
      <category term="Your connection is not private" scheme="https://rainmakerho.github.io/tags/Your-connection-is-not-private/"/>
    
      <category term="你的連線並不安全" scheme="https://rainmakerho.github.io/tags/%E4%BD%A0%E7%9A%84%E9%80%A3%E7%B7%9A%E4%B8%A6%E4%B8%8D%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>DataGrid 在 ASP.NET 4 的分頁導致第一個欄位會變很寬</title>
    <link href="https://rainmakerho.github.io/2018/04/03/2018013/"/>
    <id>https://rainmakerho.github.io/2018/04/03/2018013/</id>
    <published>2018-04-03T08:44:16.000Z</published>
    <updated>2018-04-03T10:02:08.644Z</updated>
    
    <content type="html"><![CDATA[<h3 id="問題"><a href="#問題" class="headerlink" title="問題"></a>問題</h3><p>最近同事將原本是 ASP.NET 1.1 的程式升級到 .NET 4，但是在 DataGrid 的分頁 postback 後，它的 colspan 就不見了。<br>會讓原本第一行的欄寬變的跟 footer 的分頁一樣寬，如下圖，<br><img src="/2018/04/03/2018013/2018013001.png" alt="DataGrid Paging colspan 問題" title="DataGrid Paging colspan 問題"> </p><h3 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h3><p>想說會不會有人跟我們有一樣的狀況，公司中有很多人都不可置信，ASP.NET 1.1 可以升到 .NET 4.0 。<br>不過，還真的找到了「<a href="https://jwcooney.com/2012/01/11/asp-net-gridview-paging-problem-paging-increases-the-first-column-width/" target="_blank" rel="external">ASP.NET GridView Paging Problem – Paging Increases the First Column Width</a>」這篇。<br>它是在 .NET 2.0 遇到的問題，原來只要在 PreRender 時，設定 Footer 的 colspan 就好了，所以程式如下，</p><pre><code class="vb"><span class="comment">'請在 PreRender 加這一段，解決 DataGrid Footer 分頁在 .NET 4.x 中 ColSpan 問題 ...  </span><span class="keyword">If</span> <span class="keyword">Me</span>.AllowPaging <span class="keyword">AndAlso</span> <span class="keyword">Me</span>.Controls.Count &gt; <span class="number">0</span> <span class="keyword">Then</span>    <span class="keyword">Dim</span> tbl <span class="keyword">As</span> Table = <span class="built_in">CType</span>(<span class="keyword">Me</span>.Controls(<span class="number">0</span>), Table)    <span class="keyword">Dim</span> pagerRow <span class="keyword">As</span> TableRow = tbl.Rows(tbl.Rows.Count - <span class="number">1</span>)    <span class="keyword">Dim</span> colSpanCount <span class="keyword">as</span> <span class="built_in">String</span> = tbl.Rows(<span class="number">1</span>).Cells.Count.ToString()    pagerRow.Cells(<span class="number">0</span>).Attributes.Add(<span class="string">"colspan"</span>, colSpanCount)<span class="keyword">End</span> <span class="keyword">If</span></code></pre><p>希望對想要使用 DataGrid 在 asp.net 4.0 上使用的人有所幫助。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;問題&quot;&gt;&lt;a href=&quot;#問題&quot; class=&quot;headerlink&quot; title=&quot;問題&quot;&gt;&lt;/a&gt;問題&lt;/h3&gt;&lt;p&gt;最近同事將原本是 ASP.NET 1.1 的程式升級到 .NET 4，但是在 DataGrid 的分頁 postback 後，它的 cols
      
    
    </summary>
    
    
      <category term="DataGrid" scheme="https://rainmakerho.github.io/tags/DataGrid/"/>
    
      <category term=".net 4" scheme="https://rainmakerho.github.io/tags/net-4/"/>
    
      <category term="Paging" scheme="https://rainmakerho.github.io/tags/Paging/"/>
    
      <category term="colspan" scheme="https://rainmakerho.github.io/tags/colspan/"/>
    
      <category term="first column" scheme="https://rainmakerho.github.io/tags/first-column/"/>
    
  </entry>
  
  <entry>
    <title>SmtpConnection.GetConnection NullReferenceException</title>
    <link href="https://rainmakerho.github.io/2018/03/14/2018012/"/>
    <id>https://rainmakerho.github.io/2018/03/14/2018012/</id>
    <published>2018-03-14T02:07:16.000Z</published>
    <updated>2018-03-14T03:05:46.287Z</updated>
    
    <content type="html"><![CDATA[<h3 id="問題"><a href="#問題" class="headerlink" title="問題"></a>問題</h3><p>最近同事問一個透過 SmtpClient 寄信的問題，因為客戶移機，所以將原本在 Windows 2008 x64 上的程式移到，Windows 2016 上去。<br>我們的程式是 .NET 3.5 ，所以在移機上並不會有什麼問題。<br>測試上都 OK，就只有一支執行檔在寄發 Mail 時，會發生 NullReferenceException: Object reference not set to an instance of an object. ，如下，</p><blockquote><p>System.Net.Mail.SmtpConnection.GetConnection  &lt;System.NullReferenceException&gt; 並未將物件參考設定為物件的執行個體<br>  at System.Net.Mail.SmtpClient.Send  &lt;System.Net.Mail.SmtpException&gt; 傳送郵件失敗。<br>  於 System.Net.Mail.SmtpClient.Send(MailMessage message) </p></blockquote><h3 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h3><p>於是寫了測試程式來測試，卻是 OK 的，如下<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> smpt = <span class="keyword">new</span> System.Net.Mail.SmtpClient();</div><div class="line">smpt.Host = <span class="string">"mail.rm.com.tw"</span>;</div><div class="line"><span class="keyword">var</span> credentials = <span class="keyword">new</span> NetworkCredential(<span class="string">"rainmaker_ho"</span>, <span class="string">""</span>);</div><div class="line"><span class="keyword">var</span> msg = <span class="keyword">new</span> System.Net.Mail.MailMessage();</div><div class="line">smpt.Credentials = credentials;</div><div class="line">msg.From = <span class="keyword">new</span> MailAddress(<span class="string">"rainmaker_ho@mail.rm.com.tw"</span>);</div><div class="line">msg.Subject = <span class="string">"subject"</span>;</div><div class="line">msg.Body = <span class="string">"body"</span>;</div><div class="line">msg.To.Add(<span class="keyword">new</span> MailAddress(<span class="string">"rainmaker_ho@mail.rm.com.tw"</span>));</div><div class="line"><span class="keyword">try</span></div><div class="line">&#123;</div><div class="line">smpt.Send(msg);</div><div class="line">&#125;</div><div class="line"><span class="keyword">catch</span> (Exception e)</div><div class="line">&#123;</div><div class="line">Console.WriteLine(e.ToString());</div><div class="line"><span class="keyword">throw</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>大家可以發現，NetworkCredential 只 Assign 使用者代號，使用者密碼是給空字串。<br>有些 mail server 是允許發給內部使用者時，不需要驗證的(有點像是撥打內網不用付費)。<br>模擬執行檔去呼叫也沒問題。<br>而錯誤訊息(SmtpConnection.GetConnection NullReferenceException)也叫人不知如何是好 …<br>正當絕望之際，忽然想到，我的測試程式預設是使用 .NET 4.6 ，而我的執行檔是 .NET 3.5 的。<br>於是將測試程式切到 .NET 3.5 一試，一樣的錯誤出現了 …<br><img src="/2018/03/14/2018012/2018012001.png" alt="SmtpConnection.GetConnection NullReferenceException" title="SmtpConnection.GetConnection NullReferenceException"><br>於是再將 NetworkCredential 的使用者代號也給空字串，再測試就沒有問題了。<br>以這個問題的解法有2個，</p><ol><li>如果不需要驗證的話，NetworkCredential 的使用者及密碼都給空字串。</li><li>設定執行檔的 config ，讓它走 .NET 4.0 因為這樣子的狀況，在 .NET 4.0 是沒問題的。<blockquote><p>&lt;startup&gt;&lt;supportedRuntime version=”v4.0” sku=”.NETFramework,Version=v4.0”/&gt;&lt;/startup&gt;</p></blockquote></li></ol><p>嗯… 不過，為什麼舊的 Windows 2008 Server 卻不會有這種問題呢? 筆者在另一台 Windows 2008 R2 Server 上試也是 GG 。<br>以下是 Windows 2008 Server 上關於 .net 3.5 的更新，<br><img src="/2018/03/14/2018012/2018012002.png" alt="Windows 2008 Server .net 3.5 的更新" title="Windows 2008 Server .net 3.5 的更新"> </p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;問題&quot;&gt;&lt;a href=&quot;#問題&quot; class=&quot;headerlink&quot; title=&quot;問題&quot;&gt;&lt;/a&gt;問題&lt;/h3&gt;&lt;p&gt;最近同事問一個透過 SmtpClient 寄信的問題，因為客戶移機，所以將原本在 Windows 2008 x64 上的程式移到，Windo
      
    
    </summary>
    
    
      <category term="NullReferenceException" scheme="https://rainmakerho.github.io/tags/NullReferenceException/"/>
    
      <category term="SmtpClient" scheme="https://rainmakerho.github.io/tags/SmtpClient/"/>
    
      <category term="SmtpConnection.GetConnection" scheme="https://rainmakerho.github.io/tags/SmtpConnection-GetConnection/"/>
    
      <category term=".net" scheme="https://rainmakerho.github.io/tags/net/"/>
    
      <category term="NetworkCredential" scheme="https://rainmakerho.github.io/tags/NetworkCredential/"/>
    
      <category term="password" scheme="https://rainmakerho.github.io/tags/password/"/>
    
      <category term="empty" scheme="https://rainmakerho.github.io/tags/empty/"/>
    
  </entry>
  
  <entry>
    <title>System.NullReferenceException when Aspose.Pdf.License.SetLicense(String licenseName)</title>
    <link href="https://rainmakerho.github.io/2018/03/13/2018011/"/>
    <id>https://rainmakerho.github.io/2018/03/13/2018011/</id>
    <published>2018-03-13T06:54:05.000Z</published>
    <updated>2018-03-14T02:08:58.990Z</updated>
    
    <content type="html"><![CDATA[<h3 id="問題"><a href="#問題" class="headerlink" title="問題"></a>問題</h3><p>最近在 Web 使用 Aspose.Pdf 來產生文件時，有時候會忽然出現 <em>System.NullReferenceException</em> 的錯誤。<br>而錯誤的地方居然是在 License.SetLicense 的 Method，如下，<br>System.NullReferenceException: 並未將物件參考設定為物件的執行個體。<br>    於 .(Stream )<br>    於 .(String , Assembly )<br>    於 Aspose.Pdf.License.SetLicense(String licenseName)</p><h3 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h3><p>直覺來看應該是 License 檔案壞了，所以請同事更新 License 檔，再執行就好了。<br>可是過沒多久，又發生一樣的問題。<br>我們操作 Aspose 元件的方式是，一開始先設定 License ，再建立要使用的元件，如下，<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> lic = <span class="keyword">new</span> License();</div><div class="line">lic.SetLicense(<span class="string">"aspose.total.lic"</span>);</div><div class="line"><span class="keyword">var</span> pdfDoc = <span class="keyword">new</span> Document(<span class="string">@"c:\xx\node.pdf"</span>);</div></pre></td></tr></table></figure></p><p>在網路上似乎也有人談到這種問題。或許在 Web 環境中，又有多執行緒下所造成的。<br>所以在 Page_Load 中寫了以下的程式來測試，果然馬上出現 NullReferenceException 的錯誤，如下，<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">Parallel.For(<span class="number">0</span>, <span class="number">10</span>, <span class="keyword">delegate</span> (<span class="keyword">int</span> i)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">try</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">var</span> lic = <span class="keyword">new</span> License();</div><div class="line">        lic.SetLicense(<span class="string">"aspose.total.lic"</span>);</div><div class="line">        <span class="keyword">var</span> pdfDoc = <span class="keyword">new</span> Document(<span class="string">@"c:\xx\node.pdf"</span>);</div><div class="line">        Debug.WriteLine(<span class="string">$"<span class="subst">&#123;i&#125;</span>:<span class="subst">&#123;pdfDoc.IsLinearized&#125;</span>"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">catch</span> (Exception ex)</div><div class="line">    &#123;</div><div class="line">        ebug.WriteLine(<span class="string">$"<span class="subst">&#123;i&#125;</span>:<span class="subst">&#123;ex&#125;</span>"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;);</div><div class="line"><span class="keyword">var</span> pdfDocx = <span class="keyword">new</span> Document(<span class="string">@"c:\xx\node.pdf"</span>);</div><div class="line">Response.Write(pdfDocx.IsLinearized);</div></pre></td></tr></table></figure></p><p>這個問題原廠已記錄在未來應該會修正這個問題。<br>而目前的話，如果設定 License 的話，就在 global.asax 中的 Application_Start Event 設定即可。<br>在其他地方就不需要再設定 License ，以免出現 NullReferenceException 。<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">Application_Start</span>(<span class="params"><span class="keyword">object</span> sender, EventArgs e</span>)</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line"><span class="keyword">var</span> licPdf = <span class="keyword">new</span> License();</div><div class="line">licPdf.SetLicense(<span class="string">"aspose.total.lic"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;問題&quot;&gt;&lt;a href=&quot;#問題&quot; class=&quot;headerlink&quot; title=&quot;問題&quot;&gt;&lt;/a&gt;問題&lt;/h3&gt;&lt;p&gt;最近在 Web 使用 Aspose.Pdf 來產生文件時，有時候會忽然出現 &lt;em&gt;System.NullReferenceExceptio
      
    
    </summary>
    
    
      <category term="Aspose" scheme="https://rainmakerho.github.io/tags/Aspose/"/>
    
      <category term="SetLicense" scheme="https://rainmakerho.github.io/tags/SetLicense/"/>
    
      <category term="NullReferenceException" scheme="https://rainmakerho.github.io/tags/NullReferenceException/"/>
    
  </entry>
  
  <entry>
    <title>透過 WinDbg 來找出 ASP.NET CPU 100% ASP.NET 程式的問題</title>
    <link href="https://rainmakerho.github.io/2018/03/05/2018010/"/>
    <id>https://rainmakerho.github.io/2018/03/05/2018010/</id>
    <published>2018-03-05T06:19:38.000Z</published>
    <updated>2018-03-31T01:09:32.803Z</updated>
    
    <content type="html"><![CDATA[<h3 id="問題"><a href="#問題" class="headerlink" title="問題"></a>問題</h3><p>我們有一個 ASP.NET 的系統部署到 IIS 上(Windows 2012, .NET 4.x)，有時候會導致 w3wp.exe 吃掉所有的 CPU 資源，一直要等到應用程式回收後，程式再重新啟動後就正常了。這種狀況不定期會發生。 </p><h3 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h3><p>我們可以使用 WinDbg 來找出導致 IIS CPU 100% 的原因，方法如下， </p><ul><li><p>透過「工作管理員」來「建立傾印檔案」<br>當發生 IIS 導致 CPU 100% 時，開啟「工作管理員」，按右鍵選取「建立傾印檔案」。要依 Web 應用程式的平台(x86/x64)來開啟「工作管理員」(x86的工作管理員在 C:\Windows\SysWOW64\taskmgr.exe )。</p></li><li><p>安裝 WinDbg<br>請參考 <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/" target="_blank" rel="external">Debugging Tools for Windows (WinDbg, KD, CDB, NTSD)</a> 來安裝對應的版本。</p></li><li><p>設定 Symbol Path<br>先建立一個 C:\RTX64_SYMBOLS 目錄(依您自行定義)，然後開啟 Command 設定 _NT_SYMBOL_PATH 的環境變數，如下，</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">set _NT_SYMBOL_PATH=srv*C:\RTX64_SYMBOLS*https://msdl.microsoft.com/download/symbols</div></pre></td></tr></table></figure><img src="/2018/03/05/2018010/201801001.png" alt="set _NT_SYMBOL_PATH" title="set _NT_SYMBOL_PATH"> <p>所以在 command 中，輸入 set 後，就可以看到 _NT_SYMBOL_PATH 的設定值哦，</p><img src="/2018/03/05/2018010/201801002.png" alt="_NT_SYMBOL_PATH" title="_NT_SYMBOL_PATH"> <p>當然，如果常常會用到的話，就直接設定到 環境變數之前，下次 debug 時，就不用再設定一次了哦! 詳細請參考<a href="https://www.hanselman.com/blog/SetUpYourSystemToUseMicrosoftsPublicSymbolServer.aspx" target="_blank" rel="external">Set up your system to use Microsoft’s public Symbol Server</a></p></li><li><p>在 WinDbg 中找問題</p><ul><li><p>載入 sos.dll</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">.load C:\Windows\Microsoft.NET\Framework64\v4.0.30319\sos.dll</div></pre></td></tr></table></figure><p>WinDbg 有 x86/x64 的版本，我是使用 x64 的版本，所以 sos.dll 的路徑是 C:\Windows\Microsoft.NET\Framework64\v4.0.30319\sos.dll，您輸入如果發生錯誤的話，請使用 C:\Windows\Microsoft.NET\Framework\v4.0.30319\sos.dll 。</p></li><li><p>設定 Symbol 檔目錄</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">!sym noisy</div><div class="line">.cordll -ve -u  -l</div></pre></td></tr></table></figure></li><li><p>透過 !runaway 顯示Threads所佔的時間<br>輸入 !runaway 後，會顯示各 Thread 所花費的時間，花最多的會在最上面，如下圖，</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">!runaway</div></pre></td></tr></table></figure><img src="/2018/03/05/2018010/201801003.png" alt="!runaway" title="!runaway"></li><li><p>透過 ~[thread]s 切換到該 thread 的位置<br>由上圖所示，Thread 40 佔最多時間，所以我們切到它的位罝去，</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~40s</div></pre></td></tr></table></figure><img src="/2018/03/05/2018010/201801004.png" alt="~40s" title="~40s"></li><li><p>透過 !clrstack 來查看呼叫堆疉</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">!clrstack</div></pre></td></tr></table></figure><img src="/2018/03/05/2018010/201801005.png" alt="!clrstack" title="!clrstack"><p>從上圖可以發現，應該是有關 Dictionary 操作的問題，而它是由我們系統中 TemplateCfg.initial() 這個 Method 所引起的。</p></li></ul></li><li><p>檢視並調整程式碼<br>開啟 TemplateCfg 程式碼，在 initial 這個 Method 之中會建立 Dictionary 物件，Clear 它，並 Insert 資料，但這些 Dictionary 的變數卻又設定成 static 。</p><img src="/2018/03/05/2018010/201801006.png" alt="TemplateCfg.initial()" title="TemplateCfg.initial()"><p>即然這些 Dictionary 是 static 的，而且它們值又都是相同的，就沒有必要每次 request 時，就重新建立並 insert 這些資料。<br>所以將 initial 裡面的 Code 搬到  static constructor 。<br>調整完程式碼後，從去年觀察到目前，已經沒有再發生 CPU 100% 的狀況。</p></li></ul><h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><p><a href="http://improve.dk/debugging-in-production-part-1-analyzing-100-cpu-usage-using-windbg/" target="_blank" rel="external">Debugging in Production Part 1 - Analyzing 100% CPU Usage Using Windbg</a><br><a href="http://blog.darkthread.net/post-2017-02-20-windbg-to-find-aspnet-cpu-high.aspx" target="_blank" rel="external">WinDBG 應用實例：找出 ASP.NET CPU 100% 原因</a><br><a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/" target="_blank" rel="external">Debugging Tools for Windows (WinDbg, KD, CDB, NTSD)</a><br><a href="https://www.hanselman.com/blog/SetUpYourSystemToUseMicrosoftsPublicSymbolServer.aspx" target="_blank" rel="external">Set up your system to use Microsoft’s public Symbol Server</a><br><a href="https://channel9.msdn.com/Series/-NET-Debugging-Stater-Kit-for-the-Production-Environment/High-CPU-Hangs-05" target="_blank" rel="external">High CPU Hangs - 05</a><br><a href="http://www.infoq.com/cn/articles/architecture-practice-13-windbg" target="_blank" rel="external">中小型研发团队架构实践：生产环境诊断利器WinDbg帮你快速分析异常情况Dump文件</a><br><a href="https://blogs.msdn.microsoft.com/kaevans/2011/04/11/intro-to-windbg-for-net-developers/" target="_blank" rel="external">Intro to WinDBG for .NET Developers</a><br><a href="https://blogs.msdn.microsoft.com/tess/2008/02/27/net-debugging-demos-lab-4-high-cpu-hang-review/" target="_blank" rel="external">.NET Debugging Demos Lab 4: High CPU Hang – Review</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;問題&quot;&gt;&lt;a href=&quot;#問題&quot; class=&quot;headerlink&quot; title=&quot;問題&quot;&gt;&lt;/a&gt;問題&lt;/h3&gt;&lt;p&gt;我們有一個 ASP.NET 的系統部署到 IIS 上(Windows 2012, .NET 4.x)，有時候會導致 w3wp.exe 吃掉所
      
    
    </summary>
    
    
      <category term="IIS" scheme="https://rainmakerho.github.io/tags/IIS/"/>
    
      <category term="CPU" scheme="https://rainmakerho.github.io/tags/CPU/"/>
    
      <category term="100%" scheme="https://rainmakerho.github.io/tags/100/"/>
    
      <category term="WinDbg" scheme="https://rainmakerho.github.io/tags/WinDbg/"/>
    
      <category term="ASP.NE" scheme="https://rainmakerho.github.io/tags/ASP-NE/"/>
    
      <category term="w3wp.exe" scheme="https://rainmakerho.github.io/tags/w3wp-exe/"/>
    
  </entry>
  
  <entry>
    <title>無法載入檔案或組件 &#39;log4net, Version=1.2.10.0, Culture=neutral, PublicKeyToken=692fbea5521e1304&#39; 或其相依性的其中之一。</title>
    <link href="https://rainmakerho.github.io/2018/02/14/2018009/"/>
    <id>https://rainmakerho.github.io/2018/02/14/2018009/</id>
    <published>2018-02-14T14:12:46.000Z</published>
    <updated>2018-03-14T03:08:54.691Z</updated>
    
    <content type="html"><![CDATA[<p>最近同事詢問他們使用 Crytal Report Viewer 時，會發生 log4net 版本衝突的問題。如下圖所示， </p><img src="/2018/02/14/2018009/2018009001.png" alt="CrystalReportViewer Runtime Error" title="CrystalReportViewer Runtime Error"> <p>如果是不同版本衝突的話，可以參考 <a href="https://dotblogs.com.tw/rainmaker/2015/11/25/153805" target="_blank" rel="external">如何讓不同 PublicKeyToken 的 DLL assemblyBinding 到可以用版本?</a> 透過 assemblyBinding 的方式就可以解決。 但剛好我們的 AP 自已用的 log4net 版本也是 1.2.10.0，所以是 <strong>相同版本，不同的 PublickToken</strong> 的衝突。 詳細訊息如下， </p><p><em>沒有辦法解決 “log4net, Version=1.2.10.0, Culture=neutral, PublicKeyToken=1b44e1d426115821” 和 “log4net, Version=1.2.10.0, Culture=neutral, PublicKeyToken=692fbea5521e1304” 之間的衝突。<br>任意選擇 “log4net, Version=1.2.10.0, Culture=neutral, PublicKeyToken=1b44e1d426115821”。</em>  </p><p>有查到 <a href="https://stackoverflow.com/questions/11673383/error-could-not-load-log4net-assembly" target="_blank" rel="external">Error: Could not load log4net assembly</a> 似乎是因為不同的平台(x86/x64) 所用的 log4net 會不同。<br>x86(32位元)用的 PublicToken 是 692fbea5521e1304，x64(64位元)或是 AnyCPU 用的 PublicToken 則是 1b44e1d426115821。<br>而我們 ap 平台是 x64 的，但 Crystal Report Viewer 卻使用了 x86(32位元) 的 log4net 。</p><p>… 我想應該是那裡設定出了錯吧 … </p><p>同事說只有在某台機器上才會出現那個錯誤，如果是透過 Browser 直接使用系統就正常，透過 VS.NET 啟動程式去 Debug 時，就會出現那個錯誤。<br>我想是因為如果透過 Browser 去使用系統的話，是連到 IIS ，而 IIS 設定的是 x64(64位元);如果透過 VS.NET 則是連到 IIS Express，預設它是使用 x86(32位元)。<br>於是筆者將 IIS 上的應用程式集區設定成 啟用 32 位元，再執行程式，則一樣會出現 log4net 的衝突狀況(ya. 重現問題了 …)。<br>所以就請同事在 VS.NET 中設定讓 IIS Express 使用 64 位元就沒問題了哦!<br>工具 -&gt; 選項 -&gt; (search textbox 中輸入 iis) , 並勾選 將 64 位元版本的 IIS Express 用於網站和專案(U) 選項勾起來就可以了哦! 如下，<br><img src="/2018/02/14/2018009/2018009002.png" alt="將 64 位元版本的 IIS Express 用於網站和專案(U)" title="將 64 位元版本的 IIS Express 用於網站和專案(U)"> </p><p>如果您是系統出了錯，請 Check 應用程式集區是否設定成了 「啟用32位元應用程式」哦!</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;最近同事詢問他們使用 Crytal Report Viewer 時，會發生 log4net 版本衝突的問題。如下圖所示， &lt;/p&gt;
&lt;img src=&quot;/2018/02/14/2018009/2018009001.png&quot; alt=&quot;CrystalReportViewer 
      
    
    </summary>
    
    
      <category term="log4net" scheme="https://rainmakerho.github.io/tags/log4net/"/>
    
      <category term="1.2.10.0" scheme="https://rainmakerho.github.io/tags/1-2-10-0/"/>
    
      <category term="692fbea5521e1304" scheme="https://rainmakerho.github.io/tags/692fbea5521e1304/"/>
    
      <category term="1b44e1d426115821" scheme="https://rainmakerho.github.io/tags/1b44e1d426115821/"/>
    
  </entry>
  
</feed>
