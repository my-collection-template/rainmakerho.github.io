<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>亂馬客 - Re:從零開始的軟體開發生活</title>
  <icon>https://www.gravatar.com/avatar/cd3aed042ccd7a5a5d9956b0bc07dc81</icon>
  <subtitle>Re:從零開始的軟體開發生活</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://rainmakerho.github.io/"/>
  <updated>2019-10-25T03:55:41.324Z</updated>
  <id>https://rainmakerho.github.io/</id>
  
  <author>
    <name>亂馬客</name>
    <email>rainmaker_ho@gss.com.tw</email>
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>HTTP 錯誤 500.52 - URL Rewrite Module Error.</title>
    <link href="https://rainmakerho.github.io/2019/10/24/2019032/"/>
    <id>https://rainmakerho.github.io/2019/10/24/2019032/</id>
    <published>2019-10-24T02:14:24.000Z</published>
    <updated>2019-10-25T03:55:41.324Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>我們使用 iisnode 時，會用到 IIS URLRewrite ，而且需要啟用一些 Server Variables，所以在 Web.Config 中設定 rewrite/allowedServerVariables，如下，</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">system.webServer</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rewrite</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">allowedServerVariables</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">"HTTP_X_ORIGINAL_URL"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">"UNENCODED_URL"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">"HTTP_CONNECTION"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">allowedServerVariables</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">rules</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">rule</span> <span class="attr">name</span>=<span class="string">"all"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">match</span> <span class="attr">url</span>=<span class="string">"/*"</span> /&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">action</span> <span class="attr">type</span>=<span class="string">"Rewrite"</span> <span class="attr">url</span>=<span class="string">"index.js"</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">rules</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rewrite</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">system.webServer</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><p>但在執行網頁時，就會出現「HTTP 錯誤 500.52 - URL Rewrite Module Error.」的錯誤，完整如下，</p><blockquote><p>這個設定區段不能在這個路徑中使用。<br>當區段在父層級被鎖定時就會發生這種情況。鎖定可能是預設 (overrideModeDefault=”Deny”)，<br>或是由位置標記使用 overrideMode=”Deny” 或繼承的 allowOverride=”false” 明確設定。</p></blockquote><h3 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h3><h4 id="手動調整"><a href="#手動調整" class="headerlink" title="手動調整"></a>手動調整</h4><p>從訊息來看，直覺的做法是去修改 “C:\Windows\System32\inetsrv\config\applicationHost.config” 中的 rewrite sessionGroup，將裡面的 allowedServerVariables 的 overrideModeDefault 從 Deny 改成 Allow 。</p><h4 id="PowerShell"><a href="#PowerShell" class="headerlink" title="PowerShell"></a>PowerShell</h4><p>那 PowerShell 要如何修改它呢? 可以參考 <a href="https://blogs.iis.net/jeonghwan/examples-of-iis-powershell-cmdlets" target="_blank" rel="noopener">Examples of IIS Powershell cmdlets</a> ，直接改它的值，如下，</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Set-WebConfigurationProperty -filter /system.webServer/rewrite -name <span class="string">'sections["allowedServerVariables"].OverrideModeDefault'</span> -value Allow -pspath iis:\</span><br></pre></td></tr></table></figure><p>另外 Garry 大大也提供加到 applicationHost.config 的 location 區段之中，也是可以的哦，如下，</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[System.Reflection.Assembly]::LoadWithPartialName(“Microsoft.Web.Administration”)</span><br><span class="line"><span class="variable">$servmgr</span> = <span class="built_in">New-Object</span> Microsoft.Web.Administration.ServerManager</span><br><span class="line"><span class="variable">$config</span> = <span class="variable">$servmgr</span>.GetApplicationHostConfiguration()</span><br><span class="line"><span class="variable">$section</span> = <span class="variable">$config</span>.GetSection(<span class="string">'system.webServer/rewrite/allowedServerVariables'</span>)</span><br><span class="line"><span class="variable">$section</span>.OverrideMode =[Microsoft.Web.Administration.OverrideMode]::Allow</span><br><span class="line"><span class="variable">$servmgr</span>.CommitChanges()</span><br></pre></td></tr></table></figure><h4 id="補充說明"><a href="#補充說明" class="headerlink" title="補充說明:"></a>補充說明:</h4><p>當有多個 msi 檔要透過 msiexec.exe 來安裝時，要使用 -Wait 哦!<br>最近遇到沒使用 -Wait 時，有些無法安裝成功哦! 例如我要同時裝 Node, iisnde 及 IIS UrlRewrite，</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">Start-Process</span> msiexec.exe -Wait -ArgumentList <span class="string">'/I node-v10.16.3-x64.msi /passive'</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">Start-Process</span> urlrewrite2.exe -Wait</span><br><span class="line"><span class="built_in">Start-Process</span> msiexec.exe -Wait -ArgumentList <span class="string">'/I iisnode-full-v0.2.21-x64.msi /passive'</span></span><br></pre></td></tr></table></figure><h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><p><a href="https://gist.github.com/ducas/b16dfd1d9ba91da7fd53" target="_blank" rel="noopener">Configure-UrlRewriteRules.ps1</a><br><a href="https://blogs.iis.net/jeonghwan/examples-of-iis-powershell-cmdlets" target="_blank" rel="noopener">Examples of IIS Powershell cmdlets</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;我們使用 iisnode 時，會用到 IIS URLRewrite ，而且需要啟用一些 Server Variables，所以在 Web.
      
    
    </summary>
    
    
      <category term="RewriteModule" scheme="https://rainmakerho.github.io/tags/RewriteModule/"/>
    
      <category term="2147942433" scheme="https://rainmakerho.github.io/tags/2147942433/"/>
    
      <category term="overrideModeDefault=&quot;Deny&quot;" scheme="https://rainmakerho.github.io/tags/overrideModeDefault-Deny/"/>
    
      <category term="allowedServerVariables" scheme="https://rainmakerho.github.io/tags/allowedServerVariables/"/>
    
  </entry>
  
  <entry>
    <title>ASP.NET Session 值為空或是無法改變的問題</title>
    <link href="https://rainmakerho.github.io/2019/10/07/2019031/"/>
    <id>https://rainmakerho.github.io/2019/10/07/2019031/</id>
    <published>2019-10-07T08:55:59.000Z</published>
    <updated>2019-10-07T09:19:57.302Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>最近同事詢問，有一個系統，分別裝在不同的 VM 上面，程式碼完全一樣，然而狀況卻是一個系統可正常登入，另一個則登入不進去。<br>查看後發現，無法登入的那個系統，Session 值都是空的。</p><h3 id="研究"><a href="#研究" class="headerlink" title="研究"></a>研究</h3><p>請同事用 Fiddler 錄一下各別的登入狀況後，發現在 Set-Cookie 有些許的差異，如下，</p><p>可以正常登入的系統 Set-Cookie 如下，</p><blockquote><p>Set-Cookie: ASP.NET_SessionId=304t3ljikywnupq1d0pox4oe; path=/; HttpOnly</p></blockquote><p>無法正常登入的系統 Set-Cookie 如下，</p><blockquote><p>Set-Cookie: ASP.NET_SessionId=1op3avwog33degwqhk0ywnc0; path=/; secure; HttpOnly</p></blockquote><p>它們的差異就是無法正常登入的系統，Set-Cookie 多了 secure ，<br>再看同事測試的網址是 http ，而設定檔中又設定「requireSSL=”true”」，所以就無法改變 Session 的值，Session 的值就是空值或是之前改過的值。<br>因為是測試機，所以是走 http ，所以將 coonfig 中的 requireSSL 改成 false ，就可以正常 Work 。<br>所以 config 中的 requireSSL 的值，請搭配 http or https 。<br>或都為 true ，如果沒有憑證就建立自簽憑證，然後走 https 會跟正式環境比較一致。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">system.web</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">httpCookies</span> <span class="attr">httpOnlyCookies</span>=<span class="string">"true"</span> <span class="attr">requireSSL</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">authentication</span> <span class="attr">mode</span>=<span class="string">"Forms"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">forms</span> <span class="attr">requireSSL</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">authentication</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">system.web</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><p><a href="https://aboutssl.org/how-to-create-a-self-signed-certificate-in-iis/" target="_blank" rel="noopener">Step-by-step Guide to create a Self Signed Certificate in IIS</a><br><a href="https://www.starwindsoftware.com/blog/using-the-microsoft-certificate-authority-to-get-rid-of-those-self-signed-certs" target="_blank" rel="noopener">Using the Microsoft Certificate Authority to get rid of those self-signed certs</a><br><a href="https://techcommunity.microsoft.com/t5/IIS-Support-Blog/SHA-256-Self-Signed-Certificate-for-Windows-Server-2012-R2/ba-p/376391" target="_blank" rel="noopener">SHA-256 Self Signed Certificate for Windows Server 2012 R2</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;最近同事詢問，有一個系統，分別裝在不同的 VM 上面，程式碼完全一樣，然而狀況卻是一個系統可正常登入，另一個則登入不進去。&lt;br&gt;查看後發現
      
    
    </summary>
    
    
      <category term="empty" scheme="https://rainmakerho.github.io/tags/empty/"/>
    
      <category term="asp.net" scheme="https://rainmakerho.github.io/tags/asp-net/"/>
    
      <category term="session" scheme="https://rainmakerho.github.io/tags/session/"/>
    
  </entry>
  
  <entry>
    <title>Chrome Version 77 列印遇到標楷體(DFKai-SB) Print 成 PDF 會破字問題</title>
    <link href="https://rainmakerho.github.io/2019/10/04/2019030/"/>
    <id>https://rainmakerho.github.io/2019/10/04/2019030/</id>
    <published>2019-10-04T08:58:46.000Z</published>
    <updated>2019-10-05T00:22:56.558Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>最近同事發現，原本透過 Chrome V77 (Windows)將網頁直接列印成 PDF 的功能，當字型為 標楷體(DFKai-SB) 時，會有破字的狀況。<br>而將 Chrome 退版後，這個功能就沒問題了。<br>但是在 Mac 上卻是沒問題的。</p><h3 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h3><p><a href="https://jsbin.com/lodutapuze/1/edit?html,output" target="_blank" rel="noopener">測試網址</a>，<br>可以發現在 Windows 10(有更新到新版本) Chrome 直接按下 Print ， Preview 就會看到字破破的狀況。<br><img src="/2019/10/04/2019030/001.png" title="DFKai-SB_font_broken"></p><p>於是同事填了 Chrome Bug 單，Chrome 也立即有了回應相關的解法方式。<br>This is due to switching from sfntly to HarfBuzz. (bug 931719) You can navigate to chrome://flags/#harfbuzz-pdf-subsetter and turn it off, and restart Chrome to quickly workaround this.</p><p>就是在 Chrome 網址列輸入 chrome://flags/#harfbuzz-pdf-subsetter<br>將原本 預設 改成 停用，再重開 Chrome 來測試就可以了哦!<br><img src="/2019/10/04/2019030/002.png" title="Default_2_Disabled"></p><p>詳細可以參考:<a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1010396&amp;q=&amp;colspec=ID%20Pri%20M%20Stars%20ReleaseBlock%20Component%20Status%20Owner%20Summary%20OS%20Modified" target="_blank" rel="noopener">Issue 1010396: chinese font-family DFKai-SB is broken for print</a></p><p>感謝同事 Garry 的分享 ^_^</p><h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><p><a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1010396&amp;q=&amp;colspec=ID%20Pri%20M%20Stars%20ReleaseBlock%20Component%20Status%20Owner%20Summary%20OS%20Modified" target="_blank" rel="noopener">Issue 1010396: chinese font-family DFKai-SB is broken for print</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;最近同事發現，原本透過 Chrome V77 (Windows)將網頁直接列印成 PDF 的功能，當字型為 標楷體(DFKai-SB) 時，
      
    
    </summary>
    
    
      <category term="Chrome" scheme="https://rainmakerho.github.io/tags/Chrome/"/>
    
      <category term="77" scheme="https://rainmakerho.github.io/tags/77/"/>
    
      <category term="font" scheme="https://rainmakerho.github.io/tags/font/"/>
    
      <category term="DFKai-SB" scheme="https://rainmakerho.github.io/tags/DFKai-SB/"/>
    
      <category term="PDF" scheme="https://rainmakerho.github.io/tags/PDF/"/>
    
      <category term="broken" scheme="https://rainmakerho.github.io/tags/broken/"/>
    
  </entry>
  
  <entry>
    <title>偵測到隱藏目錄 - AppScan</title>
    <link href="https://rainmakerho.github.io/2019/09/25/2019029/"/>
    <id>https://rainmakerho.github.io/2019/09/25/2019029/</id>
    <published>2019-09-25T02:48:11.000Z</published>
    <updated>2019-09-26T07:39:05.282Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>最近系統被 AppScan 掃出「偵測到隱藏目錄」的問題，在 IIS 上，如果目錄不存在，就會回 404 ，而如果目錄存在，又不允許瀏覽，就會回 403。 所以就可以透過回傳的狀態碼來判斷目錄的存在與否。 那要怎麼解決呢?</p><h3 id="研究與解法"><a href="#研究與解法" class="headerlink" title="研究與解法"></a>研究與解法</h3><p>先建立一個 IIS 的應用程式，裡面建立一個 admin 的目錄，並在 admin 目錄中，新增一個 hi.htm 的檔案，然後來測試。</p><p>如果目錄不存在，IIS 會回 404 ，例如在 Browser 上輸入 <a href="http://localhost/t/doc" target="_blank" rel="noopener">http://localhost/t/doc</a> 就會出 404 的錯誤，如下，</p><img src="/2019/09/25/2019029/001.png" title="folder_404"><p>如果目錄存在，就會回 403.14 Forbidden，例如在 Browser 上輸入 <a href="http://localhost/t/admin" target="_blank" rel="noopener">http://localhost/t/admin</a> 就會出現 403 的錯誤，如下，</p><img src="/2019/09/25/2019029/002.png" title="folder_403"><p>我們可以參考「<a href="https://stackoverflow.com/questions/18831024/configure-iis-to-return-404-for-directory-browse-attempts" target="_blank" rel="noopener">Configure IIS to return 404 for directory browse attempts</a>」中的幾種建議，</p><h4 id="設定-Request-Filtering-中的-Hidden-Segments"><a href="#設定-Request-Filtering-中的-Hidden-Segments" class="headerlink" title="設定 Request Filtering 中的 Hidden Segments"></a>設定 Request Filtering 中的 Hidden Segments</h4><p>情境:如果該目錄像 App_Code 這樣子的目錄，只是系統使用，Client 完全不能用，這樣子設定，如下，<br><img src="/2019/09/25/2019029/003.png" title="folder_RequestFiltering"><br>但如果您目錄中有頁面是要給 Client 使用的，就不能用這種方式哦!</p><h4 id="設定預設的-default-htm-，並設定檔案屬性為-Hidden"><a href="#設定預設的-default-htm-，並設定檔案屬性為-Hidden" class="headerlink" title="設定預設的 default.htm ，並設定檔案屬性為 Hidden"></a>設定預設的 default.htm ，並設定檔案屬性為 Hidden</h4><p>情境:如果您要卡的目錄只有一個，就還好，但如果目錄很多的話，就不建議這樣子做。<br><img src="/2019/09/25/2019029/004.png" title="folder_default_hidden"></p><h4 id="設定-web-config-的方式，將-403-導到-page-not-found-的頁面"><a href="#設定-web-config-的方式，將-403-導到-page-not-found-的頁面" class="headerlink" title="設定 web.config 的方式，將 403 導到 page not found 的頁面"></a>設定 web.config 的方式，將 403 導到 page not found 的頁面</h4><p>所以我們可以在應用程式目錄(t)下放一個 pagenotfound.htm ，當遇到 403.14 時，就導到那一頁去，如下，</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">system.webServer</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">httpErrors</span> <span class="attr">errorMode</span>=<span class="string">"Custom"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">remove</span> <span class="attr">statusCode</span>=<span class="string">"404"</span> <span class="attr">subStatusCode</span>=<span class="string">"-1"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">error</span> <span class="attr">statusCode</span>=<span class="string">"403"</span> <span class="attr">subStatusCode</span>=<span class="string">"14"</span> <span class="attr">path</span>=<span class="string">"/t/pagenotfound.htm"</span> <span class="attr">responseMode</span>=<span class="string">"Redirect"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">error</span> <span class="attr">statusCode</span>=<span class="string">"404"</span> <span class="attr">subStatusCode</span>=<span class="string">"-1"</span> <span class="attr">path</span>=<span class="string">"/t/pagenotfound.htm"</span> <span class="attr">responseMode</span>=<span class="string">"Redirect"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">httpErrors</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">system.webServer</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><p>當然，原本的 404 也是要到一樣的頁面去，才不會讓 403 與 404 有區別，所以當我在 browser 輸入 <a href="http://localhost/t/doc" target="_blank" rel="noopener">http://localhost/t/doc</a> 及 <a href="http://localhost/t/admin" target="_blank" rel="noopener">http://localhost/t/admin</a> 都會被導到 /t/pagenotfound.htm ，如下圖，</p><img src="/2019/09/25/2019029/005.png" title="status_403_14_404"><p>但是眼尖的朋友會可以發現，為什麼打 /doc 跟 /admin 它的網路錄下來不一樣呢?<br>輸入 /doc 時，會連到 /doc (302) =&gt; /t/pagenotfound.htm (200) ，<br>輸入 /admin 時，會連到 /admin (301) /admin/ (302) =&gt; /t/pagenotfound.htm (200) ，<br>但是如果輸入 /admin/ 時，行為就會跟 /doc 一樣， /admin/ (302) =&gt; /t/pagenotfound.htm (200) 。</p><p>為什麼會這樣子呢? 這個是「<a href="https://support.microsoft.com/en-us/help/298408/iis-generates-courtesy-redirect-when-folder-without-trailing-slash-is" target="_blank" rel="noopener">courtesy redirect</a>」，就是說，如果你在網址後面不是 <strong>/</strong> 結尾的話，它會檢查 目錄 是否存在，如果存在的話，就會回 301 請 Browser 去連結尾有 <strong>/</strong> 的網址，這也就是為什麼如果目錄真的存在，輸入 /admin 會多一個 301 。</p><p>如果要避免這個問題，就需要「停用預設網頁」功能 (<defaultdocument enabled="false">)，加了這個後，就不會輸入 /doc, /admin, /admin/ 就會是一樣的行為。(<strong>請注意:這樣預設網頁就無法使用了哦!</strong>)</defaultdocument></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;configuration&gt;</span><br><span class="line">  &lt;system.webServer&gt;</span><br><span class="line">    &lt;httpErrors errorMode=&quot;Custom&quot;&gt;</span><br><span class="line">      &lt;remove statusCode=&quot;404&quot; subStatusCode=&quot;-1&quot; /&gt;</span><br><span class="line">      &lt;error statusCode=&quot;403&quot; subStatusCode=&quot;14&quot; path=&quot;/t/pagenotfound.htm&quot; responseMode=&quot;Redirect&quot; /&gt;</span><br><span class="line">      &lt;error statusCode=&quot;404&quot; subStatusCode=&quot;-1&quot; path=&quot;/t/pagenotfound.htm&quot; responseMode=&quot;Redirect&quot; /&gt;</span><br><span class="line">    &lt;/httpErrors&gt;</span><br><span class="line">    &lt;defaultDocument enabled=&quot;false&quot; /&gt;</span><br><span class="line">  &lt;/system.webServer&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure><h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><p><a href="https://stackoverflow.com/questions/18831024/configure-iis-to-return-404-for-directory-browse-attempts" target="_blank" rel="noopener">Configure IIS to return 404 for directory browse attempts</a><br><a href="https://www.troyhunt.com/solving-tyranny-of-http-403-responses/" target="_blank" rel="noopener">Solving the tyranny of HTTP 403 responses to directory browsing in ASP.NET</a><br><a href="https://shunnien.github.io/2017/06/01/webconfig-httpErros-and-customErrors/" target="_blank" rel="noopener">HttpErros 與 CustomErrors 的自訂導向</a><br><a href="https://stackoverflow.com/questions/25579048/cant-change-iis-response-code-with-url-rewrite-outbound-rule" target="_blank" rel="noopener">Can’t change IIS response code with URL Rewrite outbound rule</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;最近系統被 AppScan 掃出「偵測到隱藏目錄」的問題，在 IIS 上，如果目錄不存在，就會回 404 ，而如果目錄存在，又不允許瀏覽，就
      
    
    </summary>
    
    
      <category term="IIS" scheme="https://rainmakerho.github.io/tags/IIS/"/>
    
      <category term="403" scheme="https://rainmakerho.github.io/tags/403/"/>
    
      <category term="AppScan" scheme="https://rainmakerho.github.io/tags/AppScan/"/>
    
      <category term="偵測到隱藏目錄" scheme="https://rainmakerho.github.io/tags/%E5%81%B5%E6%B8%AC%E5%88%B0%E9%9A%B1%E8%97%8F%E7%9B%AE%E9%8C%84/"/>
    
      <category term="Forbidden" scheme="https://rainmakerho.github.io/tags/Forbidden/"/>
    
  </entry>
  
  <entry>
    <title>Microsoft Botframework V4，從 Bot 送訊息到 IM Channel 時，加入額外的 Header 資訊 (V2)</title>
    <link href="https://rainmakerho.github.io/2019/09/24/2019028/"/>
    <id>https://rainmakerho.github.io/2019/09/24/2019028/</id>
    <published>2019-09-24T07:29:00.000Z</published>
    <updated>2019-09-24T09:43:42.447Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>在年初時，因為 Bot 送給 IM Channel 時，需要在 HttpClient 的 Headers 中加入額外的資訊，那時筆者是透過 Middleware 的方式，取出 turnContext.TurnState 中的 ConnectorClient 。然後設定 ConnectorClient.HttpClient 的 DefaultRequestHeaders 。詳細可以參考 <a href="https://rainmakerho.github.io/2019/01/02/2019001/">Microsoft Botframework V4，從 Bot 送訊息到 IM Channel 時，加入額外的 Header 資訊</a></p><p>最近 Bot 有時會噴以下的錯誤，<br><strong><br>System.InvalidOperationException: Operations that change non-concurrent collections must have exclusive access. A concurrent update was performed on this collection and corrupted its state. The collection’s state is no longer correct.<br>at System.Collections.Generic.Dictionary`2.FindEntry(TKey key)<br>at System.Collections.Generic.Dictionary2.TryGetValue(TKey key, TValue&amp; value)<br>at System.Net.Http.Headers.HttpHeaders.ContainsParsedValue(HeaderDescriptor descriptor, Object value)<br>at System.Net.Http.Headers.HttpHeaderValueCollection1.get_IsSpecialValueSet() at System.Net.Http.Headers.HttpRequestHeaders.get_ExpectContinue() at</strong><br>或是<br><strong><br>System.NullReferenceException: Object reference not set to an instance of an object.<br>at System.Collections.Generic.Dictionary`2.FindEntry(TKey key) at System.Collections.Generic.Dictionary`2.TryGetValue(TKey key, TValue&amp; value)<br>at System.Net.Http.Headers.HttpHeaders.GetOrCreateHeaderInfo(HeaderDescriptor descriptor, Boolean parseRawValues)<br>at System.Net.Http.headers.HttpHeaders.TryAddWithoutValidation(HeaderDescriptor descriptor, String value)</strong></p><h3 id="研究"><a href="#研究" class="headerlink" title="研究"></a>研究</h3><p>網路上討論，大約是因為 Multi Thread 去 Access Dictionary 物件所引發的錯誤。<br>因為 System.Collections.Generic.Dictionary 它並不是 Thread Safe 的物件，所以在 Multi Threads 下，有可能會造成錯誤。</p><p>所以回過頭來看一下， 原本 Middleware 的部份，它是在系統一啟動時，就建立的，所以在多人使用時，的確會在 Multi Threads 的環境下，</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">services.AddBot&lt;EmptyBotBot&gt;(options =&gt;</span><br><span class="line">&#123;</span><br><span class="line">  //... other code</span><br><span class="line">  //add middleware</span><br><span class="line">  options.Middleware.Add(new GssAdapterMiddleware());</span><br><span class="line">  // ...</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>所以，我們不能在 Middleware 中去操作 ConnectorClient.HttpClient 的 Headers ，除非加上 Lock 。<br>那 ConnectorClient.HttpClient 是從那裡來的呢?<br>其實它是取自 BotFrameworkAdapter 中的 _httpClient ，在 BotFrameworkAdapter 的 CreateConnectorClient Method 建立 ConnectorClient 時，將 _httpClient 給進 ConnectorClient 的建構子，詳細可以參考 Git <a href="https://github.com/microsoft/botbuilder-dotnet/blob/4.5/libraries/Microsoft.Bot.Builder/BotFrameworkAdapter.cs#L918" target="_blank" rel="noopener">BotFrameworkAdapter.cs</a></p><p>那 BotFrameworkAdapter 中的 _httpClient 又是從那裡來的呢? 如果沒有設定的話，它就拿 _defaultHttpClient (private static readonly HttpClient _defaultHttpClient = new HttpClient();) 來用。</p><p>那我們要如何建立 HttpClient 給 BotFrameworkAdapter 用呢? 其實它是取自 BotframeworkOptions 的 HttpClient 的屬性值，詳細可以參考 Git <a href="https://github.com/microsoft/botbuilder-dotnet/blob/4.5/libraries/integration/Microsoft.Bot.Builder.Integration.AspNet.Core/ServiceCollectionExtensions.cs#L170" target="_blank" rel="noopener">ServiceCollectionExtensions.cs</a></p><h3 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h3><p>所以，原本為了加 Header 的 Middleware 可以不需要了(不然在操作時，需要 lock )，直接建立帶有我們需要 Header 的 HttpClient 物件就可以了。<br>所以程式調整如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">services.AddBot&lt;EmptyBotBot&gt;(options =&gt;</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">//... other code</span></span><br><span class="line">  <span class="comment">//add middleware (不用 Middleware 來加 HttpClient 的 Header)</span></span><br><span class="line">  <span class="comment">//options.Middleware.Add(new GssAdapterMiddleware());</span></span><br><span class="line">  <span class="comment">//先建立我們需要的 HttpClient</span></span><br><span class="line">  <span class="keyword">var</span> authKey = <span class="string">"X-RM"</span>;</span><br><span class="line">  <span class="keyword">var</span> accessToken = <span class="string">"rainmaker_ho"</span>;</span><br><span class="line">  <span class="keyword">var</span> client = <span class="keyword">new</span> HttpClient();</span><br><span class="line">  client.DefaultRequestHeaders</span><br><span class="line">    .TryAddWithoutValidation(authKey, accessToken);</span><br><span class="line">  <span class="comment">//傳給 options.HttpClient ，它會 Pass 給 BotFrameworkAdapter</span></span><br><span class="line">  options.HttpClient = client;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><img src="/2019/09/24/2019028/001.png" title="customHttpClient"><p>透過 ngrok 來看 Bot 送到 IM Channel (POST /v3/conversations/…) 都會有我們需要的 Header 。</p><img src="/2019/09/24/2019028/002.png" title="Bot->IM"><h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><p><a href="https://github.com/dotnet/corefx/issues/31186" target="_blank" rel="noopener">[Info] InvalidOperationException: Operations that change non-concurrent collections must have exclusive access. A concurrent update was performed on this collection and corrupted its state. The collection’s state is no longer correct</a></p><p><a href="https://rainmakerho.github.io/2019/01/02/2019001/">Microsoft Botframework V4，從 Bot 送訊息到 IM Channel 時，加入額外的 Header 資訊</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;在年初時，因為 Bot 送給 IM Channel 時，需要在 HttpClient 的 Headers 中加入額外的資訊，那時筆者是透過 
      
    
    </summary>
    
    
      <category term="bfv4" scheme="https://rainmakerho.github.io/tags/bfv4/"/>
    
      <category term="HttpClient" scheme="https://rainmakerho.github.io/tags/HttpClient/"/>
    
      <category term="customHttpClient" scheme="https://rainmakerho.github.io/tags/customHttpClient/"/>
    
  </entry>
  
  <entry>
    <title>透過 Aspose.Pdf.Document 載入 Html 檔案轉成 Pdf 檔，有些字會變成空白框框</title>
    <link href="https://rainmakerho.github.io/2019/09/23/2019027/"/>
    <id>https://rainmakerho.github.io/2019/09/23/2019027/</id>
    <published>2019-09-23T02:07:08.000Z</published>
    <updated>2019-09-24T03:12:16.519Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>我們手上有一個 big5 編碼的 Html 檔案，想透過 Aspose 來轉換成 Pdf 檔案，看似容易，但在轉出來的 Pdf 中，竟然有一些字會變成「空白的框框」。一件簡單的工作，怎麼會踩到了雷呢?</p><p>首先，透過 Aspose 將 Html 檔轉換成 Pdf 檔案在 Aspose 有 2 種做法，如下，</p><ol><li>透過 Aspose.HTML 來轉，請參考:<a href="https://docs.aspose.com/display/htmlnet/HTML+to+PDF+Conversion" target="_blank" rel="noopener">Aspose.HTML HTML to PDF Conversion</a></li></ol><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Source HTML document</span></span><br><span class="line"><span class="keyword">var</span> htmlDocument = <span class="keyword">new</span> HTMLDocument(<span class="string">"input.html"</span>);</span><br><span class="line"><span class="comment">// Initialize PdfSaveOptions</span></span><br><span class="line">PdfSaveOptions options = <span class="keyword">new</span> PdfSaveOptions</span><br><span class="line">&#123;</span><br><span class="line">    JpegQuality = <span class="number">100</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// Output file path</span></span><br><span class="line"><span class="keyword">string</span> outputPDF = <span class="string">"HTMLtoPDF_Output.pdf"</span>;</span><br><span class="line"><span class="comment">// Convert HTML to PDF</span></span><br><span class="line">Converter.ConvertHTML(htmlDocument, options, outputPDF);</span><br></pre></td></tr></table></figure><ol start="2"><li>透過 Aspose.Pdf 來轉，請參考:<a href="https://docs.aspose.com/display/pdfnet/Convert+a+File+to+PDF+Format" target="_blank" rel="noopener">Aspose.Pdf Convert a File to PDF Format</a></li></ol><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> options = <span class="keyword">new</span> HtmlLoadOptions();</span><br><span class="line"><span class="comment">//會自已判斷檔案的編碼(big5/utf8)，所以不用特別指定 encoding</span></span><br><span class="line">Document pdfDocument = <span class="keyword">new</span> Document(<span class="string">"input.html"</span>, options);</span><br><span class="line">pdfDocument.Save(<span class="string">"HTMLtoPDF_Output.pdf"</span>);</span><br></pre></td></tr></table></figure><p>而我們剛開始是使用第 2 種方式，透過 Aspose.Pdf 來轉換，因為檔案是 big5 ，所以多設定 HtmlLoadOptions 的 InputEncoding 屬性為 big5 (可以不用設定，因為它會自動偵測)。<br>結果有些字出來卻會變成一個空白的框框。如下，「查」這個字，變成了空白的框框<br><img src="/2019/09/23/2019027/001.png" title="Aspose.Pdf_WhiteBox"><br>測試的 Html 內容如下，</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>FC21900000-102/06/18 10:54:19<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=big5"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">查詢查日期</span><br><span class="line"><span class="tag">&lt;<span class="name">hr</span> /&gt;</span></span><br><span class="line">查詢日期: 102/06/18 10:54:19 一、個</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="研究"><a href="#研究" class="headerlink" title="研究"></a>研究</h3><p>即然透過 Aspose.Pdf 有問題，就改用第 1 種方式，透過 Aspose.HTML 來轉，結果這次變成「全型標點符號」會變成空白的框框，例如，一、個人 的「、」會變成空白的框框<br><img src="/2019/09/23/2019027/002.jpg" title="Aspose.HTML_WhiteBox"></p><p>2 種方式都無法正常將 Html 轉成 Pdf 檔，判斷應該是字型的問題，是否可以在載入後去調整它的字型然後再存檔呢?<br>所以筆者參考<a href="https://docs.aspose.com/display/pdfnet/Replace+Text+in+a+PDF+Document" target="_blank" rel="noopener">Replace fonts in existing PDF file</a> 透過 TextFragmentAbsorber 取出文件中所有的 TextFragment ，先看一下有問題的文字，它們的字型是什麼呢?</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> absorber = <span class="keyword">new</span> TextFragmentAbsorber(<span class="keyword">new</span> TextEditOptions(TextEditOptions.FontReplace.RemoveUnusedFonts));</span><br><span class="line">pdfDocument.Pages.Accept(absorber);</span><br><span class="line"><span class="keyword">foreach</span> (TextFragment textFragment <span class="keyword">in</span> absorber.TextFragments)</span><br><span class="line">&#123;</span><br><span class="line">    Console.WriteLine(<span class="string">"&#123;0&#125;:&#123;1&#125;"</span>, textFragment.Text, textFragment.TextState.Font.FontName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>結果輸出如下，</p><p><strong><br>詢 日期:MSGothic<br>詢日期:MSGothic<br>::TimesNewRoman<br>102/06/18:TimesNewRoman<br>10:54:19:TimesNewRoman<br>一、個:MSGothic</strong></p><p>可以發現，「查」這個字不見了，而且它的字型為 MSGothic 。<br>如果我們將 Html 多加字型設定進去(font face=”細明體”)，如下，</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">HTML</span>&gt;</span><span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">title</span>&gt;</span>FC21900000-102/06/18 10:54:19<span class="tag">&lt;/<span class="name">title</span>&gt;</span><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=big5"</span> /&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">BODY</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">basefont=4</span> <span class="attr">font</span> <span class="attr">FACE</span>=<span class="string">"細明體"</span> <span class="attr">LANG</span>=<span class="string">"ZH-TW"</span>&gt;</span><span class="tag">&lt;<span class="name">font</span> <span class="attr">face</span>=<span class="string">"細明體"</span>&gt;</span><span class="tag">&lt;<span class="name">pre</span>&gt;</span></span><br><span class="line">查詢查日期</span><br><span class="line"><span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">查詢日期: 102/06/18 10:54:19</span><br><span class="line">一、個</span><br><span class="line"><span class="tag">&lt;/<span class="name">pre</span>&gt;</span><span class="tag">&lt;/<span class="name">font</span>&gt;</span><span class="tag">&lt;/<span class="name">basefont</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">BODY</span>&gt;</span><span class="tag">&lt;/<span class="name">HTML</span>&gt;</span></span><br></pre></td></tr></table></figure><p>它的輸出就是正常的，各句子的字型如下，<br><strong><br>查詢查日期:DFKai-SB<br>查詢日期:DFKai-SB<br>::CourierNew<br>102/06/18:CourierNew<br>10:54:19:CourierNew<br>一:DFKai-SB<br>、:MSGothic<br>個:DFKai-SB</strong></p><p>但是如果將一樣的程式拿到 Windows Server 上測試，它的結果就會變成跟沒設定字型類似，如下，<br><strong><br>詢 日期:MSGothic<br>詢日期:MSGothic<br>::CourierNew<br>102/06/18:CourierNew<br>10:54:19:CourierNew<br>一:MSGothic<br>、:MSGothic<br>個:MSGothic</strong></p><p>所以「查」這個字，在 Windows Server 上又變成了一個空白的框框了。<br>怎麼辦呢? 那把 MSGothic 字型改成 DFKai-SB 字型可以嗎? 所以我們再加入置換字型的程式碼，如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> absorber = <span class="keyword">new</span> TextFragmentAbsorber(<span class="keyword">new</span> TextEditOptions(TextEditOptions.FontReplace.RemoveUnusedFonts));</span><br><span class="line">pdfDocument.Pages.Accept(absorber);</span><br><span class="line"><span class="keyword">foreach</span> (TextFragment textFragment <span class="keyword">in</span> absorber.TextFragments)</span><br><span class="line">&#123;</span><br><span class="line">    Console.WriteLine(<span class="string">"&#123;0&#125;:&#123;1&#125;"</span>, textFragment.Text, textFragment.TextState.Font.FontName);</span><br><span class="line">    <span class="keyword">if</span> (textFragment.TextState.Font.FontName == <span class="string">"MSGothic"</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        textFragment.TextState.Font = FontRepository.FindFont(<span class="string">"DFKai-SB"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>… 結果，Pdf 中「查」這個字，直接變成空白 Q_Q</p><p>顯然從 Html 載入到 Pdf 檔時，字型如果沒設定好，到後面應該就沒機會去改它了。<br>為了驗證假設是否正確，我們可以動態加入一段 Html 到 Pdf.Document 之中，如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> options = <span class="keyword">new</span> HtmlLoadOptions();</span><br><span class="line"><span class="comment">//會自已判斷檔案的編碼(big5/utf8)，所以不用特別指定 encoding</span></span><br><span class="line">Document pdfDocument = <span class="keyword">new</span> Document(<span class="string">"input.html"</span>, options);</span><br><span class="line"><span class="keyword">var</span> html = <span class="keyword">new</span> HtmlFragment(<span class="string">"查詢查日期"</span>)</span><br><span class="line">&#123;</span><br><span class="line">    TextState = <span class="keyword">new</span> TextState</span><br><span class="line">    &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line">pdfDocument.Pages[<span class="number">1</span>].Paragraphs.Add(html);</span><br><span class="line">pdfDocument.Save(<span class="string">"HTMLtoPDF_Output.pdf"</span>);</span><br></pre></td></tr></table></figure><p>結果「查」這個字果然也變成了空白框框，如下圖，<br><img src="/2019/09/23/2019027/003.png" title="HtmlFragment.HTML_WhiteBox"></p><p>這時，如果我們在 new HtmlFragment 時，設定 TextState 的字型，「查」這個字就可以順利顯示出來，如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> options = <span class="keyword">new</span> HtmlLoadOptions();</span><br><span class="line"><span class="comment">//會自已判斷檔案的編碼(big5/utf8)，所以不用特別指定 encoding</span></span><br><span class="line">Document pdfDocument = <span class="keyword">new</span> Document(<span class="string">"input.html"</span>, options);</span><br><span class="line"><span class="keyword">var</span> html = <span class="keyword">new</span> HtmlFragment(<span class="string">"查詢查日期"</span>)</span><br><span class="line">&#123;</span><br><span class="line">    TextState = <span class="keyword">new</span> TextState</span><br><span class="line">    &#123;</span><br><span class="line">        Font = FontRepository.FindFont(<span class="string">"DFKai-SB"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">pdfDocument.Pages[<span class="number">1</span>].Paragraphs.Add(html);</span><br><span class="line">pdfDocument.Save(<span class="string">"HTMLtoPDF_Output.pdf"</span>);</span><br></pre></td></tr></table></figure><img src="/2019/09/23/2019027/004.png" title="HtmlFragment.TextState.Font"><p>果然在載入到 Pdf.Document 時，就要給定預設的字型，但 HtmlLoadOptions 並沒有預設字型的屬性，怎麼辦呢?</p><h3 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h3><p>HtmlLoadOptions 目前並沒有預設字型的屬性，但 HtmlFragment 有，所以目前只好從 HtmlFragment 著手，也就是自已載入 Html 內容，然後再加入 Pdf.Document 之中。<br>所以目前暫時解法如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> htmlFile = <span class="string">@"input.html"</span>;</span><br><span class="line"><span class="keyword">var</span> htmlContents = File.ReadAllText(htmlFile, System.Text.Encoding.GetEncoding(<span class="number">950</span>));</span><br><span class="line"><span class="comment">//chang charset from big5 to utf8</span></span><br><span class="line">htmlContents = htmlContents.Replace(<span class="string">"big5"</span>, <span class="string">"utf8"</span>);</span><br><span class="line"><span class="keyword">var</span> pdf = <span class="keyword">new</span> Aspose.Pdf.Document();</span><br><span class="line"><span class="keyword">var</span> page = pdf.Pages.Add();</span><br><span class="line">page.PageInfo.Height = Aspose.Pdf.PageSize.A4.Height;</span><br><span class="line">page.PageInfo.Width = Aspose.Pdf.PageSize.A4.Width;</span><br><span class="line">page.PageInfo.Margin.Left = <span class="number">5</span>;</span><br><span class="line">page.PageInfo.Margin.Right = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">var</span> html = <span class="keyword">new</span> HtmlFragment(htmlContents)</span><br><span class="line">&#123;</span><br><span class="line">    TextState = <span class="keyword">new</span> TextState</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//you can change your default font</span></span><br><span class="line">        Font = FontRepository.FindFont(<span class="string">"DFKai-SB"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">page.Paragraphs.Add(html);</span><br><span class="line">pdf.Save(<span class="string">"HTMLtoPDF_Output.pdf"</span>);</span><br></pre></td></tr></table></figure><p>產出的內容如下，<br><img src="/2019/09/23/2019027/005.png" title="HtmlFragment.TextState.Font.OK"></p><p>因為 HtmlLoadOptions 目前並沒有預設字型的屬性，所以針對這問題，原廠有建立一個問題單，未來更方便的解法，再跟大家 Update 。</p><h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><p><a href="https://docs.aspose.com/display/htmlnet/HTML+to+PDF+Conversion" target="_blank" rel="noopener">Aspose.HTML HTML to PDF Conversion</a><br><a href="https://docs.aspose.com/display/pdfnet/Convert+a+File+to+PDF+Format" target="_blank" rel="noopener">Aspose.Pdf Convert a File to PDF Format</a><br><a href="https://dev.to/andruhovski/how-to-render-html-to-pdf-document-using-asposehtml-for-net-1g5j" target="_blank" rel="noopener">How to render HTML to PDF document using Aspose.HTML for .NET</a><br><a href="https://forum.aspose.com/t/aspose-pdf-document-big5-html-pdf/202582" target="_blank" rel="noopener">Aspose.Pdf.Document 載入 Big5 Html 檔，存成 PDF 時，有些字會變成一個空的框框</a><br><a href="https://docs.aspose.com/display/pdfnet/Replace+Text+in+a+PDF+Document" target="_blank" rel="noopener">Replace fonts in existing PDF file</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;我們手上有一個 big5 編碼的 Html 檔案，想透過 Aspose 來轉換成 Pdf 檔案，看似容易，但在轉出來的 Pdf 中，竟然有一
      
    
    </summary>
    
    
      <category term="Html" scheme="https://rainmakerho.github.io/tags/Html/"/>
    
      <category term="Aspose.Pdf.Document" scheme="https://rainmakerho.github.io/tags/Aspose-Pdf-Document/"/>
    
      <category term="Pdf" scheme="https://rainmakerho.github.io/tags/Pdf/"/>
    
      <category term="空白框框" scheme="https://rainmakerho.github.io/tags/%E7%A9%BA%E7%99%BD%E6%A1%86%E6%A1%86/"/>
    
      <category term="characters are missing" scheme="https://rainmakerho.github.io/tags/characters-are-missing/"/>
    
      <category term="charset" scheme="https://rainmakerho.github.io/tags/charset/"/>
    
      <category term="big5" scheme="https://rainmakerho.github.io/tags/big5/"/>
    
      <category term="FontRepository" scheme="https://rainmakerho.github.io/tags/FontRepository/"/>
    
      <category term="MSGothic" scheme="https://rainmakerho.github.io/tags/MSGothic/"/>
    
  </entry>
  
  <entry>
    <title>為什麼 aspnet_client 目錄中的檔案都無法下載，Status 為 401</title>
    <link href="https://rainmakerho.github.io/2019/09/17/2019026/"/>
    <id>https://rainmakerho.github.io/2019/09/17/2019026/</id>
    <published>2019-09-17T05:52:25.000Z</published>
    <updated>2019-09-17T06:14:53.786Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>最近同事詢問，系統 Link 到 aspnet_client 中的 js 檔案時，都無法下載，出現 401 Unauthorized 。<br>同事確認「匿名驗證」也有啟用，怎麼還會噴 401 呢?</p><h3 id="研究與解決"><a href="#研究與解決" class="headerlink" title="研究與解決"></a>研究與解決</h3><p>連到本機直接瀏覽那個檔案，錯誤內容為「401.3 - Unauthorized」，詳細資料為「因為網頁伺服器上此資源的存取控制清單 (ACL) 設定或加密設定的緣故，您沒有檢視此目錄或網頁的權限。」。</p><p>看來應該跟目錄的安全性有關係，於是再看一下它的根目錄所在路徑，發現它並不是預設的位置(c:\interpub\wwwroot)。<br>所以我先將 IIS 根目錄改回預設的 c:\interpub\wwwroot ，然後再用 Browser 瀏覽 aspnet_client 中的隨便一個 js ，它是會下載的。<br>於是跟預設的跟目錄安全性比對一下發現，目前的這個根目錄下的 aspnet_client 目錄，少了 Everyone 這個使用者。<br>於是在一樣的目錄安全性中加入 Everyone ，並授與 Read 的權限，再試看看就可以了哦!</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;最近同事詢問，系統 Link 到 aspnet_client 中的 js 檔案時，都無法下載，出現 401 Unauthorized 。&lt;b
      
    
    </summary>
    
    
      <category term="iis" scheme="https://rainmakerho.github.io/tags/iis/"/>
    
      <category term="aspnet_client" scheme="https://rainmakerho.github.io/tags/aspnet-client/"/>
    
      <category term="Unauthorized" scheme="https://rainmakerho.github.io/tags/Unauthorized/"/>
    
  </entry>
  
  <entry>
    <title>.NET Core AD 帳密驗證</title>
    <link href="https://rainmakerho.github.io/2019/09/17/2019025/"/>
    <id>https://rainmakerho.github.io/2019/09/17/2019025/</id>
    <published>2019-09-17T03:17:17.000Z</published>
    <updated>2019-09-17T03:55:25.834Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>目前 .NET Core 的 System.DirectoryServices.Protocols 還不 Support 非 Windows 平台。<br>所以如果在 Mac 中使用的話，就會噴「System.PlatformNotSupportedException」這個錯誤，如下，</p><p>System.PlatformNotSupportedException: System.DirectoryServices.Protocols is not supported on this platform.<br>at System.DirectoryServices.Protocols.DirectoryIdentifier..ctor()<br>at System.DirectoryServices.Protocols.LdapDirectoryIdentifier..ctor(String server, Int32 portNumber)</p><h3 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h3><h4 id="改用-Novell-Directory-Ldap-NETStandard"><a href="#改用-Novell-Directory-Ldap-NETStandard" class="headerlink" title="改用 Novell.Directory.Ldap.NETStandard"></a>改用 Novell.Directory.Ldap.NETStandard</h4><p>所以如果要真的跨平台的話，可以使用 <a href="https://github.com/dsbenghe/Novell.Directory.Ldap.NETStandard" target="_blank" rel="noopener">Novell.Directory.Ldap.NETStandard</a> 從 Nuget 加入套件。<br>使用上也很方便，可以參考 <a href="https://nicolas.guelpa.me/blog/2017/02/15/dotnet-core-ldap-authentication.html" target="_blank" rel="noopener">.NET Core LDAP authentication</a> 這篇的說明來實作即可。</p><p>而目前我的需求只有簡單的給使用者及密碼來驗證是否正確，如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//using Novell.Directory.Ldap;</span></span><br><span class="line"><span class="comment">//ldapServer，不知道的話，可以先用 Active Directory Explorer 來查看</span></span><br><span class="line"><span class="keyword">var</span> ldapServer = <span class="string">@"yourldapserver.com.tw"</span>;</span><br><span class="line"><span class="comment"><span class="doctag">///</span>/LDAP SSL (TCP 636) and LDAP GC SSL (TCP 3269)</span></span><br><span class="line"><span class="keyword">var</span> ldapConn = <span class="keyword">new</span> LdapConnection() &#123; SecureSocketLayer = <span class="literal">true</span> &#125;;</span><br><span class="line"><span class="keyword">try</span></span><br><span class="line">&#123;</span><br><span class="line">    ldapConn.Connect(ldapServer, LdapConnection.DEFAULT_SSL_PORT);</span><br><span class="line">    <span class="comment">//可以使用 DN or 含domain User</span></span><br><span class="line">    <span class="keyword">var</span> dnUser = <span class="string">@"CN=rainmaker_ho,OU=EMP,OU=RM,DC=rm,DC=com,DC=tw"</span>;</span><br><span class="line">    <span class="keyword">var</span> domainUser = <span class="string">"rainmaker_ho@rm.com.tw"</span>;</span><br><span class="line">    <span class="keyword">var</span> domainUser2 = <span class="string">@"rm_domain\rainmaker_ho"</span>;</span><br><span class="line">    <span class="keyword">var</span> userpassword = <span class="string">"rm'sppwwdd"</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">string</span>.IsNullOrEmpty(userpassword))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"密碼不能為空值!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//DN 驗證</span></span><br><span class="line">    ldapConn.Bind(dnUser, userpassword);</span><br><span class="line">    <span class="comment">//user@domain 驗證</span></span><br><span class="line">    <span class="comment">//ldapConn.Bind(domainUser, userpassword);</span></span><br><span class="line">    <span class="comment">//domain\user 驗證</span></span><br><span class="line">    <span class="comment">//ldapConn.Bind(domainUser2, userpassword);</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (Exception ex)</span><br><span class="line">&#123;</span><br><span class="line">    Console.WriteLine(ex.ToString());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> authDN = ldapConn.AuthenticationDN;</span><br><span class="line"><span class="comment">// 如果 ldapConn.AuthenticationDN 的值不為空，就表示有驗證過</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">string</span>.IsNullOrEmpty(authDN))</span><br><span class="line">&#123;</span><br><span class="line">    Console.WriteLine(<span class="string">"驗證錯誤"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    Console.WriteLine(<span class="string">$"驗證成功:<span class="subst">&#123;authDN&#125;</span>"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><p><a href="https://github.com/dsbenghe/Novell.Directory.Ldap.NETStandard" target="_blank" rel="noopener">Novell.Directory.Ldap.NETStandard</a><br><a href="https://nicolas.guelpa.me/blog/2017/02/15/dotnet-core-ldap-authentication.html" target="_blank" rel="noopener">.NET Core LDAP authentication</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;目前 .NET Core 的 System.DirectoryServices.Protocols 還不 Support 非 Windows
      
    
    </summary>
    
    
      <category term=".NET Core" scheme="https://rainmakerho.github.io/tags/NET-Core/"/>
    
      <category term="AD" scheme="https://rainmakerho.github.io/tags/AD/"/>
    
      <category term="Authentication" scheme="https://rainmakerho.github.io/tags/Authentication/"/>
    
      <category term="LDAP" scheme="https://rainmakerho.github.io/tags/LDAP/"/>
    
      <category term="Novell.Directory.Ldap.NETStandard" scheme="https://rainmakerho.github.io/tags/Novell-Directory-Ldap-NETStandard/"/>
    
  </entry>
  
  <entry>
    <title>IE 不支援文化特性。參數名稱：name zh-Hant-TW 是無效的文化特性識別項。</title>
    <link href="https://rainmakerho.github.io/2019/09/17/2019024/"/>
    <id>https://rainmakerho.github.io/2019/09/17/2019024/</id>
    <published>2019-09-17T01:32:14.000Z</published>
    <updated>2019-09-17T01:44:02.663Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>最近公司的系統使用 Windows 10, IE 時，出現了以下的錯誤訊息<br><strong>不支援文化特性。<br>參數名稱：name<br>zh-Hant-TW 是無效的文化特性識別項。</strong></p><h3 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h3><p>在 Windows 8 時，可以參考「<a href="https://dotblogs.com.tw/rainmaker/2012/10/21/78733" target="_blank" rel="noopener">[IE]zh-Hant-TW 是無效的文化特性識別項。</a>」這篇的設定，但是到了 Windows 10 ，設定不知跑到了那裡去了。<br>後來同事 JN 有找到，分享出來，而其他同事也有在詢問，所以就一併分享給大家，如下圖，<br><img src="/2019/09/17/2019024/ie10_lange.jpg" title="win10語言設定"><br>設定-&gt;首頁-&gt;隱私權-&gt;一般 ，在右邊有一個「透過讓網站存取我的語言清單以提供當地相關內容」，將它關閉即可。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;最近公司的系統使用 Windows 10, IE 時，出現了以下的錯誤訊息&lt;br&gt;&lt;strong&gt;不支援文化特性。&lt;br&gt;參數名稱：name
      
    
    </summary>
    
    
      <category term="windows 10" scheme="https://rainmakerho.github.io/tags/windows-10/"/>
    
      <category term="ie" scheme="https://rainmakerho.github.io/tags/ie/"/>
    
      <category term="不支援文化特性" scheme="https://rainmakerho.github.io/tags/%E4%B8%8D%E6%94%AF%E6%8F%B4%E6%96%87%E5%8C%96%E7%89%B9%E6%80%A7/"/>
    
  </entry>
  
  <entry>
    <title>Node JS + IIS Node 效能問題</title>
    <link href="https://rainmakerho.github.io/2019/09/05/2019023/"/>
    <id>https://rainmakerho.github.io/2019/09/05/2019023/</id>
    <published>2019-09-05T05:28:57.000Z</published>
    <updated>2019-09-05T06:40:11.922Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>我們有一個系統是使用 NodeJS ，同事 Stan 使用 PuppeteerSharp 同時起多個 Chrome 來測試它。<br>結果一下子 IIS Node 就沒反應了，一整個 Hang 住。</p><h3 id="研究"><a href="#研究" class="headerlink" title="研究"></a>研究</h3><p>想說怎麼跑個沒幾次就掛了呢? 結果發現我們有一段程式，在呼叫 API 時，會等 API 回來，再回給 Client 。例如，</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"><span class="keyword">const</span> &#123; promisify &#125; = <span class="built_in">require</span>(<span class="string">'util'</span>);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, <span class="keyword">async</span> <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line"><span class="keyword">await</span> init();</span><br><span class="line">res.send(<span class="string">`1:<span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">Date</span>()&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>, <span class="string">'127.0.0.1'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="built_in">console</span>.log(</span><br><span class="line"><span class="string">`Server running at http://<span class="subst">$&#123;<span class="keyword">this</span>.address().address&#125;</span>:<span class="subst">$&#123;</span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="keyword">this</span>.address().port</span></span></span><br><span class="line"><span class="string"><span class="subst">&#125;</span>/`</span></span><br><span class="line">);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">init</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="keyword">new</span> <span class="built_in">Date</span>().toJSON(), <span class="number">1</span>);</span><br><span class="line"><span class="keyword">await</span> sleep(<span class="number">30000</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="keyword">new</span> <span class="built_in">Date</span>().toJSON(), <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sleep</span>(<span class="params">ms</span>) </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">setTimeout(resolve, ms);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>雖然在 ASP.NET API 中，常常寫 await 之後，再將結果回給 Client 。<br>但透過 iisnode 來執行，壓個幾次，就會導致 iisnode hang 住。<br>因為這部份的程式，我們並不需要等待 api 的結果，所以就先將內容回給 Client 後，再執行 Call API 的 Task。</p><p>調整後，再來測試， iisnode 就不會 hang 住了。<br>但啟用 webscoket 後，再壓個幾次，又發生 iisnode hang 住的問題。<br>試了後久，後來查到 <a href="https://github.com/tjanczuk/iisnode/issues/268" target="_blank" rel="noopener">IIS stops serving content with iisnode and socket.io #268</a> 有提到 Windows 8 有 Http Request 10 個的限制，當啟用了 WebScoket 之後是一直連接著，所以會導致後面的 Request 被 Block 住。 將環境改到 Windows Server 來測試， WebScoket 也沒問題了。<br>如果有 timeout 問題也可以試著調整 maxNamedPipeConnectionRetry 與 namedPipeConnectionRetryDelay 的設定值。<br>備用方案就是使用 Reverse Proxy 的方式，可以參考 <a href="https://dev.to/petereysermans/hosting-a-node-js-application-on-windows-with-iis-as-reverse-proxy-397b" target="_blank" rel="noopener">Hosting a Node.js application on Windows with IIS as reverse proxy</a>。</p><p>使用 iisnode 下，可以儘快 Response 就儘快 Respose。測試 WebScoket 時，請記得使用 Windows Server 來壓測哦!</p><h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><p><a href="https://github.com/tjanczuk/iisnode/issues/268" target="_blank" rel="noopener">IIS stops serving content with iisnode and socket.io #268</a><br><a href="https://github.com/tjanczuk/iisnode/issues/555" target="_blank" rel="noopener">Does IISnode timeout the Http Request #555</a><br><a href="https://dev.to/petereysermans/hosting-a-node-js-application-on-windows-with-iis-as-reverse-proxy-397b" target="_blank" rel="noopener">Hosting a Node.js application on Windows with IIS as reverse proxy</a><br><a href="https://github.com/tjanczuk/iisnode/issues/558" target="_blank" rel="noopener">Unable to increase the node server timeout beyond 2 minute mark when using IISNode #558</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;我們有一個系統是使用 NodeJS ，同事 Stan 使用 PuppeteerSharp 同時起多個 Chrome 來測試它。&lt;br&gt;結果一
      
    
    </summary>
    
    
      <category term="iisnode" scheme="https://rainmakerho.github.io/tags/iisnode/"/>
    
      <category term="nodejs" scheme="https://rainmakerho.github.io/tags/nodejs/"/>
    
      <category term="windows" scheme="https://rainmakerho.github.io/tags/windows/"/>
    
      <category term="PuppeteerSharp" scheme="https://rainmakerho.github.io/tags/PuppeteerSharp/"/>
    
  </entry>
  
  <entry>
    <title>ASP.NET WebControl.Attributes 無法 Remove 問題</title>
    <link href="https://rainmakerho.github.io/2019/08/24/2019022/"/>
    <id>https://rainmakerho.github.io/2019/08/24/2019022/</id>
    <published>2019-08-24T09:50:18.000Z</published>
    <updated>2019-08-24T10:21:24.331Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>最近同事詢問一個 Web 控制項 在 Form 上面的 Client Click 是沒問題的，但是把它放到了 DataGrid 之中，它就沒有作用。</p><h3 id="研究"><a href="#研究" class="headerlink" title="研究"></a>研究</h3><p>使用 Browser 開發者工具(F12)，去查看，並在 JS 的 event 中寫入 alert 程式碼，當按下那個 Web 控制項 時，程式並沒有順利跑進那個 click 的 event handler 之中。<br>於是往上查看發現，因為在 TR 有一個 onmousedown 事件處理，裡面寫著 onmousedown = “javascript:this.click()”，就把 Click 事件給吃掉了，難怪沒有進去那個 click event handler 之中。 透過 F12 把那個 onmousedown 屬性設定移除， Web 控制項 就可以順利運作了。</p><p>即然找到了問題，再來當然是將那個 onmousedown 屬性從 DataGrid 中的設定移除它，本來想再詢問為何當初會有這樣子的程式碼呢? 它的用意是什麼呢? 當初寫的人已不知去向了。<br>建議從元件或是那支程式去調整，因為有將那個 Web 控制項放進去的只有 2 支程式，而開發團隊也不敢去調整元件，所以就往改那 2 支程式去做。</p><p>所以就建議同事在 PreRender 時，將那個 DataGridItem.Attributes 裡面的 onmousedown 移除。<br>但同事反應不管寫在那裡都移不掉，我連進去看，程式有順利呼叫 Attributes.Remove(“onmousedown”)，但那個 onmousedown 卻還 Render 出去。</p><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">'v10_tbA10_dgMaster 是 datagrid</span></span><br><span class="line"><span class="keyword">Protected</span> <span class="keyword">Sub</span> Page_PreRender(<span class="keyword">ByVal</span> sender <span class="keyword">As</span> <span class="built_in">Object</span>, <span class="keyword">ByVal</span> e <span class="keyword">As</span> System.EventArgs) <span class="keyword">Handles</span> <span class="keyword">Me</span>.PreRender</span><br><span class="line">  <span class="keyword">Dim</span> item <span class="keyword">As</span> DataGridItem</span><br><span class="line">  <span class="keyword">For</span> <span class="keyword">Each</span> item <span class="keyword">In</span> <span class="keyword">Me</span>.v10_tbA10_dgMaster.Items</span><br><span class="line">      item.Attributes.Remove(<span class="string">"onmousedown"</span>)</span><br><span class="line">  <span class="keyword">Next</span></span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Sub</span></span><br></pre></td></tr></table></figure><p>想說不可能呀!<br>於是將那些 Key 值印出來才發現，那個「onmousedown 」後面多了一個<strong>空白</strong>，難怪怎麼移都移不掉。<br>後來將程式改成如下，就順利解掉了。</p><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">'v10_tbA10_dgMaster 是 datagrid</span></span><br><span class="line"><span class="keyword">Protected</span> <span class="keyword">Sub</span> Page_PreRender(<span class="keyword">ByVal</span> sender <span class="keyword">As</span> <span class="built_in">Object</span>, <span class="keyword">ByVal</span> e <span class="keyword">As</span> System.EventArgs) <span class="keyword">Handles</span> <span class="keyword">Me</span>.PreRender</span><br><span class="line">  <span class="keyword">Dim</span> item <span class="keyword">As</span> DataGridItem</span><br><span class="line">  <span class="keyword">For</span> <span class="keyword">Each</span> item <span class="keyword">In</span> <span class="keyword">Me</span>.v10_tbA10_dgMaster.Items</span><br><span class="line">      item.Attributes.Remove(<span class="string">"onmousedown "</span>)</span><br><span class="line">  <span class="keyword">Next</span></span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Sub</span></span><br></pre></td></tr></table></figure><p>程式呀~~ 真的是什麼都有可能發生 Q_Q<br>希望大家在解問題時，多些細心、耐心，一起努力 :)</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;最近同事詢問一個 Web 控制項 在 Form 上面的 Client Click 是沒問題的，但是把它放到了 DataGrid 之中，它就沒
      
    
    </summary>
    
    
      <category term="ASP.NET" scheme="https://rainmakerho.github.io/tags/ASP-NET/"/>
    
      <category term="程式什麼都有可能發生" scheme="https://rainmakerho.github.io/tags/%E7%A8%8B%E5%BC%8F%E4%BB%80%E9%BA%BC%E9%83%BD%E6%9C%89%E5%8F%AF%E8%83%BD%E7%99%BC%E7%94%9F/"/>
    
      <category term="DataGridItem" scheme="https://rainmakerho.github.io/tags/DataGridItem/"/>
    
      <category term="WebControl.Attributes" scheme="https://rainmakerho.github.io/tags/WebControl-Attributes/"/>
    
  </entry>
  
  <entry>
    <title>Visual Studio 2017 WebTest for aspx postback</title>
    <link href="https://rainmakerho.github.io/2019/08/24/2019021/"/>
    <id>https://rainmakerho.github.io/2019/08/24/2019021/</id>
    <published>2019-08-24T05:28:53.000Z</published>
    <updated>2019-08-24T06:05:35.787Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>有朋友詢問使用 Visual Studio 2017 使用 WebTest 錄 ASPX 程式時，遇到了 postback 就會噴錯。<br>於是上網找個 aspx 的網站來試錄一下，結果發現錄完後，在很多 postback 的地方的確會錯誤。如下圖，<br><img src="/2019/08/24/2019021/001.png" title="WebTest Error"></p><h3 id="研究與解法"><a href="#研究與解法" class="headerlink" title="研究與解法"></a>研究與解法</h3><p>仔細看錯的地方還蠻奇怪的(上圖)，postback，應該要走 POST ，結果那個 url 卻是 GET。<br>再展開那個 GET 有一個 Dependent Requests 的 Url ，它是 POST，看起來那個才是我們需要的。如下圖，<br><img src="/2019/08/24/2019021/002.png" title="Dependent Requests"><br>檢查下一個 GET URL 的 Dependent Requests 中的 Url 也是 POST，應該也是我們需要的。<br>即然它才是我們需要的，所以我們可以將它們從 Dependent Requests 目錄中，移到最上層，然後再將那 2 個 GET 的 URL 刪除。<br><img src="/2019/08/24/2019021/003.png" title="Move POST And Delete GET"></p><p>所以從開頭 GET 到 2 個 POST 後，再測試一次，就可以發現，最後的結果是我們所需要的哦! 如下，<br><img src="/2019/08/24/2019021/004.png" title="Test OK"></p><h3 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h3><p>筆者試過 Visual Studio 2017/2019 都會有這樣子的狀況，所以在使用上，如果有遇到一樣的問題，可以試著這樣子調整看看哦!</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;有朋友詢問使用 Visual Studio 2017 使用 WebTest 錄 ASPX 程式時，遇到了 postback 就會噴錯。&lt;br
      
    
    </summary>
    
    
      <category term="VS2017" scheme="https://rainmakerho.github.io/tags/VS2017/"/>
    
      <category term="VS2019" scheme="https://rainmakerho.github.io/tags/VS2019/"/>
    
      <category term="WebTest" scheme="https://rainmakerho.github.io/tags/WebTest/"/>
    
      <category term="ASPX" scheme="https://rainmakerho.github.io/tags/ASPX/"/>
    
      <category term="Postback" scheme="https://rainmakerho.github.io/tags/Postback/"/>
    
  </entry>
  
  <entry>
    <title>ODataController Cross site scripting (content-sniffing)</title>
    <link href="https://rainmakerho.github.io/2019/07/31/2019020/"/>
    <id>https://rainmakerho.github.io/2019/07/31/2019020/</id>
    <published>2019-07-31T09:03:02.000Z</published>
    <updated>2019-07-31T09:57:37.189Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>最近同事詢問一個 ODataController 被黑箱打到的一個 XSS 問題。<br>ODataController 允許我們使用 $count, $select 等操作。<br>我們用一個簡單的 webapi 專案來測試，新增 WebApi 專案後，加入「Microsoft.AspNet.OData」。<br>詳細可以參考 <a href="https://docs.microsoft.com/en-us/aspnet/web-api/overview/odata-support-in-aspnet-web-api/odata-v4/create-an-odata-v4-endpoint" target="_blank" rel="noopener">Create an OData v4 Endpoint Using ASP.NET Web API</a>。</p><h3 id="測試"><a href="#測試" class="headerlink" title="測試"></a>測試</h3><p>建立 Product Model ，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Product</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">int</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">decimal</span> Price &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>因為只要測試 odata ，所以在 WebApiConfig.cs 只需設定 OData 的部份，如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">WebApiConfig</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Register</span>(<span class="params">HttpConfiguration config</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        config.MapHttpAttributeRoutes();</span><br><span class="line">        <span class="keyword">var</span> builder = <span class="keyword">new</span> ODataConventionModelBuilder();</span><br><span class="line">        config.Count().Filter().OrderBy().Expand().Select().MaxTop(<span class="literal">null</span>); <span class="comment">//new line</span></span><br><span class="line">        builder.EntitySet&lt;Product&gt;(<span class="string">"Products"</span>);</span><br><span class="line">        config.MapODataServiceRoute(</span><br><span class="line">          routeName: <span class="string">"odata"</span>,</span><br><span class="line">          routePrefix: <span class="string">"odata"</span>,</span><br><span class="line">          model: builder.GetEdmModel());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>建立測試的 ODataController</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ProductsController</span> : <span class="title">ODataController</span></span><br><span class="line">&#123;</span><br><span class="line">  [<span class="meta">EnableQuery</span>]</span><br><span class="line">  <span class="function"><span class="keyword">public</span> IHttpActionResult <span class="title">Get</span>(<span class="params">ODataQueryOptions&lt;Product&gt; opts</span>)</span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> products = <span class="keyword">new</span> List&lt;Product&gt;() &#123;</span><br><span class="line">      <span class="keyword">new</span> Product&#123;Id=<span class="number">1</span>, Name=<span class="string">"Product 1***"</span>, Price=<span class="number">101</span>&#125;,</span><br><span class="line">      <span class="keyword">new</span> Product&#123;Id=<span class="number">2</span>, Name=<span class="string">"Product 2***"</span>, Price=<span class="number">202</span>&#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> Ok(products);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>所以執行出來的結果如下，</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:50758/odata/Products?$count=true</span><br></pre></td></tr></table></figure><img src="/2019/07/31/2019020/001.png" title="正常的輸出"><p>正常的 \$count 的值允許為 true/false。<br>但是黑箱卻給它輸入以下的值，</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$count=&lt;ScRiPt&gt;cXfm(9342)&lt;/ScRiPt&gt;</span><br></pre></td></tr></table></figure><img src="/2019/07/31/2019020/002.png" title="XSS輸出"><p>因為直接把 url 上的內容直接輸出了，所以就被黑箱說有 XSS 問題。</p><h3 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h3><p>從上面可以發現，雖然它有錯誤的訊息出來，但程式卻會正常執行到 OK。<br>只是在 ODataQueryOptions<product> opts 中的 count.value 屬性會有錯誤，如下，<br><img src="/2019/07/31/2019020/003.png" title="ODataQueryOptions.count.value"></product></p><p>即然沒有錯誤，那要在那裡去將錯誤訊息 Encode 呢?<br>我們可以透過 opts.ApplyTo 去驗證它們，如果有錯誤的話，就建立 ODataException ，並將訊息 Encode ，如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">EnableQuery</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> IHttpActionResult <span class="title">Get</span>(<span class="params">ODataQueryOptions&lt;Product&gt; opts</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">var</span> products = <span class="keyword">new</span> List&lt;Product&gt;() &#123;</span><br><span class="line">    <span class="keyword">new</span> Product&#123;Id=<span class="number">1</span>, Name=<span class="string">"Product 1***"</span>, Price=<span class="number">101</span>&#125;,</span><br><span class="line">    <span class="keyword">new</span> Product&#123;Id=<span class="number">2</span>, Name=<span class="string">"Product 2***"</span>, Price=<span class="number">202</span>&#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">try</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">//only validate ODataQueryOptions</span></span><br><span class="line">    opts.ApplyTo((<span class="keyword">new</span> List&lt;Product&gt;()).AsQueryable());</span><br><span class="line">    <span class="keyword">return</span> Ok(products);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span>(Exception ex)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ODataException(HttpUtility.JavaScriptStringEncode(ex.ToString()));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>所以再執行一次，就可以發現錯誤訊息都有被 Encode 了。<br><img src="/2019/07/31/2019020/004.png" title="ODataException"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;最近同事詢問一個 ODataController 被黑箱打到的一個 XSS 問題。&lt;br&gt;ODataController 允許我們使用 $c
      
    
    </summary>
    
    
      <category term="Odata" scheme="https://rainmakerho.github.io/tags/Odata/"/>
    
      <category term="Cross site scripting" scheme="https://rainmakerho.github.io/tags/Cross-site-scripting/"/>
    
      <category term="content-sniffing" scheme="https://rainmakerho.github.io/tags/content-sniffing/"/>
    
      <category term="ODataController" scheme="https://rainmakerho.github.io/tags/ODataController/"/>
    
  </entry>
  
  <entry>
    <title>double.parse cause Input string was not in a correct format Error</title>
    <link href="https://rainmakerho.github.io/2019/07/19/2019019/"/>
    <id>https://rainmakerho.github.io/2019/07/19/2019019/</id>
    <published>2019-07-19T08:09:31.000Z</published>
    <updated>2019-07-19T08:44:28.752Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>最近同事遇到在 XML 解析上發生問題，但資料肉眼卻看不出來異狀。<br>今天又在 stackoverflow 上看到<a href="https://stackoverflow.com/questions/57107030/c-sharp-double-parsing-giving-an-error-when-it-shouldnt#57107469" target="_blank" rel="noopener">C# Double Parsing Giving an error when it shouldn’t</a>利用 double.parse 遇到 “240000” 時，卻會發生 Input string was not in a correct format 的錯誤。</p><h3 id="研究"><a href="#研究" class="headerlink" title="研究"></a>研究</h3><p><a href="https://stackoverflow.com/users/1612975/thegeneral" target="_blank" rel="noopener">TheGeneral</a>很快地發現，並不是 240000 有問題，而是他的資料”240000”中，有不可視字元。<br>所以如果用題問者的字串(t1)，跟自已 key 一個字串(t2)來看，當 parse 到 t1 時，的確會發生錯誤，如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> t1 = <span class="string">"240000‬"</span>;</span><br><span class="line"><span class="keyword">var</span> t2 = <span class="string">"240000"</span>;</span><br><span class="line"><span class="keyword">var</span> do2 = <span class="keyword">double</span>.Parse(t2);</span><br><span class="line"><span class="keyword">var</span> do1 = <span class="keyword">double</span>.Parse(t1); <span class="comment">//這裡會噴錯</span></span><br></pre></td></tr></table></figure><img src="/2019/07/19/2019019/001.png" title="double.parse error"><p>上面肉眼來看，t1, t2 沒有差別，但將它們每個字串 print 出來後可以發現，t1 多了一個 ? ，unicode 為 202c，如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> t1 = <span class="string">"240000"</span>;</span><br><span class="line"><span class="keyword">var</span> t2 = <span class="string">"240000"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">string</span> dumpt1 = <span class="keyword">string</span>.Join(Environment.NewLine,</span><br><span class="line">  t1.Select(c =&gt; <span class="string">$"'<span class="subst">&#123;c&#125;</span>' (\\u<span class="subst">&#123;(<span class="keyword">int</span>)c:x4&#125;</span>)"</span>));</span><br><span class="line"><span class="keyword">string</span> dumpt2 = <span class="keyword">string</span>.Join(Environment.NewLine,</span><br><span class="line">  t2.Select(c =&gt; <span class="string">$"'<span class="subst">&#123;c&#125;</span>' (\\u<span class="subst">&#123;(<span class="keyword">int</span>)c:x4&#125;</span>)"</span>));</span><br><span class="line"></span><br><span class="line">Console.WriteLine(<span class="string">"****** t1 **********"</span>);</span><br><span class="line">Console.WriteLine(dumpt1);</span><br><span class="line">Console.WriteLine(<span class="string">"****** t2 **********"</span>);</span><br><span class="line">Console.WriteLine(dumpt2);</span><br><span class="line">Console.WriteLine(<span class="string">"********************"</span>);</span><br></pre></td></tr></table></figure><img src="/2019/07/19/2019019/002.png" title="unprintable char"><p>所以當有類似的問題，而眼睛又看不出來時，可以將該內容的字元列印出來比對看看哦!</p><h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><p><a href="https://stackoverflow.com/questions/57107030/c-sharp-double-parsing-giving-an-error-when-it-shouldnt#57107469" target="_blank" rel="noopener">C# Double Parsing Giving an error when it shouldn’t</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;最近同事遇到在 XML 解析上發生問題，但資料肉眼卻看不出來異狀。&lt;br&gt;今天又在 stackoverflow 上看到&lt;a href=&quot;ht
      
    
    </summary>
    
    
      <category term="non-printable characters" scheme="https://rainmakerho.github.io/tags/non-printable-characters/"/>
    
      <category term="不可視字元" scheme="https://rainmakerho.github.io/tags/%E4%B8%8D%E5%8F%AF%E8%A6%96%E5%AD%97%E5%85%83/"/>
    
  </entry>
  
  <entry>
    <title>Checkmarx Cookie_Injection</title>
    <link href="https://rainmakerho.github.io/2019/07/17/2019018/"/>
    <id>https://rainmakerho.github.io/2019/07/17/2019018/</id>
    <published>2019-07-17T01:31:40.000Z</published>
    <updated>2019-07-17T01:51:42.908Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>最近系統被 Checkmarx 掃出有 Cookie_Injection 的問題。<br>似乎是怕在 Server 端取得 Cookie 的值，再給 Client 端時，會發生 XSS 的問題。<br>但它的 Issue 點卻是在 Request.Cookies[cookieName] ，如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> cookieNme = <span class="string">"SurveyCookie"</span>;</span><br><span class="line">HttpCookie cookie = Request.Cookies[cookieNme];</span><br><span class="line"><span class="keyword">if</span> (cookie == <span class="literal">null</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// no cookie found, create it</span></span><br><span class="line">  cookie = <span class="keyword">new</span> HttpCookie(cookieNme);</span><br><span class="line">&#125;</span><br><span class="line">cookie.Values[<span class="string">"usrId"</span>] = HttpUtility.UrlEncode(otherValue1);</span><br><span class="line">cookie.Values[<span class="string">"usrName"</span>] = HttpUtility.UrlEncode(otherValue2);</span><br><span class="line"><span class="comment">// update the expiration timestamp</span></span><br><span class="line">cookie.Expires = DateTime.UtcNow.AddDays(<span class="number">30</span>);</span><br><span class="line"><span class="comment">// HttpOnly &amp; Secure 可以在 web.config 中設定</span></span><br><span class="line">cookie.HttpOnly = <span class="literal">true</span>;</span><br><span class="line">cookie.Secure = <span class="literal">true</span>;</span><br><span class="line"><span class="comment">// overwrite the cookie</span></span><br><span class="line">Response.Cookies.Add(cookie);</span><br></pre></td></tr></table></figure><h3 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h3><p>感覺 Checkmarx 一見到取回 Request 的 Cookie 就開槍。<br>所以只好調整成，取回 Cookie 的 Values ，然後改判斷它的值。<br>如果要產生 cookie 的話，就直接新增一個 cookie 物件，也不是重新利用 Request 的物件，如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> cookieValues = Request.Cookies[cookieNme]?.Values;</span><br><span class="line"><span class="keyword">if</span> (cookieValues != <span class="literal">null</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">var</span> usrId = HttpUtility.UrlEncode(cookieValues[<span class="string">"usrId"</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> cookie = <span class="keyword">new</span> HttpCookie(cookieNme);</span><br><span class="line">cookie.Values[<span class="string">"usrId"</span>] = HttpUtility.UrlEncode(otherValue1);</span><br><span class="line">cookie.Values[<span class="string">"usrName"</span>] = HttpUtility.UrlEncode(otherValue2);</span><br><span class="line"><span class="comment">// update the expiration timestamp</span></span><br><span class="line">cookie.Expires = DateTime.UtcNow.AddDays(<span class="number">30</span>);</span><br><span class="line"><span class="comment">// HttpOnly &amp; Secure 可以在 web.config 中設定</span></span><br><span class="line">cookie.HttpOnly = <span class="literal">true</span>;</span><br><span class="line">cookie.Secure = <span class="literal">true</span>;</span><br><span class="line"><span class="comment">// overwrite the cookie</span></span><br><span class="line">Response.Cookies.Add(cookie);</span><br></pre></td></tr></table></figure><ul><li>註: ?. 是 C#4 的語法，如果有問題的話，請更新 Microsoft.CodeDom.Providers.DotNetCompilerPlatform 套件。</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;最近系統被 Checkmarx 掃出有 Cookie_Injection 的問題。&lt;br&gt;似乎是怕在 Server 端取得 Cookie 的
      
    
    </summary>
    
    
      <category term="checkmarx" scheme="https://rainmakerho.github.io/tags/checkmarx/"/>
    
      <category term="Cookie_Injection" scheme="https://rainmakerho.github.io/tags/Cookie-Injection/"/>
    
      <category term="CSharp" scheme="https://rainmakerho.github.io/tags/CSharp/"/>
    
  </entry>
  
  <entry>
    <title>Bitmap.save(): A generic error occurred in GDI+</title>
    <link href="https://rainmakerho.github.io/2019/07/04/2019017/"/>
    <id>https://rainmakerho.github.io/2019/07/04/2019017/</id>
    <published>2019-07-04T00:57:37.000Z</published>
    <updated>2019-09-05T05:28:31.096Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>記得「 Image.Save(stream,format.png) GDI+ generic error」這個錯誤在好久之前有看到過，但一直沒有注意那時是如何解決的。<br>今天同事有再詢問，所以就將網路上的資料一併記錄一下。</p><h3 id="研究"><a href="#研究" class="headerlink" title="研究"></a>研究</h3><p>網路上有的人說因為原本的 Image 被 Lock 住了，或是要  避免使用原本的 Stream 去 Save。<br>例如 Rick 的範例， 建立 bm2 後，再把 bm2 Save 到 Stream 去，就有可能會 GG。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Bitmap bm2 = <span class="keyword">this</span>.GetGlobalResourceObject(<span class="string">"Resources"</span>, <span class="string">"_BitMap"</span>) <span class="keyword">as</span> Bitmap;</span><br><span class="line"></span><br><span class="line">Response.ContentType = <span class="string">"image/jpeg"</span>;</span><br><span class="line"></span><br><span class="line">bm2.Save(Response.OutputStream, ImageFormat.Jpeg);</span><br><span class="line"></span><br><span class="line">Response.End();</span><br></pre></td></tr></table></figure><p>我們公司的程式，在某些機器上才會出現錯誤，如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 將讀取檔案之Byte[]轉成圖片檔的Base64</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="bytes"&gt;</span>圖檔的Byte Array<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="sourceFileFormat"&gt;</span>圖片格式<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span>[] <span class="title">ToImageBase64</span>(<span class="params"><span class="keyword">this</span> <span class="keyword">byte</span>[] bytes, ImageFormat sourceFileFormat</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// *** 參考資料:http://stackoverflow.com/questions/401561/how-to-open-a-multi-frame-tiff-imageformat-image-in-net-2-0</span></span><br><span class="line">    List&lt;<span class="keyword">string</span>&gt; images = <span class="keyword">new</span> List&lt;<span class="keyword">string</span>&gt;();</span><br><span class="line">    <span class="comment">// *** 將byte[] 存為MemoryStream ***</span></span><br><span class="line">    <span class="keyword">using</span> (Stream imageStreams = <span class="keyword">new</span> MemoryStream(bytes))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// *** 從MemoryStream中讀取Image ***</span></span><br><span class="line">        Image image = Image.FromStream(imageStreams);</span><br><span class="line">        <span class="comment">// *** 取得圖片檔的頁數 ***</span></span><br><span class="line">        <span class="keyword">int</span> page = image.GetFrameCount(FrameDimension.Page);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> p = <span class="number">0</span>; p &lt; page; p++)</span><br><span class="line">        &#123;</span><br><span class="line">            image.SelectActiveFrame(FrameDimension.Page, p);</span><br><span class="line">            <span class="comment">// *** 將Image File存入Stream中 ***</span></span><br><span class="line">            <span class="keyword">using</span> (<span class="keyword">var</span> byteStream = <span class="keyword">new</span> MemoryStream())</span><br><span class="line">            &#123;</span><br><span class="line">                image.Save(byteStream, sourceFileFormat);</span><br><span class="line">                <span class="comment">// *** 將Image Stream轉成Base64 ***</span></span><br><span class="line">                images.Add(Convert.ToBase64String(byteStream.ToArray()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// *** 從MemoryStream中讀取Image ***</span></span><br><span class="line">    <span class="keyword">return</span> images.ToArray();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">image.Save(byteStream, sourceFileFormat);</span><br></pre></td></tr></table></figure><p>上面 image.Save 在某些狀況下會出錯，或許可以新增一個 Bitmap 物件來 Save ，如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> p = <span class="number">0</span>; p &lt; page; p++)</span><br><span class="line">&#123;</span><br><span class="line">image.SelectActiveFrame(FrameDimension.Page, p);</span><br><span class="line"><span class="keyword">using</span> (<span class="keyword">var</span> newImage = <span class="keyword">new</span> Bitmap(image))</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// *** 將Image File存入Stream中 ***</span></span><br><span class="line"><span class="keyword">using</span> (<span class="keyword">var</span> byteStream = <span class="keyword">new</span> MemoryStream())</span><br><span class="line">&#123;</span><br><span class="line">newImage.Save(byteStream, sourceFileFormat);</span><br><span class="line"><span class="comment">// *** 將Image Stream轉成Base64 ***</span></span><br><span class="line">images.Add(Convert.ToBase64String(byteStream.ToArray()));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="現況"><a href="#現況" class="headerlink" title="現況"></a>現況</h3><p>雖然程式上去了，但在 IIS 運行一段時間後，又出現了 GDI+ 的錯誤。iisreset 後又可以了。<br>查看有問題的 png ，高度也沒太高，w3wp.exe 也沒有吃到很高的 Memory 。<br>在查不到任何頭緒之下，想到 png 只有一頁而已，原本的程式碼應該是針對 Tiff 來處理分頁的。<br>而讀進來的 Byte Array 本身就是 Image 了，就不需要特別再將它轉再 Image 又再轉回 Byte Array。<br>直接將傳進來的 Byte Array 直接轉 Base64 字串出去就可以了。</p><p>測試的程式如下，</p><ul><li>原本的程式</li></ul><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">string</span>[] <span class="title">GetPngFiles</span>(<span class="params"><span class="keyword">string</span>[] pngPaths</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">List&lt;<span class="keyword">string</span>&gt; pngImages = <span class="keyword">new</span> List&lt;<span class="keyword">string</span>&gt;();</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">string</span> realFileLocation <span class="keyword">in</span> pngPaths)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//read image 2 bytearray</span></span><br><span class="line"><span class="keyword">var</span> imageFile = Server.MapPath(<span class="string">$"~/images/<span class="subst">&#123;realFileLocation&#125;</span>"</span>);</span><br><span class="line"><span class="keyword">byte</span>[] bytes = File.ReadAllBytes(imageFile);</span><br><span class="line">List&lt;<span class="keyword">string</span>&gt; images = <span class="keyword">new</span> List&lt;<span class="keyword">string</span>&gt;();</span><br><span class="line"><span class="comment">// *** 將byte[] 存為MemoryStream ***</span></span><br><span class="line"><span class="keyword">using</span> (Stream imageStreams = <span class="keyword">new</span> MemoryStream(bytes))</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// *** 從MemoryStream中讀取Image ***</span></span><br><span class="line"><span class="keyword">var</span> image = Image.FromStream(imageStreams);</span><br><span class="line"><span class="comment">// *** 取得圖片檔的頁數 ***</span></span><br><span class="line"><span class="keyword">int</span> page = image.GetFrameCount(FrameDimension.Page);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> p = <span class="number">0</span>; p &lt; page; p++)</span><br><span class="line">&#123;</span><br><span class="line">image.SelectActiveFrame(FrameDimension.Page, p);</span><br><span class="line"><span class="comment">// *** 將Image File存入Stream中 ***</span></span><br><span class="line"><span class="keyword">using</span> (<span class="keyword">var</span> byteStream = <span class="keyword">new</span> MemoryStream())</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">using</span> (<span class="keyword">var</span> newImage = <span class="keyword">new</span> Bitmap(image))</span><br><span class="line">&#123;</span><br><span class="line">newImage.Save(byteStream, sourceFileFormat);</span><br><span class="line"><span class="comment">// *** 將Image Stream轉成Base64 ***</span></span><br><span class="line">images.Add(Convert.ToBase64String(byteStream.ToArray()));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//image.Save(byteStream, sourceFileFormat);</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span>/ *** 將Image Stream轉成Base64 ***</span></span><br><span class="line"><span class="comment">//images.Add(Convert.ToBase64String(byteStream.ToArray()));</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">pngImages.Add(images.ToArray()[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> pngImages.ToArray();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>調整後的程式</li></ul><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">string</span>[] <span class="title">GetPngFiles2</span>(<span class="params"><span class="keyword">string</span>[] pngPaths</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">List&lt;<span class="keyword">string</span>&gt; pngImages = <span class="keyword">new</span> List&lt;<span class="keyword">string</span>&gt;();</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">string</span> realFileLocation <span class="keyword">in</span> pngPaths)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//read image 2 bytearray</span></span><br><span class="line"><span class="keyword">var</span> imageFile = Server.MapPath(<span class="string">$"~/images/<span class="subst">&#123;realFileLocation&#125;</span>"</span>);</span><br><span class="line"><span class="keyword">byte</span>[] bytes = File.ReadAllBytes(imageFile);</span><br><span class="line"><span class="comment">// *** 將Image Stream轉成Base64 ***</span></span><br><span class="line">pngImages.Add(Convert.ToBase64String(bytes));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> pngImages.ToArray();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>註: 後來那個 GDI+ 又出現在 Aspose 的套件中，而且奇怪的是發生後，需要「重新開機」才又可以使用，過個 2 天，又會出現，所以與同事持續關注中，有新的狀況會再跟大家 Update。</li></ul><p>有看了一下網路上的可能問題，</p><ol><li>讀檔權限不足</li><li>沒有 Dispose</li><li>在使用前，已被 Dispose 掉了。</li></ol><h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><p><a href="https://weblog.west-wind.com/posts/2006/Oct/19/Common-Problems-with-rendering-Bitmaps-into-ASPNET-OutputStream" target="_blank" rel="noopener">Common Problems with rendering Bitmaps into ASP.NET OutputStream</a><br><a href="https://www.vishalon.net/blog/bitmapsave-a-generic-error-occurred-in-gdi" target="_blank" rel="noopener">Bitmap.save(): A generic error occurred in GDI+</a><br><a href="https://stackoverflow.com/questions/7698737/asp-net-a-generic-error-occurred-in-gdi" target="_blank" rel="noopener">asp.net : A generic error occurred in GDI+</a><br><a href="https://stackoverflow.com/questions/7558172/image-selectactiveframe-memory-problem" target="_blank" rel="noopener">Image.SelectActiveFrame memory problem</a><br><a href="https://stackoverflow.com/questions/1053052/a-generic-error-occurred-in-gdi-jpeg-image-to-memorystream/33324011#33324011" target="_blank" rel="noopener">A generic error occurred in GDI+, JPEG Image to MemoryStream</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;記得「 Image.Save(stream,format.png) GDI+ generic error」這個錯誤在好久之前有看到過，但一直
      
    
    </summary>
    
    
      <category term="Bitmap.save" scheme="https://rainmakerho.github.io/tags/Bitmap-save/"/>
    
      <category term="GDI+" scheme="https://rainmakerho.github.io/tags/GDI/"/>
    
  </entry>
  
  <entry>
    <title>Microsoft Threat Modeling Tool</title>
    <link href="https://rainmakerho.github.io/2019/07/03/2019016/"/>
    <id>https://rainmakerho.github.io/2019/07/03/2019016/</id>
    <published>2019-07-03T02:01:57.000Z</published>
    <updated>2019-07-03T05:42:20.333Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>大家在開發系統時除了畫系統架構圖之外，不知有沒畫 Threat Modeling 呢?<br>有了 Threat Modeling 可以看到整個系統大約有那些的 威脅，然後在開發系統時，一併考量進去。<br>跟 bug 一樣，逾早發現安全性威脅，解決成本逾低。<br>我們可以從 <a href="https://aka.ms/threatmodelingtool" target="_blank" rel="noopener">Microsoft Threat Modeling Tool</a> 來安裝 (windows only)。</p><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><h4 id="Application-Review"><a href="#Application-Review" class="headerlink" title="Application Review"></a>Application Review</h4><p><strong>Microsoft Threat Modeling Tool</strong> 讓我們透過畫 Data Flow Diagrams(DFDs) 後，自動產生相關的安全性威脅。<br>安裝完成後，開啟程式可以選擇 Azure or SDL 的範本，請依您系統的類別選取範本，這裡筆者是使用 SDL 範本。<br><img src="/2019/07/03/2019016/001.png" title="選取範本"></p><p>然後按下「Create A Model」就會進入空白的 Diagram 。<br><img src="/2019/07/03/2019016/002.png" title="NewModel"></p><p>而我們在畫的過程中，應著重在安全性方面進行系統架構 Review，考量以下幾點，</p><ul><li>這系統會有那些使用者?</li><li>有什麼合規的要求嗎?</li><li>有那些資料需要被保護嗎?</li><li>有跟其他系統互動?</li></ul><h4 id="Data-Flow-Diagrams"><a href="#Data-Flow-Diagrams" class="headerlink" title="Data Flow Diagrams"></a>Data Flow Diagrams</h4><p><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/24/Data-flow-diagram-notation.svg/440px-Data-flow-diagram-notation.svg.png" alt="Data Flow Diagrams" width="250"></p><h4 id="開始作畫"><a href="#開始作畫" class="headerlink" title="開始作畫"></a>開始作畫</h4><p>1.先拉出 Elements<br>一開始，先將跟安全性相關的項目拉到畫布上<br><img src="/2019/07/03/2019016/003.png" title="Elements"></p><p>2.用 Flow 串起來<br>再將每個項目透過 Flow 串接起來<br><img src="/2019/07/03/2019016/004.png" title="Flow"></p><p>3.標示 Elements<br>再檢視有那些需要做額外的標示，例如 Process 使用的語言(c#, Node, Java…)<br><img src="/2019/07/03/2019016/005.png" title="Flow"></p><p>4.加上備註</p><p>5.找其他人一起來 Review</p><h4 id="Threat-Types"><a href="#Threat-Types" class="headerlink" title="Threat Types"></a>Threat Types</h4><p><strong>Microsoft Threat Modeling Tool</strong> 會套用 STRIDE Threat Types，<br>參考自<a href="https://docs.microsoft.com/en-us/azure/security/azure-security-threat-modeling-tool-threats" target="_blank" rel="noopener">Microsoft Threat Modeling Tool threats</a></p><table><thead><tr><th>類別</th><th>描述</th></tr></thead><tbody><tr><td>詐騙 Spoofing</td><td>涉及非法存取然後使用其他使用者的驗證資訊，例如使用者名稱和密碼</td></tr><tr><td>竄改 Tampering</td><td>涉及惡意修改資料。 範例包括未經授權變更持續性資料 (例如保存在資料庫中的資料)，以及修改在兩部電腦之間透過開放式網路 (例如網際網路) 流動的資料 (中間人攻擊，修改交易金額…)</td></tr><tr><td>否認性 Repudiation</td><td>與拒絕執行動作但沒有其他任何一方有辦法另外證明的使用者有關，比方說，使用者在無法追蹤禁止作業的系統中執行非法作業。 不可否認性是指系統對抗否認性威脅的能力。 例如，購買商品的使用者可能必須在收到商品時簽名。 然後，廠商可以使用簽名收據做為使用者已收到包裹的證據</td></tr><tr><td>資訊洩漏 Information Disclosure</td><td>涉及將資訊暴露給不應該具有其存取權的個人，例如，使用者可以讀取它們未被授權存取的檔案，或入侵者能夠讀取在兩部電腦之間傳輸的資料</td></tr><tr><td>阻斷服務 Denial of Service</td><td>阻斷服務 (DoS) 攻擊可阻斷對有效使用者提供的服務，例如，藉由讓網頁伺服器暫時無法存取或無法使用。 您必須防止特定類型的 DoS 威脅，以便提升系統的可用性和可靠性</td></tr><tr><td>權限提高 Elevation of Privilege</td><td>未授權的使用者取得授權的存取權，因此有足夠存取權危害或摧毀整個系統。 提高權限威脅包含下列情況：攻擊者已有效地滲透所有系統防禦，並成為受信任系統本身的一部分，這確實是危險的情況</td></tr></tbody></table><p><br></p><h4 id="分析-Threats"><a href="#分析-Threats" class="headerlink" title="分析 Threats"></a>分析 Threats</h4><p>畫好之後，切到 Analysis View，就可以看到下面有一堆的 Threats ，大家可依它們的說明來了解為什麼會有那些 Threats 以及如何調整它們，<br><img src="/2019/07/03/2019016/006.png" title="Analysis View"><br>大家可以查看每個 Threat ，設定它們的優先序，及在 Justification 寫入因應作法，設定 Status 。</p><h4 id="產生報表"><a href="#產生報表" class="headerlink" title="產生報表"></a>產生報表</h4><p>我們可以按 Menu 上的 Report 來產生 html 報表。<br><img src="https://docs.microsoft.com/en-us/azure/security/media/azure-security-threat-modeling-tool-feature-overview/report.png" alt="Threats Modeling Report"></p><h3 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h3><p>我們有了 Threat Model ，會對整個系統整體的安全性有一定的了解，也可以儘早針對高風險的 Threat 進行防範。</p><ul><li>註: 自動列出 Threats ?<br>不知大家是否對於該 Tool 為什麼可以自動列出 Threats 而感到好奇呢?<br>只要大家開啟 Template 就可以知道，它其實是有寫 Rule 在裡面，當 Elements 有相關，並且屬性值為某個值時，就會出現那個 Threat ，例如下圖，當 Source 為 Generic External Interactor ， Target 為 Generic Process 就會出現那個 Threat ，但如果 Flow 的屬性有設設定 Source Authenticated 是 Yes ，或是 Generic External Interactor 屬性有設定 Authenticates Itself 為 Yes ，就不會出現那個 Threat<img src="/2019/07/03/2019016/007.png" title="Threat Rule"></li></ul><h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><p><a href="https://resources.infosecinstitute.com/applications-threat-modeling/#gref" target="_blank" rel="noopener">Applications Threat Modeling</a><br><a href="https://www.geeksforgeeks.org/microsoft-threat-modelling-tool-2016-set-1/" target="_blank" rel="noopener">Microsoft Threat modelling tool 2016 | Set 1</a><br><a href="https://aka.ms/threatmodelingtool" target="_blank" rel="noopener">下載 Microsoft Threat Modeling Tool</a><br><a href="https://docs.microsoft.com/en-us/azure/security/azure-security-threat-modeling-tool-feature-overview" target="_blank" rel="noopener">Threat Modeling Tool feature overview</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;大家在開發系統時除了畫系統架構圖之外，不知有沒畫 Threat Modeling 呢?&lt;br&gt;有了 Threat Modeling 可以看到
      
    
    </summary>
    
    
      <category term="Microsoft Threat Modeling Tool" scheme="https://rainmakerho.github.io/tags/Microsoft-Threat-Modeling-Tool/"/>
    
      <category term="STRIDE" scheme="https://rainmakerho.github.io/tags/STRIDE/"/>
    
      <category term="威脅模型" scheme="https://rainmakerho.github.io/tags/%E5%A8%81%E8%84%85%E6%A8%A1%E5%9E%8B/"/>
    
  </entry>
  
  <entry>
    <title>SQL Replace 後，怎麼會留空白呢?</title>
    <link href="https://rainmakerho.github.io/2019/06/12/2019015/"/>
    <id>https://rainmakerho.github.io/2019/06/12/2019015/</id>
    <published>2019-06-12T05:49:14.000Z</published>
    <updated>2019-06-12T07:35:21.790Z</updated>
    
    <content type="html"><![CDATA[<h3 id="問題"><a href="#問題" class="headerlink" title="問題"></a>問題</h3><p>最近客戶將 SQL Server 從 SQL 2012 升級到 SQL 2016 後，有些 Store Procedure 居然發生了錯誤。<br>結果發現，原本在 SQL 2012 中去 Replace 後，原本後面有空字串的會一併 RTrim 掉，但在 SQL 2016 中，那些空白就會留著。</p><p>怎麼會這樣子呢? 查看官方文件中，這個行為在 SQL 2008 之後就是如此了呀~<br><a href="https://docs.microsoft.com/en-us/previous-versions/sql/sql-server-2008/ms143359(v=sql.100)#replace-function" target="_blank" rel="noopener">Behavior Changes to Database Engine Features in SQL Server 2008 - REPLACE Function</a></p><blockquote><p>In SQL Server 2005, trailing spaces specified in the first input parameter to the REPLACE function are trimmed when the parameter is of type char. For example, in the statement SELECT ‘&lt;’ + REPLACE(CONVERT(char(6), ‘ABC ‘), ‘ ‘, ‘L’) + ‘&gt;’, the value ‘ABC ‘ is incorrectly evaluated as ‘ABC’.</p></blockquote><blockquote><p>In SQL Server 2008, trailing spaces are always preserved. For applications that rely on the previous behavior of the function, use the RTRIM function when specifying the first input parameter for the function. For example, the following syntax will reproduce the SQL Server 2005 behavior SELECT ‘&lt;’ + REPLACE(RTRIM(CONVERT(char(6), ‘ABC ‘)), ‘ ‘, ‘L’) + ‘&gt;’.</p></blockquote><p>也就是說，SQL 2008 之後，如果要將 Replace 後的空字串 Trim 掉，請自已加一下 RTRIM !!!</p><p>嗯，不過，我們的現況是 SQL 2012 跟 SQL 2016 ，這到底是怎麼回事呢?</p><h3 id="研究"><a href="#研究" class="headerlink" title="研究"></a>研究</h3><p>結果透過 SSMS 來看資料庫，發現 SQL 2012 的那個資料庫，相容性層級設定的是 SQL 2005，而 SQL 2016 最底的相容性層級只到 SQL 2008。所以才在 SQL 2016 上才發生這樣子的錯誤。</p><p>即然知道問題了，就要看怎麼解了。<br>依官網來說，程式就給它改下去吧，可能要盤點一下有那些 Store Procedure 有影響吧。</p><p>另一個解法是設定 <a href="https://docs.microsoft.com/en-us/sql/t-sql/statements/set-ansi-padding-transact-sql?view=sql-server-2017" target="_blank" rel="noopener">ANSI_PADDING</a> 為 OFF (預設為 ON)。<br>如果目前使用 Replace 是因為遇到了 Char 資料型態，可以在運算之前，設定 <a href="https://docs.microsoft.com/en-us/sql/t-sql/statements/set-ansi-padding-transact-sql?view=sql-server-2017" target="_blank" rel="noopener">ANSI_PADDING</a> 為 OFF，這樣子就不會把空字串加上去了。<br>例如，</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> [dbo].[table1] (</span><br><span class="line">    [<span class="keyword">id</span>]        TINYINT       <span class="keyword">IDENTITY</span> (<span class="number">1</span>, <span class="number">1</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    [char1]     <span class="built_in">CHAR</span> (<span class="number">10</span>)     <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    [nchar2]    <span class="keyword">NCHAR</span> (<span class="number">10</span>)    <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    [varchar1]  <span class="built_in">VARCHAR</span> (<span class="number">10</span>)  <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    [<span class="keyword">nvarchar2</span>] <span class="keyword">NVARCHAR</span> (<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">truncate</span> <span class="keyword">table</span> table1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> [dbo].[table1]([char1], [nchar2], [varchar1], [<span class="keyword">nvarchar2</span>])</span><br><span class="line"><span class="keyword">values</span> (<span class="string">'char1'</span>, N<span class="string">'nchar2'</span>, <span class="string">'varchar1'</span>, N<span class="string">'nvarchar2'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 預設是 SET ANSI_PADDING ON</span></span><br><span class="line"><span class="comment">-- 所以 char1 欄位 replace 後，會留有空白哦!</span></span><br><span class="line"><span class="keyword">SET</span> ANSI_PADDING <span class="keyword">ON</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="string">'['</span> + char1 + <span class="string">']'</span> <span class="keyword">as</span> char1,</span><br><span class="line"><span class="string">'['</span> + <span class="keyword">replace</span>(char1, <span class="string">'char'</span>, <span class="string">'rm'</span>) + <span class="string">']'</span> <span class="keyword">as</span> char1_replace ,</span><br><span class="line"><span class="string">'['</span> + nchar2 + <span class="string">']'</span> <span class="keyword">as</span> nchar2,</span><br><span class="line">N<span class="string">'['</span> + <span class="keyword">replace</span>(nchar2, N<span class="string">'char'</span>, N<span class="string">'rm'</span>) + N<span class="string">']'</span> <span class="keyword">as</span> nchar2_replace,</span><br><span class="line"><span class="string">'['</span> + varchar1 + <span class="string">']'</span> <span class="keyword">as</span> varchar1,</span><br><span class="line"><span class="string">'['</span> + <span class="keyword">replace</span>(varchar1, <span class="string">'char'</span>, <span class="string">'rm'</span>) + <span class="string">']'</span> <span class="keyword">as</span> varchar1_replace,</span><br><span class="line"><span class="string">'['</span> + <span class="keyword">nvarchar2</span> + <span class="string">']'</span> <span class="keyword">as</span> <span class="keyword">nvarchar2</span>,</span><br><span class="line">N<span class="string">'['</span> + <span class="keyword">replace</span>(<span class="keyword">nvarchar2</span>, N<span class="string">'char'</span>, N<span class="string">'rm'</span>) + N<span class="string">']'</span> <span class="keyword">as</span> nvarchar2_replace</span><br><span class="line"><span class="keyword">from</span> table1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> ANSI_PADDING <span class="keyword">off</span>;</span><br><span class="line"><span class="comment">-- 所以 char1 欄位 replace 後，會不會有空白了哦~</span></span><br><span class="line"><span class="keyword">select</span> <span class="string">'['</span> + char1 + <span class="string">']'</span> <span class="keyword">as</span> char1,</span><br><span class="line"><span class="string">'['</span> + <span class="keyword">replace</span>(char1, <span class="string">'char'</span>, <span class="string">'rm'</span>) + <span class="string">']'</span> <span class="keyword">as</span> char1_replace ,</span><br><span class="line"><span class="string">'['</span> + nchar2 + <span class="string">']'</span> <span class="keyword">as</span> nchar2,</span><br><span class="line">N<span class="string">'['</span> + <span class="keyword">replace</span>(nchar2, N<span class="string">'char'</span>, N<span class="string">'rm'</span>) + N<span class="string">']'</span> <span class="keyword">as</span> nchar2_replace,</span><br><span class="line"><span class="string">'['</span> + varchar1 + <span class="string">']'</span> <span class="keyword">as</span> varchar1,</span><br><span class="line"><span class="string">'['</span> + <span class="keyword">replace</span>(varchar1, <span class="string">'char'</span>, <span class="string">'rm'</span>) + <span class="string">']'</span> <span class="keyword">as</span> varchar1_replace,</span><br><span class="line"><span class="string">'['</span> + <span class="keyword">nvarchar2</span> + <span class="string">']'</span> <span class="keyword">as</span> <span class="keyword">nvarchar2</span>,</span><br><span class="line">N<span class="string">'['</span> + <span class="keyword">replace</span>(<span class="keyword">nvarchar2</span>, N<span class="string">'char'</span>, N<span class="string">'rm'</span>) + N<span class="string">']'</span> <span class="keyword">as</span> nvarchar2_replace</span><br><span class="line"><span class="keyword">from</span> table1;</span><br></pre></td></tr></table></figure><p>執行結果如下，<br><img src="/2019/06/12/2019015/001.png" title="ANSI_PADDING on/off 比較"><br>可以看到上面 ANSI_PADDING ON 時，Replace 後是有空白的，Off 之後 char1 欄位是沒有空白的。<br>但對於 NCHAR 的資料型態是沒有改變的哦!</p><p>所以，如果您在 Replace 遇到的問題是 CHAR ，那您可以在執行 SQL 之前，先去下</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> ANSI_PADDING <span class="keyword">OFF</span></span><br><span class="line"><span class="comment">-- 你原本的SQL</span></span><br></pre></td></tr></table></figure><p>依據大多數系統大多會將執行 SQL 的部份抽出來，所以目前您可以在那先去設定 ANSI_PADDING OFF。</p><ul><li>請注意 NCHAR ， ANSI_PADDING 固定會是 ON 的哦! 所以設定 SET ANSI_PADDING OFF 只針對 CHAR 有效果哦!</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;問題&quot;&gt;&lt;a href=&quot;#問題&quot; class=&quot;headerlink&quot; title=&quot;問題&quot;&gt;&lt;/a&gt;問題&lt;/h3&gt;&lt;p&gt;最近客戶將 SQL Server 從 SQL 2012 升級到 SQL 2016 後，有些 Store Procedure 居然發生了錯誤。
      
    
    </summary>
    
    
      <category term="sql" scheme="https://rainmakerho.github.io/tags/sql/"/>
    
      <category term="sql 2016" scheme="https://rainmakerho.github.io/tags/sql-2016/"/>
    
      <category term="sql 2005" scheme="https://rainmakerho.github.io/tags/sql-2005/"/>
    
      <category term="sql 2008" scheme="https://rainmakerho.github.io/tags/sql-2008/"/>
    
      <category term="replace" scheme="https://rainmakerho.github.io/tags/replace/"/>
    
      <category term="rtrim" scheme="https://rainmakerho.github.io/tags/rtrim/"/>
    
  </entry>
  
  <entry>
    <title>使用 NPOI.HSSF.UserModel.HSSFSheet.CopyRow 造成 IIS 應用程式重啟問題</title>
    <link href="https://rainmakerho.github.io/2019/06/04/2019014/"/>
    <id>https://rainmakerho.github.io/2019/06/04/2019014/</id>
    <published>2019-06-04T02:09:26.000Z</published>
    <updated>2019-06-20T02:41:23.407Z</updated>
    
    <content type="html"><![CDATA[<h3 id="環境"><a href="#環境" class="headerlink" title="環境"></a>環境</h3><p>Windows 2012 R2, IIS, NPOI v2.1.1.0<br>.net 3.x , 應用程式集區為 32 位元</p><h3 id="問題"><a href="#問題" class="headerlink" title="問題"></a>問題</h3><p>最近同事在一台 Windows 2012 R2 上安裝系統，把 8 個 iis 的應用程式放在同一個應用程式集區之中。<br>其中一個應用程式中，有使用到 NOPI 去產生 Excel 報表。<br>那個報表是依 DataTable 將資料 Loop 放到 Excel 之中，但神奇的是，程式在執行到一半，卻會讓那個應用程式集區直接重啟。<br>而事件檢視器之中就只有「失敗的應用程式名稱: w3wp.exe，版本: 8.5.9600.16384，時間戳記: 0x52157ba0」的錯誤，如下，<br><img src="/2019/06/04/2019014/001.png" title="w3wp.exe錯誤"></p><h3 id="研究"><a href="#研究" class="headerlink" title="研究"></a>研究</h3><p>因為是 w3wp.exe 直接重啟，所以就透過 <a href="https://www.microsoft.com/en-us/download/details.aspx?id=58210" target="_blank" rel="noopener">Debug Diagnostic Tool</a>來收集 IIS 的 Crash 資料，所以先透過 DebugDiag 2 Collection 來收集發生錯誤時，將 Stack Trace Log 起來，如下，<br><img src="/2019/06/04/2019014/002.png" title="DebugDiag 2 Collection"></p><p>最後發現，應用程式集區重啟後，的確產生 2 個不同 Process 的 Log 檔，如下，<br><img src="/2019/06/04/2019014/003.png" title="DebugDiag Log File"></p><p>查看最後的 Log 是掛在 NPOI 的 NPOI.HSSF.UserModel.HSSFRow.get_Cells ，如下，</p><blockquote><p>0e5fd908 759c89f2 [HelperMethodFrame_PROTECTOBJ: 0e5fd908] System.Delegate.DelegateConstruct(System.Object, IntPtr)<br>0e5fdaf0 67511c77 System.Collections.Generic.SortedDictionary<code>2+ValueCollection[[System.Int32, mscorlib],[System.__Canon, mscorlib]].CopyTo(System.__Canon[], Int32) 0e5fdb18 6f537a25 System.Collections.Generic.List</code>1[[System.__Canon, mscorlib]]..ctor(System.Collections.Generic.IEnumerable`1&lt;System.__Canon&gt;)<br>0e5fdb50 1ce64bbe NPOI.HSSF.UserModel.HSSFRow.get_Cells()<br>0e5fdb60 1ce64a91 NPOI.HSSF.UserModel.HSSFSheet.NotifyRowShifting(NPOI.HSSF.UserModel.HSSFRow)<br>0e5fdba8 1ce64016 NPOI.HSSF.UserModel.HSSFSheet.ShiftRows(Int32, Int32, Int32, Boolean, Boolean, Boolean)<br>0e5fdc38 1ce63f14 NPOI.HSSF.UserModel.HSSFSheet.ShiftRows(Int32, Int32, Int32)<br>0e5fdc44 1ce628e2 NPOI.SS.Util.SheetUtil.CopyRow(NPOI.SS.UserModel.ISheet, Int32, Int32)<br>0e5fdc70 1ce6281a NPOI.HSSF.UserModel.HSSFSheet.CopyRow(Int32, Int32)</p></blockquote><p>如果將錯誤改成 dump 檔的話，然後再透過 DebugDiag Analysis 來分析，主要錯誤如下，</p><blockquote><p>ntdll!NtWaitForSingleObject+c<br>KERNELBASE!WaitForSingleObjectEx+99<br>mscorwks!CLREventWaitHelper+2f<br>mscorwks!CLREvent::WaitEx+117<br>mscorwks!CLREvent::Wait+17<br>mscorwks!ThreadpoolMgr::SafeWait+73<br>mscorwks!ThreadpoolMgr::WorkerThreadStart+11c<br>mscorwks!Thread::intermediateThreadProc+49<br>kernel32!BaseThreadInitThunk+24<br>ntdll!__RtlUserThreadStart+2f<br>ntdll!_RtlUserThreadStart+1b</p></blockquote><p>而它的錯誤點，就指到了上述 NPOI 的錯誤。</p><p>在沒什麼想法時，想說將那個有錯誤的應用程式，放到一個單獨使用的應用程式集區之中，比較好分析。<br>於是將它放過去之後，錯誤也隨之不見了。<br>再將它放在一起，錯誤又出現了。 @_@</p><h3 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h3><p>新增一個新的應用程式集區，然後讓那個會出錯的應用程式使用，再測試一次程式，居然就不會有問題了。<br>或許也可以更新 NPOI 版本到較新的版本試看看。</p><p>大家有其他的想法嗎? 歡迎提供出來討論哦 :)</p><ul><li>2019/06/20 Update<ul><li>有同事也遇到一樣的問題，但如果將 Application Pool 改成 x64 的話，就沒有問題。</li></ul></li></ul><h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><p><a href="https://stackify.com/troubleshoot-w3wp-crash/" target="_blank" rel="noopener">How to Troubleshoot an ASP.NET Crash &amp; Analyze w3wp Crash Dumps</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;環境&quot;&gt;&lt;a href=&quot;#環境&quot; class=&quot;headerlink&quot; title=&quot;環境&quot;&gt;&lt;/a&gt;環境&lt;/h3&gt;&lt;p&gt;Windows 2012 R2, IIS, NPOI v2.1.1.0&lt;br&gt;.net 3.x , 應用程式集區為 32 位元&lt;/p&gt;
&lt;h
      
    
    </summary>
    
    
      <category term="IIS" scheme="https://rainmakerho.github.io/tags/IIS/"/>
    
      <category term="NPOI" scheme="https://rainmakerho.github.io/tags/NPOI/"/>
    
      <category term="Windows 2012" scheme="https://rainmakerho.github.io/tags/Windows-2012/"/>
    
      <category term="Crash" scheme="https://rainmakerho.github.io/tags/Crash/"/>
    
      <category term="Application Pool" scheme="https://rainmakerho.github.io/tags/Application-Pool/"/>
    
  </entry>
  
  <entry>
    <title>NullReferenceException 在 new class 時?</title>
    <link href="https://rainmakerho.github.io/2019/05/28/2019013/"/>
    <id>https://rainmakerho.github.io/2019/05/28/2019013/</id>
    <published>2019-05-28T07:35:49.000Z</published>
    <updated>2019-05-30T07:30:32.346Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>最近同事詢問一個很奇怪的問題，在執行程式時會跳「System.NullReferenceException: 並未將物件參考設定為物件的執行個體。」的錯誤。但它錯誤的行號卻是在 new 一個 POCO 的 Class 。錯誤訊息如下，</p><blockquote><p>System.NullReferenceException: 並未將物件參考設定為物件的執行個體。<br>於 xxx.Controllers.rmController.rmAction(String num) 於 D:xxx\Controllers\rmController.cs: 行 482<br>於 lambda_method(Closure , ControllerBase , Object[] )<br>於 System.Web.Mvc.ReflectedActionDescriptor.Execute(ControllerContext controllerContext, IDictionary<code>2 parameters) 於 System.Web.Mvc.ControllerActionInvoker.InvokeActionMethod(ControllerContext controllerContext, ActionDescriptor actionDescriptor, IDictionary</code>2 parameters)</p></blockquote><p>而在 Server 端的錯誤黃畫面中，原始碼程式錯誤，卻沒有明確顯示出錯誤的程式碼，如下，<br><img src="/2019/05/28/2019013/001.png" title="[Error Page]"></p><h3 id="測試"><a href="#測試" class="headerlink" title="測試"></a>測試</h3><p>Controller 的程式碼如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ActionResult <span class="title">rmAction</span>(<span class="params"><span class="keyword">string</span> num</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> model = <span class="keyword">new</span> rmModel(); <span class="comment">//這裡是 482 行</span></span><br><span class="line">    <span class="comment">// check transfer data</span></span><br><span class="line">    <span class="keyword">bool</span> hasData = <span class="keyword">this</span>.rmBLL.HasTransferToData(<span class="keyword">this</span>.CompanyId, num);</span><br><span class="line">    <span class="comment">// ... 其他程式碼</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>跟同事 Garry, Leo 一直想不透 new 一個 POCO 的 Class，怎麼可能會噴 NullReferenceException。<br>於是使用了各種方式來測試，例如直接在 View 或是直接建立 aspx 去測試，都不會錯誤。<br>後來同事將下一行的程式碼，也搬到 View 及 aspx 去試，錯誤就在正確的地方噴錯。<br>原來不是那個 new 錯誤，而是下一行的所造成的錯誤。<br>所以下次有類似的問題，可以試著將程式碼搬到 View or aspx 去測試，或許可以加快查問題的速度。<br>aspx 的 inline code 方式，我在 Debug 時蠻長使用的，因為直接新增一支 aspx 然後寫程式碼就可以驗證了。<br>808dk 的範例如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ Import Namespace=<span class="string">"System"</span> %&gt;</span><br><span class="line">&lt;%@ Page Language=<span class="string">"c#"</span>%&gt;</span><br><span class="line"></span><br><span class="line">&lt;script runat=<span class="string">"server"</span>&gt;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">ServerSideFunction</span>(<span class="params"><span class="keyword">string</span> input</span>)</span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"Hello "</span> + input;</span><br><span class="line">  &#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;% <span class="keyword">string</span> pageVariable = <span class="string">"world"</span>; %&gt;</span><br><span class="line">&lt;!DOCTYPE html PUBLIC <span class="string">"-//W3C//DTD XHTML 1.0 Transitional//EN"</span></span><br><span class="line">    <span class="string">"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"</span>&gt;</span><br><span class="line">&lt;html xmlns=<span class="string">"http://www.w3.org/1999/xhtml"</span> xml:lang=<span class="string">"en"</span> lang=<span class="string">"en"</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta http-equiv=<span class="string">"Content-Type"</span> content=<span class="string">"text/html; charset=windows-1252"</span> /&gt;</span><br><span class="line">&lt;title&gt;ASP.NET inline&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;% =ServerSideFunction(pageVariable) %&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ Import <span class="keyword">Namespace</span>=<span class="string">"System"</span> %&gt;</span><br><span class="line">&lt;%@ Page Language=<span class="string">"VB"</span> %&gt;</span><br><span class="line"></span><br><span class="line">&lt;script runat=<span class="string">"server"</span>&gt;</span><br><span class="line">  <span class="keyword">Public</span> <span class="keyword">Function</span> ServerSideFunction(input <span class="keyword">As</span> <span class="built_in">String</span>) <span class="keyword">As</span> <span class="built_in">String</span></span><br><span class="line">    ServerSideFunction = <span class="string">"Hello "</span> &amp; input</span><br><span class="line">  <span class="keyword">End</span> <span class="keyword">Function</span></span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;% <span class="keyword">Dim</span> pageVariable <span class="keyword">As</span> <span class="built_in">String</span> = <span class="string">"world"</span> %&gt;</span><br><span class="line">&lt;!DOCTYPE html <span class="keyword">PUBLIC</span> <span class="string">"-//W3C//DTD XHTML 1.0 Transitional//EN"</span></span><br><span class="line">    <span class="string">"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"</span>&gt;</span><br><span class="line">&lt;html xmlns=<span class="string">"http://www.w3.org/1999/xhtml"</span> xml:lang=<span class="string">"en"</span> lang=<span class="string">"en"</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta http-equiv=<span class="string">"Content-Type"</span> content=<span class="string">"text/html; charset=windows-1252"</span> /&gt;</span><br><span class="line">&lt;title&gt;ASP.NET inline&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;% =ServerSideFunction(pageVariable) %&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><h3 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h3><p>從這例子中，可以發現，原來錯誤的行號也會騙人(如果 pdb 不對的話，行號或許也會不同)。<br>同一包建置出來的程式在 Local 或公司執行都沒有問題，部署到客戶端就噴錯，一度懷疑是否 web.config 有什麼差異。<br>最後同事以插旗子的方式去驗證不是掛在 new class 的地方。<br>將程式放到 aspx inline code 的方式，也是幫助我們快速找到問題的一個方式哦!</p><h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><p><a href="http://www.808.dk/?code-aspnet-inline" target="_blank" rel="noopener">Using inline code in ASP.NET (C# and VB.Net)</a></p><p>非常感謝同事 Garry, Leo 的分享</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;最近同事詢問一個很奇怪的問題，在執行程式時會跳「System.NullReferenceException: 並未將物件參考設定為物件的執行
      
    
    </summary>
    
    
      <category term="NullReferenceException" scheme="https://rainmakerho.github.io/tags/NullReferenceException/"/>
    
      <category term="ASP.NET MVC" scheme="https://rainmakerho.github.io/tags/ASP-NET-MVC/"/>
    
      <category term="Controller" scheme="https://rainmakerho.github.io/tags/Controller/"/>
    
      <category term="lambda_method" scheme="https://rainmakerho.github.io/tags/lambda-method/"/>
    
  </entry>
  
</feed>
